<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯åŠ©æ‰‹ - è½»æ¾èƒŒå•è¯</title>
    <!-- ä»…ä¿ç•™ Tailwind CSSï¼Œè¿™æ˜¯æœ€å¯é çš„ UI åº“ -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link rel="stylesheet" href="è¯åº“ç®¡ç†.css">
</head>
<body class="min-h-screen text-slate-800 dark:text-slate-200 transition-colors duration-500 selection:bg-indigo-500 selection:text-white relative">
    <!-- Liquid Glass SVG Filter -->
    <svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
        <defs>
            <filter id="liquid-glass-filter" x="-35%" y="-35%" width="170%" height="170%" color-interpolation-filters="sRGB">
                <feImage id="feimage" x="0" y="0" width="100%" height="100%" result="DISPLACEMENT_MAP" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/2wCEAAQDAwMDAwQDAwQGBAMEBgcFBAQFBwgHBwcHBwgLCAkJCQkICwsMDAwMDAsNDQ4ODQ0SEhISEhQUFBQUFBQUFBQBBQUFCAgIEAsLEBQODg4UFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFP/CABEIAQABAAMBEQACEQEDEQH/xAAxAAEBAQEBAQAAAAAAAAAAAAADAgQIAQYBAQEBAQEBAQAAAAAAAAAAAAMCBAEACAf/2gAMAwEAAhADEAAAAPjPor6kOgOiKhKgKhKgOhKhOhKxKgKhOgKhKhKgKxOhKhOgKhKhKgKwKhKgKgKwG841nns9J/nn2KVCdCdCVAVCVCVAdCVCdiVAVidCVAVCVAdiVCVCdAVCVCVAVCVAVAViVZxsBrPPY6R/NvsY6E6ErEqAqE6ErAqE6E7E7ErA0ErArAqAqEuiVAXRLol0S6J0JUBWBUI0BXnG88djpH81+xjoToSoSoCoTsSoYQTsTsTQSsCsCsCsCsCoC6A0JeAuiXSLwn0SoioCoCoBsBrPFH0j+a/Yx0J0JUJUJ2BUMIR2MIRoBoJIBXnJAK840BUA0BdAegXhLpF4S8R+IuiVgVANAV546fSH5r9jHRHQFQlYxYnZQgnYwhQokgEgEmckzjecazlYD3OPQHoD0S8JcI/EXiPxF0SoSvONBFF0j+a/YxdI7EqA6KLGEKEKEGFI0AlA0AUzimYbzjecazjWce5w6BdEeCXhPhFwz8R+MuiVgVAdF0j+a/Yp0RUJ0MWUIUWUIUKUIJqBoArnJM4pmBMw3nCsw1mCs4+AegPBLxHwi4Z8KPGXSPojYH0ukfzX7FOiKhiyiylDiylDhBNRNQJAJcwpnBMopmC84XlCswdzj3OPQHwlwS8R8M+HHDPxl0ioDoukfzT7GOhOyiimzmzhDlShBNBNBJc4rmFMwJlBMwXlC82esoVmHucOgXgHxH4j4Zyccg/GfiOiKh6R/NPsY6GLOKObOUObOUI0KEAlEkzimYFygmUEyheXPeULzZ6yhWce5x8BeEuGfCj0HyI5EdM/EdD0h+a/Yx0U0cUflxNnNnCHCCdgSiSZgTMK5c6ZQvLnTLnvJnvKFZgrMHc5dAeiXijhn445E8g/RHTPpdI/mn2KdlFR5RzcTUTZxZwglYGgCmcEzAuUEyZ0y57yZ0yZ7yheUKzh3OPc5dEvEfij0RyI9E+iPGfT6T/NPsQ6OKiKmajy4ijmyOyKwNAFM4JlBMudMmdMue8mdMme8me8wVmGsw0A9A+kfjjxx6J9EememfT6W/MvsMqOamKiamKmKOKM7ErErAUzAmYLyZ0y50yZ0yZkyZ7yBeULzBeYazl0T6R9KPRPYj0T2J9B9Ppj8x+wjo4qY7M9iKmKg6MrIrErALzBeYEyZ0y50yZ0yZkyZ7x50yheXPeUbzjWcqA6I+lHYnsT6J7E9iOx0z+YfYBUc1MdmexHZjsHRlRBRDYBecEzZ7yAmXNeTOmTOmPOmXOmULyjeYbzlYnQxRx057E9mexPYij6a/L/r86OOzPpjsR6Y7B9MqIaILDPYZ7zZ0y57y50yZ0x5kyAmXPeUEyjeYUznQnYnRTUTUT2JqJ7EUfTn5d9fFRx2Z9EdmPTHjLsF0h6I2OegzXmzJmzplz3lzJjzpkBMudMoplBM5JnOwOyiimzmomomonsHRdO/l318VFHYj0x6I9McgumXiHpDQ56DPebMmbNebMmXMmQEy50yguQEzCmYkA7GLGEKaObibiaOKOKPp38s+vCsj7EeiPTHIP0Hwx6ReMKDP0M95895syZ815cy5c6ZQTKCZRXMKZiQDQYQYsps5uJs5qIsjounvyz68KyLpx4z9Mcg+GXoLxl4g6IUGes+a8+e82ZM2dMuZMoJmBcwrlJM5IBoMKMo" preserveAspectRatio="xMidYMid slice"/>

                <!-- Create edge mask using the displacement map itself -->
                <feColorMatrix in="DISPLACEMENT_MAP" type="matrix" values="0.3 0.3 0.3 0 0  0.3 0.3 0.3 0 0  0.3 0.3 0.3 0 0  0 0 0 1 0" result="EDGE_INTENSITY"/>
                <feComponentTransfer in="EDGE_INTENSITY" result="EDGE_MASK">
                    <feFuncA type="discrete" tableValues="0 0.1 1"/>
                </feComponentTransfer>

                <!-- Original undisplaced image for center -->
                <feOffset in="SourceGraphic" dx="0" dy="0" result="CENTER_ORIGINAL"/>

                <!-- Red channel displacement with slight offset -->
                <feDisplacementMap in="SourceGraphic" in2="DISPLACEMENT_MAP" scale="-25" xChannelSelector="R" yChannelSelector="B" result="RED_DISPLACED"/>
                <feColorMatrix in="RED_DISPLACED" type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="RED_CHANNEL"/>

                <!-- Green channel displacement -->
                <feDisplacementMap in="SourceGraphic" in2="DISPLACEMENT_MAP" scale="-27.5" xChannelSelector="R" yChannelSelector="B" result="GREEN_DISPLACED"/>
                <feColorMatrix in="GREEN_DISPLACED" type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="GREEN_CHANNEL"/>

                <!-- Blue channel displacement with slight offset -->
                <feDisplacementMap in="SourceGraphic" in2="DISPLACEMENT_MAP" scale="-30" xChannelSelector="R" yChannelSelector="B" result="BLUE_DISPLACED"/>
                <feColorMatrix in="BLUE_DISPLACED" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="BLUE_CHANNEL"/>

                <!-- Combine all channels with screen blend mode for chromatic aberration -->
                <feBlend in="GREEN_CHANNEL" in2="BLUE_CHANNEL" mode="screen" result="GB_COMBINED"/>
                <feBlend in="RED_CHANNEL" in2="GB_COMBINED" mode="screen" result="RGB_COMBINED"/>

                <!-- Add slight blur to soften the aberration effect -->
                <feGaussianBlur in="RGB_COMBINED" stdDeviation="0.3" result="ABERRATED_BLURRED"/>

                <!-- Apply edge mask to aberration effect -->
                <feComposite in="ABERRATED_BLURRED" in2="EDGE_MASK" operator="in" result="EDGE_ABERRATION"/>

                <!-- Create inverted mask for center -->
                <feComponentTransfer in="EDGE_MASK" result="INVERTED_MASK">
                    <feFuncA type="table" tableValues="1 0"/>
                </feComponentTransfer>
                <feComposite in="CENTER_ORIGINAL" in2="INVERTED_MASK" operator="in" result="CENTER_CLEAN"/>

                <!-- Combine edge aberration with clean center -->
                <feComposite in="EDGE_ABERRATION" in2="CENTER_CLEAN" operator="over"/>
            </filter>
        </defs>
    </svg>
    <div class="theme-toggle">
        <button onclick="toggleTheme()" class="p-3 rounded-full bg-white/80 dark:bg-slate-800/80 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all active:scale-95 backdrop-blur-sm group">
            <span id="theme-icon" class="text-xl block group-hover:rotate-12 transition-transform">ğŸŒ</span>
        </button>
    </div>
    <div class="w-full min-h-screen p-4 md:p-6 lg:p-8">
        <!-- å¤´éƒ¨ -->
        <header class="mb-12 animate-enter text-left" style="animation-delay: 0.1s">
            <div class="relative flex items-center justify-start mb-4 group hover-scale cursor-default w-20 h-20">
                <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full group-hover:opacity-30 transition-opacity"></div>
                <div class="relative w-20 h-20 rounded-3xl bg-gradient-to-br from-indigo-500/90 via-sky-500/90 to-purple-500/90 dark:from-indigo-500 dark:via-sky-500 dark:to-purple-500 backdrop-blur-xl shadow-xl border border-white/40 dark:border-slate-700/50 text-white flex items-center justify-center">
                    <svg class="w-9 h-9 drop-shadow-md" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold mb-1 tracking-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 dark:from-indigo-400 dark:via-purple-400 dark:to-blue-400">å•è¯åŠ©æ‰‹</span>
            </h1>
            <p id="user-greeting" class="greeting-text text-5xl md:text-6xl mb-2 text-indigo-500 dark:text-indigo-300"></p>
            <p class="text-slate-500 dark:text-slate-400 font-semibold text-base tracking-[0.2em] uppercase opacity-80 mb-4">Premium Vocabulary Builder</p>
            <p id="daily-quote" class="text-indigo-500 dark:text-indigo-400 font-bold text-xl transition-all duration-500">âœ¨ ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ âœ¨</p>
        </header>

        <!-- å¯¼èˆªæ  -->
        <nav class="flex flex-wrap justify-center gap-3 mb-10 animate-enter" style="animation-delay: 0.2s" id="nav">
            <button onclick="createRipple(event); switchMode('input')" id="btn-input" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base transition-all nav-active">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2"><span>âœ¨</span> å½•å…¥æ–°è¯</span>
            </button>
            <button onclick="createRipple(event); switchMode('list')" id="btn-list" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 transition-all">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2"><span>ğŸ“š</span> è¯åº“ (<span id="count">0</span>)</span>
            </button>
            <button onclick="createRipple(event); switchMode('test_select')" id="btn-test" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 transition-all">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2"><span>ğŸ§ </span> è®°å¿†æŒ‘æˆ˜</span>
            </button>
            <button onclick="createRipple(event); switchMode('daily_review')" id="btn-review" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 transition-all">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2"><span>ğŸ“†</span> æ¯æ—¥å¤ä¹ </span>
            </button>
            <button onclick="createRipple(event); openAuthModal('login')" id="btn-auth" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 transition-all hidden">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2">
                    <span>ğŸ‘¤</span>
                    ç™»å½•
                </span>
            </button>
            <button onclick="createRipple(event); switchMode('profile')" id="btn-profile" class="nav-pill group relative overflow-hidden flex items-center justify-center px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 transition-all">
                <span class="glass__warp absolute inset-0 z-0"></span>
                <span class="relative z-10 flex items-center gap-2">
                    <span>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A8 8 0 0112 14a8 8 0 016.879 3.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    æˆ‘çš„
                </span>
            </button>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main id="main-content" class="animate-enter bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-900/50 border border-slate-200 dark:border-slate-700 shadow-xl p-6 md:p-10 rounded-[2rem] min-h-[400px]" style="animation-delay: 0.3s">
            <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </main>
        
        <footer class="mt-16 text-center text-slate-400 dark:text-slate-600 text-xs font-medium animate-enter" style="animation-delay: 0.4s">
            <p>Â©  å•è¯åŠ©æ‰‹ Â·  åˆ¶ä½œäººcmchen</p>
        </footer>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="liquid-glass-modal absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-2xl md:mx-auto rounded-[2.5rem] shadow-2xl overflow-hidden transform transition-all scale-100 border border-white/20">
            <!-- Warp Layer for Liquid Glass Effect -->
            <span class="glass__warp absolute inset-0 z-0"></span>
            
            <!-- Content Layer -->
            <div class="relative z-10 p-8 h-full bg-white/40 dark:bg-slate-900/40 backdrop-blur-md">
                <button onclick="closeModal()" class="absolute top-6 right-6 p-2 rounded-full bg-slate-100/80 dark:bg-slate-800/80 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors z-20 shadow-sm">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                <div id="modal-content" class="max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <!-- Content injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="auth-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-md md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 id="auth-title" class="text-2xl font-black text-slate-900 dark:text-white mb-1">æ¬¢è¿å›æ¥</h2>
                    <p id="auth-subtitle" class="text-slate-500 dark:text-slate-400 text-sm font-medium">ç™»å½•ä½ çš„è´¦å·ç»§ç»­å­¦ä¹ </p>
                </div>
                <button onclick="closeAuthModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <form onsubmit="handleAuthSubmit(event)" class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">è´¦å·</label>
                    <input id="auth-account" type="text" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·è¾“å…¥ç™»å½•è´¦å·">
                </div>
                <div id="auth-name-group" class="space-y-2 hidden">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">æ˜µç§°</label>
                    <input id="auth-name" type="text" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æ˜µç§°">
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">å¯†ç </label>
                    <input id="auth-password" type="password" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div id="auth-confirm-password-group" class="space-y-2 hidden">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">ç¡®è®¤å¯†ç </label>
                    <input id="auth-confirm-password" type="password" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <button type="submit" class="button-soft w-full py-3 rounded-2xl bg-gradient-to-r from-indigo-600 via-purple-600 to-sky-500 text-white font-bold shadow-lg hover:shadow-xl">
                    ç¡®è®¤
                </button>
            </form>
            <button id="auth-toggle" type="button" onclick="toggleAuthMode()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ
            </button>
        </div>
    </div>
    
    <div id="guide-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-xl md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-2">æ¬¢è¿ä½¿ç”¨å•è¯åŠ©æ‰‹</h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-4">ç®€å•å‡ æ­¥ï¼Œå¿«é€Ÿä¸Šæ‰‹æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
            <ul class="text-sm text-slate-600 dark:text-slate-300 space-y-2 text-left">
                <li>1. åœ¨ã€Œå½•å…¥æ–°è¯ã€é‡Œè¾“å…¥è‹±æ–‡å•è¯ï¼šè‡ªåŠ¨è·å–é‡Šä¹‰ã€éŸ³æ ‡å’Œä¾‹å¥ã€‚</li>
                <li>2. åœ¨ã€Œè¯åº“ã€é‡Œæœç´¢ä¸æ’åºï¼šç‚¹å‡»å•è¯å¡ç‰‡æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚</li>
                <li>3. åœ¨è¯åº“é¡µé¢ç‚¹ã€Œå¯¼å…¥ã€ï¼šæ”¯æŒ Word æ–‡æ¡£å¯¼å…¥ã€‚</li>
                <li>4. åœ¨è¯åº“é¡µé¢ç‚¹ã€Œç®¡ç†ã€ï¼šå¯åˆ›å»º/åˆ‡æ¢è¯åº“ï¼Œå¹¶æ”¯æŒæŠŠå…¶å®ƒè¯åº“åˆå¹¶åˆ°å½“å‰è¯åº“ï¼ˆè‡ªåŠ¨å»é‡ï¼‰ã€‚</li>
                <li>5. è¿›å…¥ã€Œè®°å¿†æŒ‘æˆ˜ã€ä¸ã€Œæ¯æ—¥å¤ä¹ ã€ï¼šé”™é¢˜ä¼šè¢«ä¼˜å…ˆå®‰æ’å·©å›ºã€‚</li>
                <li>6. åœ¨ã€Œæˆ‘çš„ã€é‡Œï¼šç®¡ç†è´¦å·ä¿¡æ¯ä¸è¯åº“æ•°æ®ï¼ˆåŒ…å«æ¸…ç©ºè¯åº“ç­‰æ“ä½œï¼‰ã€‚</li>
            </ul>
            <button onclick="closeGuideModal()" class="button-soft w-full py-3 mt-2 rounded-2xl bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold shadow-lg hover:shadow-xl">
                æˆ‘çŸ¥é“äº†ï¼Œå¼€å§‹ä½¿ç”¨
            </button>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 z-[115] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeReviewModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-md md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-1">ä»Šæ—¥å¤ä¹ è®¡åˆ’</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">åšæŒä¸€ç‚¹ç‚¹ï¼Œæ¯å¤©éƒ½ä¼šæ›´å‰å®³</p>
                </div>
                <button onclick="closeReviewModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl p-4 text-sm text-slate-700 dark:text-slate-200">
                <p>ä»Šå¤©å»ºè®®å¤ä¹  <span id="review-total-count" class="font-bold text-indigo-600 dark:text-indigo-400">0</span> ä¸ªå•è¯ï¼Œå…¶ä¸­æ˜¨æ—¥é”™é¢˜ <span id="review-yesterday-count" class="font-bold text-rose-500">0</span> ä¸ªã€‚</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button onclick="startDailyReview('en-zh')" class="button-soft w-full py-3 rounded-2xl bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <span>è‹±è¯‘æ±‰å¤ä¹ </span>
                </button>
                <button onclick="startDailyReview('zh-en')" class="button-soft w-full py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold shadow-lg hover:shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center gap-2">
                    <span>æ±‰è¯‘è‹±å¤ä¹ </span>
                </button>
            </div>
            <button onclick="closeReviewModal()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                ç¨åå†è¯´
            </button>
        </div>
    </div>

    <div id="review-mode-modal" class="fixed inset-0 z-[116] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeReviewModeModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">é€‰æ‹©å¤ä¹ æ¨¡å¼</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æŒ‰ä½ çš„ä¹ æƒ¯é€‰æ‹©ä¸€ç§æ–¹å¼å¼€å§‹å¤ä¹ </p>
                </div>
                <button onclick="closeReviewModeModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="handleDailyReviewModeSelect('en-zh')" class="button-soft w-full py-3 rounded-2xl bg-slate-900 dark:bg-indigo-500 text-white font-bold shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <span>è‹±è¯‘æ±‰ Â· é€‰æ‹©é¢˜</span>
                </button>
                <button onclick="handleDailyReviewModeSelect('zh-en')" class="button-soft w-full py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold shadow-lg hover:shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center gap-2">
                    <span>æ±‰è¯‘è‹± Â· æ‹¼å†™é¢˜</span>
                </button>
            </div>
            <button onclick="closeReviewModeModal()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                å…ˆç­‰ç­‰ï¼Œå†å‡†å¤‡ä¸€ä¸‹
            </button>
        </div>
    </div>

    <div id="delete-account-modal" class="fixed inset-0 z-[117] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeDeleteAccountModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">åˆ é™¤è´¦å·</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æ­¤æ“ä½œä¼šåŒæ—¶æ¸…ç©ºè¯¥è´¦å·ä¸‹çš„è¯åº“å’Œè¿›åº¦</p>
                </div>
                <button onclick="closeDeleteAccountModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">ç¡®å®šè¦åˆ é™¤å½“å‰è´¦å·å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmDeleteAccount()" class="button-soft py-3 rounded-2xl bg-rose-600 text-white font-bold shadow-lg hover:bg-rose-700 hover:shadow-rose-500/40 text-sm">æ˜¯çš„ï¼Œåˆ é™¤</button>
                <button onclick="closeDeleteAccountModal()" class="button-soft py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold text-sm">å†æƒ³æƒ³</button>
            </div>
        </div>
    </div>

    <div id="clear-words-modal" class="fixed inset-0 z-[118] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeClearWordsModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">æ¸…ç©ºè¯åº“</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æ­¤æ“ä½œä¼šåˆ é™¤å½“å‰è´¦å·ä¸‹çš„æ‰€æœ‰å•è¯</p>
                </div>
                <button onclick="closeClearWordsModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">ç¡®å®šè¦ä¸€é”®æ¸…ç©ºè¯åº“å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmClearWords()" class="button-soft py-3 rounded-2xl bg-rose-600 text-white font-bold shadow-lg hover:bg-rose-700 hover:shadow-rose-500/40 text-sm">æ˜¯çš„ï¼Œæ¸…ç©º</button>
                <button onclick="closeClearWordsModal()" class="button-soft py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold text-sm">å†æƒ³æƒ³</button>
            </div>
        </div>
    </div>

    <div id="library-modal" class="fixed inset-0 z-[115] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeLibraryModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-lg md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6 max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between flex-shrink-0">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">è¯åº“ç®¡ç†</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">åˆ‡æ¢æˆ–åˆ›å»ºæ–°çš„å•è¯æœ¬</p>
                </div>
                <button onclick="closeLibraryModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-4 px-1">
                <!-- Library List -->
                <div id="library-list" class="space-y-3">
                    <!-- Injected via JS -->
                </div>
                
                <!-- Create New Section -->
                <div class="pt-4 border-t border-slate-100 dark:border-slate-800">
                     <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">æ–°å»ºè¯åº“</h3>
                     <div class="flex gap-2">
                         <input id="new-lib-name" type="text" placeholder="è¯åº“åç§°" class="premium-input flex-1 p-2 text-sm rounded-xl">
                         <button onclick="createNewLibrary()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/20 whitespace-nowrap">åˆ›å»º</button>
                     </div>
                </div>

            </div>
        </div>
    </div>



    <script>
        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleBodyScroll(lock) {
            if (lock) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }

        // --- ä¸»é¢˜ç®¡ç† ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const btn = document.getElementById('theme-icon');
            if (btn) {
                const isDark = document.documentElement.classList.contains('dark');
                btn.innerText = isDark ? 'ğŸŒ™' : 'ğŸŒ';
            }
        }
        
        // ç«‹å³åˆå§‹åŒ–
        initTheme();

        // --- çŠ¶æ€ç®¡ç† ---
        let users = [];
        let currentUser = null;
        let libraries = [];
        let currentLibraryId = 'default';
        let words = [];
        let currentMode = 'input';
        let testMode = 'en-zh';
        let currentIndex = 0;
        let showAnswer = false;
        let hintLevel = 0;
        let testSession = [];
        let wrongAttempts = [];
        let isPracticeMode = false;
        let currentOptions = [];
        let isLoadingOptions = false;
        let tempWordData = null;
        let authMode = 'login';
        let reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
        let isReviewMode = false;
        // Search & Sort State
        let searchQuery = '';
        let sortOrder = 'date_desc'; // date_desc, date_asc, alpha_asc, alpha_desc
        let listRenderLimit = 80;
        
        function getLibrariesStorageKey() {
            if (currentUser && currentUser.id) {
                return 'danci_libraries_' + currentUser.id;
            }
            return 'danci_libraries_guest';
        }

        function getCurrentLibraryIdStorageKey() {
            if (currentUser && currentUser.id) {
                return 'danci_current_library_id_' + currentUser.id;
            }
            return 'danci_current_library_id_guest';
        }

        function getWordsStorageKey() {
            const userId = (currentUser && currentUser.id) ? currentUser.id : 'guest';
            const libId = currentLibraryId || 'default';
            return `danci_words_${userId}_${libId}`;
        }

        function getWordsStorageKeyForLibrary(libId) {
            const userId = (currentUser && currentUser.id) ? currentUser.id : 'guest';
            const id = libId || 'default';
            return `danci_words_${userId}_${id}`;
        }

        function getLibraryWordCount(libId) {
            try {
                const stored = localStorage.getItem(getWordsStorageKeyForLibrary(libId));
                const arr = stored ? JSON.parse(stored) : [];
                return Array.isArray(arr) ? arr.length : 0;
            } catch (e) {
                return 0;
            }
        }

        function refreshLibraryCounts() {
            libraries.forEach(l => {
                l.count = getLibraryWordCount(l.id);
            });
        }
        
        function getTestProgressKey() {
            if (currentUser && currentUser.id) {
                return 'danci_test_progress_' + currentUser.id;
            }
            return 'danci_test_progress_guest';
        }

        function getReviewSettingsKey() {
            if (currentUser && currentUser.id) {
                return 'danci_review_settings_' + currentUser.id;
            }
            return 'danci_review_settings_guest';
        }

        function loadReviewSettingsForCurrentUser() {
            try {
                const stored = localStorage.getItem(getReviewSettingsKey());
                reviewSettings = stored ? JSON.parse(stored) : { dailyTarget: 20, lastReviewDate: '' };
            } catch (e) {
                reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
            }
        }

        function saveReviewSettings() {
            localStorage.setItem(getReviewSettingsKey(), JSON.stringify(reviewSettings));
        }

        function getTodayDateStr() {
            const d = new Date();
            return d.toISOString().slice(0, 10);
        }

        function getYesterdayDateStr() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return d.toISOString().slice(0, 10);
        }
        
        function loadWordsForCurrentUser() {
            const key = getWordsStorageKey();
            try {
                const stored = localStorage.getItem(key);
                words = stored ? JSON.parse(stored) : [];
            } catch (e) {
                words = [];
            }
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
        }
        
        function saveWords() {
            const key = getWordsStorageKey();
            localStorage.setItem(key, JSON.stringify(words));
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
            
            // Update library count
            const lib = libraries.find(l => l.id === currentLibraryId);
            if (lib) {
                lib.count = words.length;
                saveLibraries();
            }
        }

        // --- Library Management ---
        function loadLibrariesForCurrentUser() {
            const key = getLibrariesStorageKey();
            const stored = localStorage.getItem(key);
            libraries = stored ? JSON.parse(stored) : [];
            
            const currentIdKey = getCurrentLibraryIdStorageKey();
            currentLibraryId = localStorage.getItem(currentIdKey) || 'default';

            // Migration / Init
            if (libraries.length === 0) {
                // Create default library
                libraries.push({ id: 'default', name: 'é»˜è®¤è¯åº“', description: 'æˆ‘çš„ä¸»å•è¯æœ¬', count: 0, created: Date.now() });
                saveLibraries();
                
                // Migrate old data if exists
                const userId = (currentUser && currentUser.id) ? currentUser.id : 'guest';
                const oldKey = `danci_words_${userId}`;
                const newKey = `danci_words_${userId}_default`;
                
                const oldData = localStorage.getItem(oldKey);
                if (oldData && !localStorage.getItem(newKey)) {
                    localStorage.setItem(newKey, oldData);
                }
            }
            
            // Ensure current library exists
            if (!libraries.find(l => l.id === currentLibraryId)) {
                currentLibraryId = libraries[0].id;
                localStorage.setItem(currentIdKey, currentLibraryId);
            }

            refreshLibraryCounts();
            localStorage.setItem(key, JSON.stringify(libraries));
        }

        function saveLibraries() {
            const key = getLibrariesStorageKey();
            localStorage.setItem(key, JSON.stringify(libraries));
            renderLibraryList();
        }

        function switchLibrary(id) {
            if (currentLibraryId === id) return;
            currentLibraryId = id;
            localStorage.setItem(getCurrentLibraryIdStorageKey(), id);
            
            loadWordsForCurrentUser();
            render();
            closeLibraryModal();
            
            // Show toast or message
            const lib = libraries.find(l => l.id === id);
            if (lib) alert(`å·²åˆ‡æ¢åˆ°è¯åº“ï¼š${lib.name}`);
        }

        function createNewLibrary() {
            const nameInput = document.getElementById('new-lib-name');
            const name = nameInput.value.trim();
            if (!name) return alert('è¯·è¾“å…¥è¯åº“åç§°');
            
            const newId = Date.now().toString();
            libraries.push({
                id: newId,
                name: name,
                description: 'è‡ªå®šä¹‰è¯åº“',
                count: 0,
                created: Date.now()
            });
            
            saveLibraries();
            nameInput.value = '';
            
            if (confirm(`è¯åº“ "${name}" åˆ›å»ºæˆåŠŸï¼Œæ˜¯å¦ç«‹å³åˆ‡æ¢ï¼Ÿ`)) {
                switchLibrary(newId);
            }
        }
        
        function deleteLibrary(id) {
            if (libraries.length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè¯åº“');
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯åº“å—ï¼Ÿåˆ é™¤åå•è¯å°†æ— æ³•æ¢å¤ã€‚')) return;
            
            const index = libraries.findIndex(l => l.id === id);
            if (index > -1) {
                libraries.splice(index, 1);
                saveLibraries();
                
                // Remove data
                const userId = (currentUser && currentUser.id) ? currentUser.id : 'guest';
                localStorage.removeItem(`danci_words_${userId}_${id}`);
                
                if (currentLibraryId === id) {
                    switchLibrary(libraries[0].id);
                }
            }
        }

        function openLibraryModal() {
            renderLibraryList();
            const modal = document.getElementById('library-modal');
            modal.classList.remove('hidden');
            toggleBodyScroll(true);
        }

        function closeLibraryModal() {
            const modal = document.getElementById('library-modal');
            modal.classList.add('hidden');
            toggleBodyScroll(false);
        }



        function renderLibraryList() {
            const container = document.getElementById('library-list');
            if (!container) return;
            
            let html = '';
            libraries.forEach(lib => {
                const isActive = lib.id === currentLibraryId;
                html += `
                    <div class="flex items-center justify-between p-4 rounded-2xl border transition-all ${isActive ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-slate-200 dark:hover:border-slate-600'}">
                        <div class="flex-1 cursor-pointer" onclick="switchLibrary('${lib.id}')">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-slate-800 dark:text-slate-100">${lib.name}</span>
                                ${isActive ? '<span class="px-2 py-0.5 rounded-md bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 text-[10px] font-bold">å½“å‰ä½¿ç”¨</span>' : ''}
                            </div>
                            <div class="text-xs text-slate-400 flex gap-3">
                                <span>${getLibraryWordCount(lib.id)} å•è¯</span>
                                <span>${lib.description || ''}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                        ${!isActive && libraries.length > 1 ? `
                        <button onclick="mergeLibrary('${lib.id}', '${currentLibraryId}')" class="px-3 py-1.5 rounded-xl text-xs font-bold border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all" title="åˆå¹¶åˆ°å½“å‰è¯åº“">åˆå¹¶</button>` : ''}
                        ${libraries.length > 1 ? `
                        <button onclick="deleteLibrary('${lib.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors" title="åˆ é™¤è¯åº“">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function mergeLibrary(sourceId, targetId) {
            if (!sourceId || !targetId || sourceId === targetId) return;

            const sourceLib = libraries.find(l => l.id === sourceId);
            const targetLib = libraries.find(l => l.id === targetId);
            if (!sourceLib || !targetLib) return;

            if (!confirm(`å°†æŠŠã€Œ${sourceLib.name}ã€åˆå¹¶åˆ°ã€Œ${targetLib.name}ã€ã€‚\nåˆå¹¶ä¼šå»é‡å¹¶åˆ é™¤æ¥æºè¯åº“ã€‚\nç¡®å®šç»§ç»­å—ï¼Ÿ`)) return;

            const sourceKey = getWordsStorageKeyForLibrary(sourceId);
            const targetKey = getWordsStorageKeyForLibrary(targetId);

            let sourceWords = [];
            let targetWords = [];
            try {
                const s = localStorage.getItem(sourceKey);
                const t = localStorage.getItem(targetKey);
                sourceWords = s ? JSON.parse(s) : [];
                targetWords = t ? JSON.parse(t) : [];
            } catch (e) {
                alert('åˆå¹¶å¤±è´¥ï¼šè¯åº“æ•°æ®æŸå');
                return;
            }

            if (!Array.isArray(sourceWords)) sourceWords = [];
            if (!Array.isArray(targetWords)) targetWords = [];

            const seen = new Set();
            targetWords.forEach(w => {
                const en = (w && w.english) ? String(w.english).trim().toLowerCase() : '';
                if (en) seen.add(en);
            });

            let nextId = Date.now();
            let added = 0;
            for (const w of sourceWords) {
                const en = (w && w.english) ? String(w.english).trim() : '';
                if (!en) continue;
                const key = en.toLowerCase();
                if (seen.has(key)) continue;
                seen.add(key);
                const copy = Object.assign({}, w, { id: nextId++ });
                targetWords.push(copy);
                added++;
            }

            localStorage.setItem(targetKey, JSON.stringify(targetWords));
            localStorage.removeItem(sourceKey);

            const idx = libraries.findIndex(l => l.id === sourceId);
            if (idx !== -1) libraries.splice(idx, 1);
            refreshLibraryCounts();
            saveLibraries();

            if (currentLibraryId === sourceId) {
                currentLibraryId = targetId;
                localStorage.setItem(getCurrentLibraryIdStorageKey(), targetId);
            }

            if (currentLibraryId === targetId) {
                words = targetWords;
                const countEl = document.getElementById('count');
                if (countEl) countEl.innerText = words.length;
            } else {
                loadWordsForCurrentUser();
            }

            render();
            alert(`åˆå¹¶å®Œæˆï¼šæ–°å¢ ${added} ä¸ªå•è¯ï¼Œå½“å‰è¯åº“å…± ${targetWords.length} ä¸ªã€‚`);
        }
        






        function getYesterdayWrongWords() {
            const y = getYesterdayDateStr();
            return words.filter(w => w.lastWrongAt === y);
        }
        
        function updateGreeting() {
            const el = document.getElementById('user-greeting');
            if (!el) return;
            if (currentUser) {
                const name = currentUser.name || currentUser.account;
                el.textContent = `ä½ å¥½ï¼Œ${name}`;
                el.style.display = 'block';
            } else {
                el.textContent = '';
                el.style.display = 'none';
            }
        }
        
        // --- é¼“åŠ±è¯­ ---
        const quotes = [
            "ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ã€‚",
            "åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚",
            "ä¸è¦çœ‹ç€é’Ÿè¡¨ï¼Œåƒå®ƒä¸€æ ·ï¼ŒåšæŒå‘å‰ã€‚",
            "æˆåŠŸæ˜¯æ¯å¤©é‡å¤çš„å°å°åŠªåŠ›çš„æ€»å’Œã€‚",
            "é™åˆ¶ä½ çš„åªæœ‰ä½ çš„æƒ³è±¡åŠ›ã€‚",
            "ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜¯æ˜å¤©æˆåŠŸçš„åŸºçŸ³",
            "ä¼Ÿå¤§çš„äº‹ç‰©ä»æœªè¯ç”Ÿäºèˆ’é€‚åœˆã€‚",
            "æœ‰æ¢¦æƒ³ï¼Œå°±å»è¿½ï¼Œå»å®ç°ã€‚",
            "æˆåŠŸä¸ä¼šä¸»åŠ¨æ‰¾ä½ ï¼Œä½ å¾—å»å¯»æ‰¾å®ƒã€‚",
            "è¶ŠåŠªåŠ›ï¼Œè¶Šå¹¸è¿ã€‚"
        ];

        function updateQuote() {
            const quoteEl = document.getElementById('daily-quote');
            if (quoteEl) {
                // ç®€å•çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ
                quoteEl.style.opacity = 0;
                setTimeout(() => {
                    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                    quoteEl.innerText = `âœ¨ ${randomQuote} âœ¨`;
                    quoteEl.style.opacity = 1;
                }, 200);
            }
        }

        // --- è¿›åº¦ä¿å­˜é€»è¾‘ ---
        function saveTestProgress() {
            const progress = {
                testSession,
                currentIndex,
                wrongAttempts,
                testMode,
                isPracticeMode,
                timestamp: Date.now()
            };
            localStorage.setItem(getTestProgressKey(), JSON.stringify(progress));
        }

        function loadTestProgress() {
            try {
                const saved = localStorage.getItem(getTestProgressKey());
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                return null;
            }
        }

        function clearTestProgress() {
            localStorage.removeItem(getTestProgressKey());
        }

        function handleInterruptTest() {
            if (currentMode === 'test' && currentIndex < testSession.length) {
                saveTestProgress();
            }
            switchMode('test_select');
        }
        
        function handleResumeTest() {
            const progress = loadTestProgress();
            if (progress) {
                testSession = progress.testSession;
                currentIndex = progress.currentIndex;
                wrongAttempts = progress.wrongAttempts;
                testMode = progress.testMode;
                isPracticeMode = progress.isPracticeMode;
                currentMode = 'test';
                hintLevel = 0;
                prepareQuestion();
            }
        }
        
        function setCurrentUser(user) {
            currentUser = user;
            if (user && user.id) {
                localStorage.setItem('danci_current_user_id', String(user.id));
                const btnAuth = document.getElementById('btn-auth');
                const btnProfile = document.getElementById('btn-profile');
                if (btnAuth) btnAuth.classList.add('hidden');
                if (btnProfile) btnProfile.classList.remove('hidden');
            } else {
                localStorage.removeItem('danci_current_user_id');
                const btnAuth = document.getElementById('btn-auth');
                const btnProfile = document.getElementById('btn-profile');
                if (btnAuth) btnAuth.classList.remove('hidden');
                if (btnProfile) btnProfile.classList.add('hidden');
            }
            loadLibrariesForCurrentUser();
            loadWordsForCurrentUser();
            updateGreeting();
            loadReviewSettingsForCurrentUser();
        }
        
        function toggleBodyScroll(lock) {
            if (lock) {
                document.body.classList.add('no-scroll');
            } else {
                document.body.classList.remove('no-scroll');
            }
        }

        function openAuthModal(mode) {
            authMode = mode;
            const modal = document.getElementById('auth-modal');
            if (!modal) return;
            const titleEl = document.getElementById('auth-title');
            const subtitleEl = document.getElementById('auth-subtitle');
            const nameGroup = document.getElementById('auth-name-group');
            const toggleEl = document.getElementById('auth-toggle');
            const confirmGroup = document.getElementById('auth-confirm-password-group');
            
            if (mode === 'register') {
                if (titleEl) titleEl.textContent = 'æ¬¢è¿åŠ å…¥å•è¯åŠ©æ‰‹';
                if (subtitleEl) subtitleEl.textContent = 'åˆ›å»ºä½ çš„è´¦å·ï¼Œå¼€å§‹ä¸“å±è®°å¿†ä¹‹æ—…';
                if (nameGroup) nameGroup.classList.remove('hidden');
                if (confirmGroup) confirmGroup.classList.remove('hidden');
                if (toggleEl) toggleEl.textContent = 'å·²æœ‰è´¦å·ï¼Ÿå‰å¾€ç™»å½•';
            } else {
                if (titleEl) titleEl.textContent = 'æ¬¢è¿å›æ¥';
                if (subtitleEl) subtitleEl.textContent = 'ç™»å½•ä½ çš„è´¦å·ç»§ç»­å­¦ä¹ ';
                if (nameGroup) nameGroup.classList.add('hidden');
                if (confirmGroup) confirmGroup.classList.add('hidden');
                if (toggleEl) toggleEl.textContent = 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ';
            }
            modal.classList.remove('hidden');
            toggleBodyScroll(true);
        }
        
        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) modal.classList.add('hidden');
            toggleBodyScroll(false);
        }
        
        function toggleAuthMode() {
            const nextMode = authMode === 'login' ? 'register' : 'login';
            openAuthModal(nextMode);
        }
        
        function handleAuthSubmit(e) {
            if (e) e.preventDefault();
            const accountInput = document.getElementById('auth-account');
            const nameInput = document.getElementById('auth-name');
            const passwordInput = document.getElementById('auth-password');
            const confirmInput = document.getElementById('auth-confirm-password');
            
            if (!accountInput || !passwordInput) return;
            
            const account = accountInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!account || !password) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„è´¦å·å’Œå¯†ç ');
                return;
            }
            
            if (authMode === 'register') {
                const displayName = nameInput ? nameInput.value.trim() : '';
                const confirmPwd = confirmInput ? confirmInput.value.trim() : '';
                if (!displayName) {
                    alert('è¯·å¡«å†™æ˜µç§°');
                    return;
                }
                if (!confirmPwd || confirmPwd !== password) {
                    alert('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
                    return;
                }
                const exists = users.find(u => u.account === account);
                if (exists) {
                    alert('è¯¥è´¦å·å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•');
                    openAuthModal('login');
                    return;
                }
                const newUser = {
                    id: Date.now(),
                    account,
                    name: displayName,
                    password
                };
                users.push(newUser);
                localStorage.setItem('danci_users', JSON.stringify(users));
                setCurrentUser(newUser);
                closeAuthModal();
                showGuideForCurrentUser();
            } else {
                const user = users.find(u => u.account === account && u.password === password);
                if (!user) {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
                    return;
                }
                setCurrentUser(user);
                closeAuthModal();
                const guideKey = 'danci_user_guide_seen_' + user.id;
                const seen = localStorage.getItem(guideKey);
                if (!seen) {
                    showGuideForCurrentUser();
                }
            }
            
            accountInput.value = '';
            if (nameInput) nameInput.value = '';
            passwordInput.value = '';
            if (confirmInput) confirmInput.value = '';
            saveWords();
            render();
        }
        
        function handleLogout() {
            setCurrentUser(null);
            words = [];
            saveWords();
            render();
            if (users.length === 0) {
                openAuthModal('register');
            } else {
                openAuthModal('login');
            }
        }
        
        function showGuideForCurrentUser() {
            if (!currentUser || !currentUser.id) return;
            const key = 'danci_user_guide_seen_' + currentUser.id;
            localStorage.setItem(key, '1');
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.classList.remove('hidden');
                toggleBodyScroll(true);
            }
        }
        
        function closeGuideModal() {
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.classList.add('hidden');
                toggleBodyScroll(false);
            }
        }
        
        function initAuth() {
            try {
                users = JSON.parse(localStorage.getItem('danci_users') || '[]');
            } catch (e) {
                users = [];
            }
            const savedId = localStorage.getItem('danci_current_user_id');
            if (savedId) {
                const user = users.find(u => String(u.id) === savedId);
                if (user) {
                    currentUser = user;
                }
            }
            if (!currentUser && users.length > 0) {
                openAuthModal('login');
            }
            if (!currentUser && users.length === 0) {
                openAuthModal('register');
            }
            loadLibrariesForCurrentUser();
            loadWordsForCurrentUser();
            updateGreeting();
            if (currentUser) {
                loadReviewSettingsForCurrentUser();
                setTimeout(() => {
                    maybeShowReviewModal();
                }, 800);
            }
        }

        // --- Word Export ---
        function openExportModal() {
            const modal = document.getElementById('export-modal');
            const listContainer = document.getElementById('export-word-list');
            
            // Populate list
            let html = '';
            // Use current display logic (or just all words? let's use all words for export usually, but user might want filtered. 
            // Let's stick to ALL words for now as per requirement "Select which words", implying manual selection from full set)
            words.forEach(word => {
                html += `
                    <label class="flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer border border-transparent hover:border-slate-100 dark:hover:border-slate-700 transition-all">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <input type="checkbox" name="export-word" value="${word.id}" checked class="w-5 h-5 rounded-md border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            <div class="truncate">
                                <span class="font-bold text-slate-700 dark:text-slate-200">${word.english}</span>
                                <span class="text-xs text-slate-400 ml-2 truncate">${word.chinese ? word.chinese.substring(0, 20) : ''}...</span>
                            </div>
                        </div>
                    </label>
                `;
            });
            listContainer.innerHTML = html;
            
            // Reset options to default
            document.querySelectorAll('input[name="export-option"]').forEach(cb => cb.checked = true);
            document.getElementById('export-select-all').checked = true;
            
            modal.classList.remove('hidden');
            toggleBodyScroll(true);
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
            toggleBodyScroll(false);
        }

        function toggleExportSelectAll() {
            const selectAll = document.getElementById('export-select-all');
            const checkboxes = document.querySelectorAll('input[name="export-word"]');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function confirmExport() {
            const selectedWordIds = Array.from(document.querySelectorAll('input[name="export-word"]:checked')).map(cb => Number(cb.value));
            
            if (selectedWordIds.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•è¯');
                return;
            }

            const options = {
                phonetic: document.getElementById('opt-phonetic').checked,
                definition: document.getElementById('opt-definition').checked,
                examples: document.getElementById('opt-examples').checked,
                collocations: document.getElementById('opt-collocations').checked,
                idioms: document.getElementById('opt-idioms').checked
            };

            exportToWord(selectedWordIds, options);
            closeExportModal();
        }

        function exportToWord(wordIds = null, options = null) {
            let targetWords = words;
            
            if (wordIds) {
                const idSet = new Set(wordIds);
                targetWords = words.filter(w => idSet.has(w.id));
            }

            if (targetWords.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å•è¯');
                return;
            }
            
            // Default options if not provided
            if (!options) {
                options = { phonetic: true, definition: true, examples: true, collocations: true, idioms: true };
            }

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <title>å•è¯å¯¼å‡º</title>
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    .word-entry { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
                    .word { font-size: 24px; font-weight: bold; color: #2c3e50; }
                    .phonetic { color: #7f8c8d; font-family: 'Arial', sans-serif; margin-left: 10px; }
                    .section-title { font-size: 14px; font-weight: bold; color: #95a5a6; margin-top: 10px; text-transform: uppercase; }
                    .definition { margin-top: 5px; color: #34495e; line-height: 1.4; }
                    .example { margin-top: 5px; font-style: italic; color: #7f8c8d; border-left: 2px solid #3498db; padding-left: 10px; }
                    .collocation { display: inline-block; background: #ecf0f1; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 12px; color: #2c3e50; }
                    .idiom { margin-top: 4px; color: #d35400; }
                </style>
            </head>
            <body>
                <h1>æˆ‘çš„å•è¯æœ¬ (${new Date().toLocaleDateString()})</h1>
            `;

            targetWords.forEach(word => {
                let details = '';
                
                // Definitions
                if (options.definition) {
                    if (word.definitions && word.definitions.length > 0) {
                        word.definitions.forEach(d => {
                            details += `<div class="definition"><strong>[${d.pos}]</strong> ${d.def}</div>`;
                        });
                    } else {
                        details += `<div class="definition">${word.chinese.replace(/\n/g, '<br>')}</div>`;
                    }
                }

                // Examples
                if (options.examples && word.examples && word.examples.length > 0) {
                    details += `<div class="section-title">Examples</div>`;
                    word.examples.forEach(ex => {
                        details += `<div class="example">${ex.en}<br>${ex.cn}</div>`;
                    });
                }

                // Collocations
                if (options.collocations && word.collocations && word.collocations.length > 0) {
                    details += `<div class="section-title">Collocations</div><div>`;
                    word.collocations.forEach(c => {
                        details += `<span class="collocation">${c}</span>`;
                    });
                    details += `</div>`;
                }

                // Idioms
                if (options.idioms && word.idioms && word.idioms.length > 0) {
                    details += `<div class="section-title">Idioms & Slang</div>`;
                    word.idioms.forEach(i => {
                        details += `<div class="idiom">${i}</div>`;
                    });
                }

                htmlContent += `
                <div class="word-entry">
                    <div class="word">${word.english} ${options.phonetic && word.phonetic_us ? `<span class="phonetic">/${word.phonetic_us}/</span>` : ''}</div>
                    ${details}
                </div>`;
            });

            htmlContent += '</body></html>';

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å•è¯æœ¬_${new Date().toLocaleDateString()}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleWordImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Check for ZIP signature (PK..) -> .docx
                if (uint8Array[0] === 0x50 && uint8Array[1] === 0x4B) {
                    mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                        .then(result => {
                            parseAndImportWords(result.value);
                        })
                        .catch(err => {
                            console.error(err);
                            alert("è§£æ .docx æ–‡ä»¶å¤±è´¥ã€‚");
                        });
                } else {
                    // Try to read as text (HTML-based .doc from our export)
                    const textDecoder = new TextDecoder('utf-8');
                    const text = textDecoder.decode(arrayBuffer);
                    
                    if (text.trim().startsWith('<html') || text.includes('<html')) {
                        parseAndImportWords(text);
                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·ä½¿ç”¨ .docx æ–‡ä»¶æˆ–æœ¬åº”ç”¨å¯¼å‡ºçš„ .doc æ–‡ä»¶ã€‚");
                    }
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function parseAndImportWords(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            let newWords = [];
            
            // Strategy 1: Standard Export Format (.word-entry)
            const entries = tempDiv.querySelectorAll('.word-entry');
            if (entries.length > 0) {
                entries.forEach(entry => {
                    const wordEl = entry.querySelector('.word');
                    if (wordEl) {
                        // Handle phonetic inside word element
                        const wordClone = wordEl.cloneNode(true);
                        const phoSpan = wordClone.querySelector('.phonetic');
                        let phonetic = '';
                        if (phoSpan) {
                            phonetic = phoSpan.innerText.replace(/^\/|\/$/g, '').trim();
                            phoSpan.remove();
                        }
                        const english = wordClone.innerText.trim();
                        if (!english) return;

                        // Collect definitions
                        const definitions = [];
                        entry.querySelectorAll('.definition').forEach(el => definitions.push(el.innerText));
                        const chinese = definitions.join('\n');
                        
                        // Collect examples
                        const examples = [];
                        entry.querySelectorAll('.example').forEach(el => {
                            const parts = el.innerText.split('\n');
                            examples.push({ en: parts[0] || '', cn: parts.slice(1).join('\n') || '' });
                        });
                        
                        // Collect collocations & idioms
                        const collocations = [];
                        entry.querySelectorAll('.collocation').forEach(el => collocations.push(el.innerText));
                        
                        const idioms = [];
                        entry.querySelectorAll('.idiom').forEach(el => idioms.push(el.innerText));

                        newWords.push({
                            id: Date.now() + Math.random(),
                            english: english,
                            chinese: chinese,
                            phonetic_us: phonetic,
                            examples: examples,
                            collocations: collocations,
                            idioms: idioms,
                            wrongCount: 0
                        });
                    }
                });
            }

            // Strategy 2: Smart Text Parsing (Fallback for Mammoth/Text)
            if (newWords.length === 0) {
                const rawLines = tempDiv.innerText.split('\n').filter(l => l.trim());
                let currentWord = null;
                
                const parseLine = (text) => {
                    if (!text) return null;
                    text = text.trim();
                    // 1. Phonetic: Word [phonetic] ... or Word /phonetic/ ...
                    const phoneticMatch = text.match(/^([a-zA-Z\s\-']+?)\s*(\[.*?\]|\/.*?\/)(.*)$/);
                    if (phoneticMatch) {
                        return { 
                            english: phoneticMatch[1].trim(), 
                            phonetic: phoneticMatch[2].replace(/^[\/\[]|[\/\]]$/g, ''), 
                            definition: phoneticMatch[3].trim() 
                        };
                    }
                    // 2. Word + Def (Separated by multiple spaces or single space + Chinese)
                    // Heuristic: If we see a space followed by non-English or a long gap
                    const simpleMatch = text.match(/^([a-zA-Z\s\-']+?)\s+(.+)$/);
                    if (simpleMatch) {
                        return { 
                            english: simpleMatch[1].trim(), 
                            phonetic: '', 
                            definition: simpleMatch[2].trim() 
                        };
                    }
                    // 3. Just Word (Short pure English)
                    if (/^[a-zA-Z\s\-']+$/.test(text) && text.length < 50) {
                        return { english: text, phonetic: '', definition: '' };
                    }
                    return null;
                };

                rawLines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    // Check for example markers first
                    if (line.match(/^(ex[:\s]|example|e\.g\.|ä¾‹)/i)) {
                        if (currentWord) {
                            currentWord.examples.push({ en: line, cn: '' });
                        }
                        return;
                    }

                    const parsed = parseLine(line);
                    let isNewWord = false;

                    if (parsed) {
                        if (parsed.phonetic || parsed.definition) {
                            isNewWord = true;
                        } else {
                            // Just Word case
                            // Treat as new word if we don't have one, or the current one already has content
                            if (!currentWord || currentWord.chinese || currentWord.examples.length > 0) {
                                isNewWord = true;
                            }
                        }
                    }

                    if (isNewWord) {
                        if (currentWord) newWords.push(currentWord);
                        currentWord = {
                            id: Date.now() + Math.random(),
                            english: parsed.english,
                            chinese: parsed.definition || '',
                            phonetic_us: parsed.phonetic || '',
                            examples: [],
                            collocations: [],
                            idioms: [],
                            wrongCount: 0
                        };
                    } else if (currentWord) {
                        // Append to definition
                        if (currentWord.chinese) currentWord.chinese += '\n';
                        currentWord.chinese += line;
                    }
                });
                
                if (currentWord) newWords.push(currentWord);
            }

            if (newWords.length === 0) {
                alert("æœªèƒ½ä»æ–‡æ¡£ä¸­è¯†åˆ«å‡ºæœ‰æ•ˆçš„å•è¯ã€‚è¯·ç¡®ä¿æ ¼å¼ä¸ºï¼šå•è¯ [éŸ³æ ‡] è§£é‡Š");
                return;
            }

            // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„å•è¯
            const existingEn = new Set(words.map(w => w.english.toLowerCase()));
            const toAdd = newWords.filter(w => !existingEn.has(w.english.toLowerCase()));
            const duplicateCount = newWords.length - toAdd.length;

            if (toAdd.length === 0) {
                alert(`è¯†åˆ«åˆ° ${newWords.length} ä¸ªå•è¯ï¼Œä½†å…¨éƒ¨å·²å­˜åœ¨äºè¯åº“ä¸­ã€‚`);
                return;
            }

            if (confirm(`ä»æ–‡æ¡£ä¸­è¯†åˆ«åˆ° ${newWords.length} ä¸ªå•è¯ã€‚\nå…¶ä¸­ ${toAdd.length} ä¸ªæ–°å•è¯å°†è¢«å¯¼å…¥${duplicateCount > 0 ? `ï¼Œ${duplicateCount} ä¸ªé‡å¤å•è¯å·²è·³è¿‡` : ''}ã€‚\nç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ`)) {
                words = [...words, ...toAdd];
                saveWords();
                render();
                alert(`æˆåŠŸå¯¼å…¥ ${toAdd.length} ä¸ªå•è¯ï¼`);
            }
        }

        // --- Core Logic ---
        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            toggleBodyScroll(false);
        }

        function showWordDetails(id) {
            const word = words.find(w => w.id === id);
            if (!word) return;
            
            // æ„å»ºå†…å®¹
            let detailsHtml = '';

            // 1. é‡Šä¹‰ (å¦‚æœæœ‰ç»“æ„åŒ–æ•°æ®)
            if (word.definitions && word.definitions.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Definitions</h3><div class="space-y-3">`;
                word.definitions.forEach(d => {
                    detailsHtml += `<div class="flex gap-3"><span class="px-2 py-0.5 rounded-md bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold text-xs h-fit whitespace-nowrap">${d.pos}</span><span class="text-slate-700 dark:text-slate-300 font-medium">${d.def}</span></div>`;
                });
                detailsHtml += `</div></div>`;
            } else {
                // æ—§æ•°æ®å›é€€
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Meaning</h3><div class="text-lg leading-relaxed whitespace-pre-line font-medium text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">${word.chinese}</div></div>`;
            }

            // 2. ä¾‹å¥
            if (word.examples && word.examples.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Examples</h3><div class="space-y-4">`;
                word.examples.forEach(ex => {
                    detailsHtml += `<div class="pl-4 border-l-2 border-indigo-200 dark:border-indigo-900"><div class="text-slate-800 dark:text-slate-200 font-medium mb-1">${ex.en}</div><div class="text-slate-500 dark:text-slate-400 text-sm">${ex.cn}</div></div>`;
                });
                detailsHtml += `</div></div>`;
            }

            // 3. å›ºå®šæ­é…
            if (word.collocations && word.collocations.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Collocations</h3><div class="flex flex-wrap gap-2">`;
                word.collocations.forEach(c => {
                    detailsHtml += `<span class="px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-medium text-sm">${c}</span>`;
                });
                detailsHtml += `</div></div>`;
            }

            // 4. ä¿—è¯­/çŸ­è¯­
            if (word.idioms && word.idioms.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Idioms & Slang</h3><div class="grid grid-cols-1 gap-3">`;
                word.idioms.forEach(i => {
                    detailsHtml += `<div class="p-3 rounded-xl bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400 font-medium border border-amber-100 dark:border-amber-900/20">${i}</div>`;
                });
                detailsHtml += `</div></div>`;
            }

            const content = `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-black text-slate-900 dark:text-white mb-3 tracking-tight">${word.english}</h2>
                    ${word.phonetic_us ? `<div class="inline-flex items-center gap-2 px-4 py-2 mb-4 rounded-full bg-indigo-600/10 dark:bg-indigo-500/15 text-indigo-700 dark:text-indigo-200 font-medium shadow-sm">
                        <span class="text-xs font-bold tracking-[0.2em] uppercase text-indigo-500/90 dark:text-indigo-300/90">US</span>
                        <span class="text-lg font-mono leading-none">/${word.phonetic_us}/</span>
                    </div>` : ''}
                    <div class="flex justify-center gap-3">
                        <button onclick="speak('${word.english.replace(/'/g, "\\'")}', 'us')" class="px-6 py-3 rounded-2xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-all flex items-center gap-3 shadow-xl shadow-indigo-500/20 active:scale-95">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M12 8V7l-3 3H6v4h3l3 3v-1M12 8v8"/></svg>
                            <span>US Pronunciation</span>
                        </button>
                    </div>
                </div>
                <div class="prose dark:prose-invert max-w-none">
                    ${detailsHtml}
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = content;
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('hidden');
            toggleBodyScroll(true);
        }

        function cleanDefinitions(text) {
            if (!text) return '';
            let content = text.split('ğŸ“ ä¾‹å¥:')[0];
            content = content.split('ğŸ”— æ­é…:')[0];
            content = content.split('ğŸ’¡ çŸ­è¯­:')[0];
            
            const lines = content.split('\n');
            const cleanLines = lines.filter(line => {
                const l = line.trim();
                if (!l) return false;
                if (l.includes('ğŸ‡ºğŸ‡¸') || l.includes('ğŸ‡¬ğŸ‡§') || l.includes('us ') || l.includes('uk ') || l.includes('ç¾ ') || l.includes('è‹± ')) return false;
                if (/^\[\s*['"]/.test(l)) return false; 
                if (/^\/\s*.*?\/\s*$/.test(l)) return false;
                return true;
            });
            
            return cleanLines.join('\n');
        }

        function speak(text, type) {
            if (!window.speechSynthesis) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾');
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // å°è¯•æ›´ç²¾å‡†çš„è¯­éŸ³åŒ¹é…
            const langCode = type === 'us' ? 'en-US' : 'en-GB';
            utterance.lang = langCode;
            
            // ç¡®ä¿åŠ è½½äº†è¯­éŸ³åˆ—è¡¨ï¼ˆChromeæœ‰æ—¶éœ€è¦å¼‚æ­¥åŠ è½½ï¼‰
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                // ä¼˜å…ˆå¯»æ‰¾å®Œå…¨åŒ¹é…çš„åŒºåŸŸè¯­éŸ³
                let voice = voices.find(v => v.lang === langCode);
                // å…¶æ¬¡å¯»æ‰¾åŒ…å«è¯¥åŒºåŸŸä»£ç çš„è¯­éŸ³ (ä¾‹å¦‚ en-GB-Standard-A)
                if (!voice) voice = voices.find(v => v.lang.includes(langCode));
                // å¦‚æœæ˜¯è‹±éŸ³ä½†æ²¡æ‰¾åˆ°ï¼Œå°è¯•æ‰¾ä»»ä½•éç¾å›½çš„è‹±è¯­ï¼Œæˆ–è€…åå­—é‡Œå¸¦ UK/British çš„
                if (!voice && type === 'uk') {
                    voice = voices.find(v => v.name.includes('UK') || v.name.includes('British') || (v.lang.startsWith('en') && !v.lang.includes('US')));
                }
                
                if (voice) {
                    utterance.voice = voice;
                    // è‹±éŸ³é€šå¸¸è¯­é€Ÿç¨æ…¢ä¸€ç‚¹æ›´ä¼˜é›…
                    if (type === 'uk') utterance.rate = 0.9;
                }
            }
            
            window.speechSynthesis.speak(utterance);
        }

        // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }

        async function fetchTranslation() {
            const en = document.getElementById('new-en').value.trim();
            const zhInput = document.getElementById('new-zh');
            if (!en) return;
            
            zhInput.placeholder = 'æ­£åœ¨æ·±åº¦æ£€ç´¢æƒå¨è¯åº“...';
            try {
                // ä¼˜å…ˆå°è¯•æœ¬åœ°å¢å¼ºåç«¯
                const response = await fetch(`http://localhost:3000/api/translate?word=${encodeURIComponent(en)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // å­˜å‚¨ç»“æ„åŒ–æ•°æ®ä¾›ä¿å­˜ä½¿ç”¨
                    tempWordData = {
                        definitions: data.definitions || [],
                        examples: data.examples || [],
                        collocations: data.collocations || [],
                        idioms: data.idioms || [],
                        phonetic_us: data.phonetic_us || '',
                        phonetic_uk: data.phonetic_uk || ''
                    };
                    
                    let finalStr = '';
                    
                    // éŸ³æ ‡
                    if (data.phonetic_us || data.phonetic_uk) {
                        if (data.phonetic_us) finalStr += `ğŸ‡ºğŸ‡¸ ${data.phonetic_us}  `;
                        // if (data.phonetic_uk) finalStr += `ğŸ‡¬ğŸ‡§ ${data.phonetic_uk}`; // ç”¨æˆ·è¦æ±‚éšè—è‹±éŸ³
                        finalStr += '\n\n';
                    }
                    
                    // é‡Šä¹‰
                    if (data.definitions && data.definitions.length > 0) {
                        data.definitions.forEach(def => {
                            finalStr += `[${def.pos}] ${def.def}\n`;
                        });
                    }
                    
                    // ä¾‹å¥ (å–å‰1ä¸ª)
                    if (data.examples && data.examples.length > 0) {
                        finalStr += '\nğŸ“ ä¾‹å¥:\n';
                        data.examples.slice(0, 1).forEach(ex => {
                            finalStr += `${ex.en}\n${ex.cn}\n`;
                        });
                    }

                    // æ­é…
                    if (data.collocations && data.collocations.length > 0) {
                        finalStr += '\nğŸ”— æ­é…:\n';
                        data.collocations.slice(0, 3).forEach(c => finalStr += `${c}\n`);
                    }

                    // çŸ­è¯­
                    if (data.idioms && data.idioms.length > 0) {
                        finalStr += '\nğŸ’¡ çŸ­è¯­:\n';
                        data.idioms.slice(0, 2).forEach(i => finalStr += `${i}\n`);
                    }

                    if (finalStr.trim()) {
                        zhInput.value = finalStr.trim();
                        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                        zhInput.style.height = 'auto';
                        zhInput.style.height = (zhInput.scrollHeight) + 'px';
                        return;
                    }
                }
                
                throw new Error('Local backend returned empty or error');
            } catch (localError) {
                console.log('æœ¬åœ°åç«¯è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢è‡³å¤‡ç”¨æº:', localError);
                // é™çº§ç­–ç•¥ï¼šä½¿ç”¨åŸæœ‰ API
                try {
                    const [dictRes, transRes] = await Promise.all([
                        fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(en)}`),
                        fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(en)}&langpair=en|zh-CN`)
                    ]);
                    
                    const dictData = await dictRes.json();
                    const transData = await transRes.json();
                    
                    let results = [];
                    let phonetic = '';

                    // 1. è§£æè¯æ€§ã€éŸ³æ ‡
                    if (Array.isArray(dictData) && dictData.length > 0) {
                        const entry = dictData[0];
                        phonetic = entry.phonetic || (entry.phonetics && entry.phonetics.find(p => p.text)?.text) || '';
                        
                        entry.meanings.forEach(m => {
                            const pos = m.partOfSpeech;
                            results.push({ pos, definitions: [] });
                        });
                    }

                    // 2. è·å–ä¸­æ–‡ç¿»è¯‘
                    if (transData.responseData) {
                        const translatedText = transData.responseData.translatedText;
                        const rawItems = translatedText.split(/[ï¼›;ã€‚]/).map(t => t.trim()).filter(t => t);
                        
                        if (results.length > 0) {
                            let finalStr = phonetic ? `${phonetic}\n` : '';
                            results.forEach((res, idx) => {
                                const chunk = rawItems.slice(idx * 2, (idx + 1) * 2).join('; ');
                                if (chunk) {
                                    finalStr += `[${res.pos}] ${chunk}\n`;
                                }
                            });
                            const remaining = rawItems.slice(results.length * 2).join('; ');
                            if (remaining) {
                                finalStr += `[å…¶ä»–] ${remaining}`;
                            }
                            zhInput.value = finalStr.trim();
                        } else {
                            zhInput.value = (phonetic ? `${phonetic} ` : '') + rawItems.join('; ');
                        }
                    }
                    
                    if (zhInput.value.length < 10) {
                        zhInput.value += " (å»ºè®®æŸ¥é˜…è¯å…¸ç¡®è®¤å®Œæ•´ç”¨æ³•)";
                    }
                    
                    zhInput.style.height = 'auto';
                    zhInput.style.height = (zhInput.scrollHeight) + 'px';
                } catch (error) {
                    console.error('æ‰€æœ‰æºæŸ¥è¯¢å¤±è´¥:', error);
                    zhInput.placeholder = 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è¯¦ç»†é‡Šä¹‰';
                }
            }
        }

        function saveWords() {
            const key = getWordsStorageKey();
            localStorage.setItem(key, JSON.stringify(words));
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
        }

        function getWrongWords() {
            return words.filter(w => (w.wrongCount || 0) > 0).sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
        }
        
        function getDailyReviewStats() {
            const baseTarget = reviewSettings.dailyTarget || 20;
            if (!currentUser || !words || words.length === 0) {
                return { total: 0, yesterdayWrong: 0, baseTarget };
            }
            const yesterdayWrong = getYesterdayWrongWords();
            const totalCount = Math.min(words.length, baseTarget + yesterdayWrong.length);
            return { total: totalCount, yesterdayWrong: yesterdayWrong.length, baseTarget };
        }
        
        function maybeShowReviewModal() {
            if (!currentUser) return;
            if (!words || words.length === 0) return;
            const today = getTodayDateStr();
            if (reviewSettings.lastReviewDate === today) return;
            const stats = getDailyReviewStats();
            if (stats.total === 0) return;
            const modal = document.getElementById('review-modal');
            if (!modal) return;
            const totalSpan = document.getElementById('review-total-count');
            const ySpan = document.getElementById('review-yesterday-count');
            if (totalSpan) totalSpan.textContent = String(stats.total);
            if (ySpan) ySpan.textContent = String(stats.yesterdayWrong);
            modal.classList.remove('hidden');
            toggleBodyScroll(true);
        }

        function closeReviewModal() {
            const modal = document.getElementById('review-modal');
            if (modal) {
                modal.classList.add('hidden');
                toggleBodyScroll(false);
            }
        }

        function switchMode(mode) {
            updateQuote(); // åˆ‡æ¢é¡µé¢æ—¶æ›´æ–°é¼“åŠ±è¯­
            const container = document.getElementById('main-content');
            container.classList.remove('animate-enter');
            void container.offsetWidth; // Trigger reflow
            
            currentMode = mode;
            isPracticeMode = (mode === 'error_practice');
            if (mode === 'list') listRenderLimit = 80;
            render();
            
            container.classList.add('animate-enter');

            // Update Nav Styles
            document.querySelectorAll('.nav-pill').forEach(btn => {
                btn.classList.remove('nav-active');
            });
            
            // Map modes to buttons
            let activeBtnId = 'btn-list';
            if (mode === 'input') activeBtnId = 'btn-input';
            else if (mode.startsWith('test') || mode === 'error_practice') activeBtnId = 'btn-test';
            else if (mode === 'daily_review') activeBtnId = 'btn-review';
            else if (mode === 'profile') activeBtnId = 'btn-profile';
            
            const activeBtn = document.getElementById(activeBtnId);
            if (activeBtn) {
                activeBtn.classList.add('nav-active');
            }
        }

        function handleSearch(event) {
            searchQuery = event.target.value;
            listRenderLimit = 80;
            render();
        }

        function toggleSortDropdown() {
            const menu = document.getElementById('sort-dropdown-menu');
            if (menu) menu.classList.toggle('show');
        }

        function selectSort(value) {
            sortOrder = value;
            listRenderLimit = 80;
            
            // 1. Update dropdown text immediately
            const dropdownBtn = document.querySelector('.custom-dropdown-btn span');
            if (dropdownBtn) {
                const labels = {
                    'date_desc': 'æœ€æ–°æ·»åŠ ',
                    'date_asc': 'æœ€æ—©æ·»åŠ ',
                    'alpha_asc': 'A-Z æ’åˆ—',
                    'alpha_desc': 'Z-A æ’åˆ—'
                };
                dropdownBtn.textContent = labels[value];
            }

            // 2. Update active class in menu
            const items = document.querySelectorAll('.custom-dropdown-item');
            items.forEach(item => {
                if (item.getAttribute('onclick').includes(value)) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // 3. Close the dropdown menu
            const menu = document.getElementById('sort-dropdown-menu');
            if (menu) menu.classList.remove('show');

            // 4. Trigger partial render (resorts the list)
            render();
        }

        function loadMoreWords() {
            listRenderLimit += 80;
            render();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('sort-dropdown');
            const menu = document.getElementById('sort-dropdown-menu');
            if (dropdown && !dropdown.contains(event.target) && menu && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
        });

        // --- æ¸²æŸ“å‡½æ•° ---
        function render() {
            const container = document.getElementById('main-content');
            
            // Optimization: If we are in list mode and updating search/sort, try partial update
            if (currentMode === 'list') {
                // Filter and Sort Logic
                let displayWords = [...words];
                
                // Filter
                if (searchQuery) {
                    const lowerQ = searchQuery.toLowerCase();
                    displayWords = displayWords.filter(w => 
                        (w.english && w.english.toLowerCase().includes(lowerQ)) || 
                        (w.chinese && w.chinese.toLowerCase().includes(lowerQ))
                    );
                }

                // Sort
                if (sortOrder === 'date_asc') {
                    displayWords.sort((a, b) => a.id - b.id);
                } else if (sortOrder === 'date_desc') {
                    displayWords.sort((a, b) => b.id - a.id);
                } else if (sortOrder === 'alpha_asc') {
                    displayWords.sort((a, b) => (a.english || '').localeCompare(b.english || ''));
                } else if (sortOrder === 'alpha_desc') {
                    displayWords.sort((a, b) => (b.english || '').localeCompare(a.english || ''));
                }

                const totalDisplay = displayWords.length;
                const visibleWords = displayWords.slice(0, listRenderLimit);
                const hasMoreWords = totalDisplay > visibleWords.length;

                const generateWordListHTML = (list) => {
                    let listHtml = '';
                    if (list.length === 0) {
                        listHtml += `
                            <div class="text-center py-16 animate-enter col-span-full">
                                <div class="text-6xl mb-4 opacity-30 grayscale filter">ğŸ”</div>
                                <p class="text-slate-500 dark:text-slate-400 font-medium">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•è¯</p>
                            </div>
                        `;
                    } else {
                        list.forEach((word, index) => {
                            const delay = Math.min(index * 0.05, 0.5);
                            const borderColors = ['border-l-blue-500', 'border-l-purple-500', 'border-l-pink-500', 'border-l-indigo-500', 'border-l-teal-500'];
                            const colorClass = borderColors[index % borderColors.length];
                            
                            listHtml += `
                                <div onclick="showWordDetails(${word.id})" class="word-card bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 border-l-4 ${colorClass} shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all relative group cursor-pointer">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1 pr-8">
                                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                                <span class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">${word.english}</span>
                                                ${word.phonetic_us ? `<span class="text-sm text-slate-400 dark:text-slate-500 font-mono leading-none">/${word.phonetic_us}/</span>` : ''}
                                                <div class="flex items-center gap-1">
                                                    <button onclick="event.stopPropagation(); speak('${word.english.replace(/'/g, "\\'")}', 'us')" class="p-2 rounded-xl text-indigo-500 hover:text-white hover:bg-indigo-500 dark:text-indigo-400 dark:hover:bg-indigo-500 bg-indigo-50 dark:bg-indigo-500/10 transition-all flex items-center justify-center group/btn shadow-sm" title="ç‚¹å‡»æœ—è¯» (US)">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M12 8V7l-3 3H6v4h3l3 3v-1M12 8v8"/></svg>
                                                    </button>
                                                </div>
                                                ${word.wrongCount > 0 ? `<span class="px-2 py-1 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 text-[10px] font-bold rounded-lg border border-rose-100 dark:border-rose-900/30 uppercase tracking-wider">å¤ä¹  ${word.wrongCount}</span>` : ''}
                                            </div>
                                            <div class="text-slate-600 dark:text-slate-400 font-medium text-base leading-relaxed whitespace-pre-line line-clamp-2">${extractDefinition(word.chinese)}</div>
                                        </div>
                                        <button onclick="event.stopPropagation(); handleDeleteWord(${word.id})" class="absolute top-4 right-4 p-1 text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-all opacity-0 group-hover:opacity-100 translate-x-2 group-hover:translate-x-0">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    return listHtml;
                };

                const existingList = document.getElementById('word-list-grid');
                if (existingList && container.contains(existingList) && words.length > 0) {
                    const moreHtml = hasMoreWords
                        ? `<button onclick="loadMoreWords()" class="px-6 py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:shadow-md transition-all">åŠ è½½æ›´å¤šï¼ˆ${visibleWords.length}/${totalDisplay}ï¼‰</button>`
                        : `<div class="text-xs text-slate-400 font-bold">å·²æ˜¾ç¤ºå…¨éƒ¨ï¼ˆ${visibleWords.length}/${totalDisplay}ï¼‰</div>`;
                        
                    existingList.innerHTML = generateWordListHTML(visibleWords);
                    const moreContainer = document.getElementById('word-list-more');
                    if (moreContainer) moreContainer.innerHTML = moreHtml;
                    return;
                }

                // Full Render
                container.innerHTML = '';
                
                let html = `<div class="animate-enter">`;
                
                // Toolbar
                html += `
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8 animate-enter bg-white/50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700/50 backdrop-blur-sm relative z-20">
                        <div class="flex items-center gap-3 w-full md:w-auto flex-1">
                            <div class="relative flex-1 min-w-[240px] group">
                                <input type="text" value="${searchQuery}" oninput="handleSearch(event)" placeholder="æœç´¢å•è¯..." class="w-full pl-11 pr-4 py-3 rounded-2xl bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 focus:border-indigo-500 dark:focus:border-indigo-500 outline-none transition-all text-base font-semibold text-slate-700 dark:text-slate-200 shadow-sm group-hover:border-slate-300 dark:group-hover:border-slate-600">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3.5 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <div class="custom-dropdown-container w-32 sm:w-36 md:w-40 flex-shrink-0" id="sort-dropdown">
                                <button onclick="event.stopPropagation(); toggleSortDropdown()" class="custom-dropdown-btn">
                                    <span class="truncate mr-2">${
                                        sortOrder === 'date_desc' ? 'æœ€æ–°æ·»åŠ ' :
                                        sortOrder === 'date_asc' ? 'æœ€æ—©æ·»åŠ ' :
                                        sortOrder === 'alpha_asc' ? 'A-Z æ’åˆ—' :
                                        'Z-A æ’åˆ—'
                                    }</span>
                                    <svg class="w-4 h-4 text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="sort-dropdown-menu" class="custom-dropdown-menu">
                                    <div onclick="selectSort('date_desc')" class="custom-dropdown-item ${sortOrder === 'date_desc' ? 'active' : ''}">æœ€æ–°æ·»åŠ </div>
                                    <div onclick="selectSort('date_asc')" class="custom-dropdown-item ${sortOrder === 'date_asc' ? 'active' : ''}">æœ€æ—©æ·»åŠ </div>
                                    <div onclick="selectSort('alpha_asc')" class="custom-dropdown-item ${sortOrder === 'alpha_asc' ? 'active' : ''}">A-Z æ’åˆ—</div>
                                    <div onclick="selectSort('alpha_desc')" class="custom-dropdown-item ${sortOrder === 'alpha_desc' ? 'active' : ''}">Z-A æ’åˆ—</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                            <button onclick="openLibraryModal()" class="px-4 py-2.5 rounded-xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:shadow-md transition-all flex items-center gap-2 text-sm whitespace-nowrap">
                                <span>ğŸ“š</span> è¯åº“ç®¡ç†
                            </button>
                            <input type="file" id="word-import-toolbar-input" class="hidden" accept=".doc,.docx" onchange="handleWordImport(event)">
                            <button onclick="document.getElementById('word-import-toolbar-input').click()" class="px-4 py-2.5 rounded-xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:shadow-md transition-all flex items-center gap-2 text-sm whitespace-nowrap">
                                <span>ğŸ“¥</span> å¯¼å…¥
                            </button>
                            <button onclick="openClearWordsModal()" class="px-4 py-2.5 rounded-xl bg-white dark:bg-slate-800 text-rose-600 dark:text-rose-400 font-bold border border-rose-200 dark:border-rose-800 hover:bg-rose-50 dark:hover:bg-rose-900/20 hover:shadow-md transition-all flex items-center gap-2 text-sm whitespace-nowrap">
                                <span>ğŸ—‘ï¸</span> æ¸…ç©º
                            </button>
                            <button onclick="openExportModal()" class="px-4 py-2.5 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 hover:shadow-lg hover:shadow-indigo-500/20 transition-all flex items-center gap-2 text-sm whitespace-nowrap">
                                <span>ğŸ“„</span> å¯¼å‡º
                            </button>
                        </div>
                    </div>
                `;

                if (words.length > 0) {
                    const wrongWords = getWrongWords();
                    
                    if (wrongWords.length > 0 && !searchQuery) {
                        html += `
                            <div class="mb-8 p-6 bg-gradient-to-br from-rose-500 to-pink-600 rounded-[2rem] text-white shadow-xl shadow-rose-500/20 flex flex-col md:flex-row justify-between items-center relative overflow-hidden group hover-scale">
                                <div class="relative z-10 mb-4 md:mb-0 text-center md:text-left">
                                    <h3 class="font-bold text-xl mb-1 flex items-center justify-center md:justify-start gap-2">
                                        <span>ğŸ”¥</span> é”™é¢˜ä¸“é¡¹å¼ºåŒ–
                                    </h3>
                                    <p class="opacity-90 font-medium text-sm mb-3">å·²æœ‰ ${wrongWords.length} ä¸ªé‡ç‚¹å•è¯éœ€è¦å·©å›º</p>
                                    <button onclick="handleClearWrongRecords()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-2 backdrop-blur-md border border-white/20 mx-auto md:mx-0">
                                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºé”™é¢˜è®°å½•
                                    </button>
                                </div>
                                <button onclick="switchMode('error_practice')" class="relative z-10 bg-white/90 text-rose-600 px-6 py-2.5 rounded-xl font-bold hover:bg-white transition-all shadow-sm active:scale-95 text-sm">
                                    ç«‹å³å¼€å§‹
                                </button>
                                <div class="absolute -right-12 -bottom-12 text-[10rem] opacity-10 rotate-12 group-hover:rotate-0 transition-transform duration-700">ğŸ¯</div>
                            </div>
                        `;
                    }

                    const moreHtml = hasMoreWords
                        ? `<button onclick="loadMoreWords()" class="px-6 py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:shadow-md transition-all">åŠ è½½æ›´å¤šï¼ˆ${visibleWords.length}/${totalDisplay}ï¼‰</button>`
                        : `<div class="text-xs text-slate-400 font-bold">å·²æ˜¾ç¤ºå…¨éƒ¨ï¼ˆ${visibleWords.length}/${totalDisplay}ï¼‰</div>`;

                    html += `<div id="word-list-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                    html += generateWordListHTML(visibleWords);
                    html += `</div>`;
                    html += `<div id="word-list-more" class="mt-8 flex justify-center">${moreHtml}</div>`;
                } else {
                    html += `
                        <div class="text-center py-24 animate-enter">
                            <div class="text-8xl mb-6 opacity-30 grayscale filter">ğŸƒ</div>
                            <p class="text-slate-500 dark:text-slate-400 text-lg font-medium mb-8">è¯åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ·»åŠ æ–°è¯å§</p>
                            <div class="flex flex-col sm:flex-row justify-center gap-4 items-center">
                                <button onclick="switchMode('input')" class="px-6 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 hover:shadow-lg transition-all flex items-center gap-2">
                                    <span>âœï¸</span> å½•å…¥æ–°è¯
                                </button>
                                <button onclick="document.getElementById('word-import-toolbar-input').click()" class="px-6 py-3 rounded-xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:shadow-md transition-all flex items-center gap-2">
                                    <span>ğŸ“¥</span> å¯¼å…¥å•è¯æœ¬
                                </button>
                                <button onclick="openLibraryModal()" class="px-6 py-3 rounded-xl bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:shadow-md transition-all flex items-center gap-2">
                                    <span>ğŸ“š</span> è¯åº“ç®¡ç†
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                container.innerHTML = html;
                return;
            }
            
            // If we are here, either not list mode, or list mode with empty words (and no partial update)
            container.innerHTML = '';
            
            if (currentMode === 'input') {
                container.innerHTML = `
                    <div class="max-w-2xl mx-auto animate-enter">
                        <div class="flex items-center gap-5 mb-12">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-blue-500 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 transform rotate-3">
                                <span class="text-2xl">âœï¸</span>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight">æ·»åŠ æ–°è¯</h2>
                                <p class="text-slate-500 dark:text-slate-400 font-medium">æ‰©å……ä½ çš„ä¸“å±è¯åº“</p>
                            </div>
                        </div>
                        <form onsubmit="handleAddWord(event)" class="space-y-8">
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider ml-1">Word to Learn</label>
                                <div class="relative group">
                                    <input type="text" id="new-en" required 
                                        class="premium-input w-full p-5 pl-6 rounded-2xl text-xl font-bold placeholder:text-slate-400 dark:placeholder:text-slate-500" 
                                        placeholder="è¾“å…¥è‹±æ–‡å•è¯..." 
                                        onblur="if(!document.getElementById('new-zh').value) fetchTranslation()">
                                    <button type="button" onclick="fetchTranslation()" 
                                        class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2 bg-indigo-50 dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 rounded-xl hover:bg-indigo-600 hover:text-white transition-all font-bold text-sm flex items-center gap-2">
                                        <span>ğŸ”</span> <span class="hidden sm:inline">æ™ºèƒ½é‡Šä¹‰</span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider ml-1">Meaning & Notes</label>
                                <textarea id="new-zh" required 
                                    class="premium-input w-full p-6 rounded-2xl min-h-[160px] text-lg font-medium leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 resize-none" 
                                    placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯è‡ªåŠ¨è·å–è¯¦ç»†é‡Šä¹‰..."></textarea>
                            </div>
                            <button type="submit" 
                                class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold py-5 rounded-2xl transition-all shadow-xl shadow-slate-900/20 hover:shadow-2xl hover:scale-[1.01] active:scale-[0.98] flex items-center justify-center gap-3 mt-4">
                                <span class="text-lg">ç¡®è®¤æ·»åŠ è‡³è¯åº“</span>
                                <span>âœ¨</span>
                            </button>
                        </form>
                    </div>
                `;
            } else if (currentMode === 'profile') {
                const name = currentUser ? (currentUser.name || currentUser.account) : 'è®¿å®¢';
                const account = currentUser ? currentUser.account : 'æœªç™»å½•';
                const wordCount = words.length;
                const stats = getDailyReviewStats();
                container.innerHTML = `
                    <div class="animate-enter max-w-3xl mx-auto space-y-5">
                        <div class="rounded-[2rem] p-6 md:p-7 bg-white/85 dark:bg-slate-800/60 backdrop-blur-xl border border-slate-200/70 dark:border-slate-700/60 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-5">
                                <div class="flex items-center gap-4">
                                    <div class="relative w-16 h-16 rounded-2xl bg-slate-900/5 dark:bg-white/5 flex items-center justify-center overflow-hidden cursor-pointer group flex-shrink-0" onclick="document.getElementById('avatar-upload-input').click()">
                                        ${currentUser && currentUser.avatar 
                                            ? `<img src="${currentUser.avatar}" class="w-full h-full object-cover" />`
                                            : `<svg class="w-8 h-8 text-slate-500 dark:text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A8 8 0 0112 14a8 8 0 016.879 3.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                               </svg>`
                                        }
                                        <div class="absolute inset-0 bg-slate-900/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        </div>
                                    </div>
                                    <input type="file" id="avatar-upload-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
                                    <div class="text-left min-w-0">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">æˆ‘çš„</div>
                                        <div class="text-2xl md:text-3xl font-black text-slate-900 dark:text-white truncate">${name}</div>
                                        <div class="mt-1 text-sm font-semibold text-slate-500 dark:text-slate-400 truncate">è´¦å·ï¼š${account}</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3 w-full md:w-auto">
                                    <div class="rounded-2xl bg-white/60 dark:bg-slate-900/40 border border-slate-100/70 dark:border-slate-700/50 p-4">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">å½“å‰è¯åº“</div>
                                        <div class="mt-1 text-2xl font-black text-slate-900 dark:text-white">${wordCount}</div>
                                        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400">ä¸ªå•è¯</div>
                                    </div>
                                    <div class="rounded-2xl bg-white/60 dark:bg-slate-900/40 border border-slate-100/70 dark:border-slate-700/50 p-4">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">ä»Šæ—¥å¤ä¹ </div>
                                        <div class="mt-1 text-2xl font-black text-slate-900 dark:text-white">${stats.total}</div>
                                        <div class="text-xs font-semibold text-slate-500 dark:text-slate-400">ä¸ªå¾…å¤ä¹ </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="openAuthModal('login')" class="button-soft p-5 rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-indigo-500 hover:shadow-lg transition-all flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">åˆ‡æ¢è´¦å·</div>
                                    <div class="text-slate-800 dark:text-slate-100 font-semibold mt-1 text-sm">ä½¿ç”¨å¦ä¸€ç»„è´¦å·ç™»å½•</div>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-500 transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                                    </svg>
                                </div>
                            </button>
                            <button onclick="handleLogout()" class="button-soft p-5 rounded-2xl bg-slate-900 text-white border border-slate-800 hover:bg-rose-600 hover:border-rose-500 hover:shadow-lg transition-all flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs font-bold uppercase tracking-widest">é€€å‡ºç™»å½•</div>
                                    <div class="text-slate-200 font-semibold mt-1 text-sm">å®‰å…¨é€€å‡ºå½“å‰è´¦å·</div>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </div>
                            </button>
                        </div>

                        <div class="rounded-[2rem] p-6 bg-white/85 dark:bg-slate-800/60 backdrop-blur-xl border border-slate-200/70 dark:border-slate-700/60 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">ä¿®æ”¹æ˜µç§°</div>
                                    <input id="profile-name-input" type="text" value="${name}" class="premium-input w-full p-3.5 rounded-2xl text-base font-semibold" placeholder="è¾“å…¥æ–°çš„æ˜µç§°">
                                </div>
                                <button onclick="handleUpdateProfileName()" class="md:w-40 w-full px-4 py-3.5 rounded-2xl bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all">ä¿å­˜</button>
                            </div>
                        </div>

                        <div class="rounded-[2rem] p-6 bg-white/85 dark:bg-rose-900/15 border border-rose-200/60 dark:border-rose-800/60 shadow-sm backdrop-blur-xl">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <div class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mb-1">å±é™©æ“ä½œ</div>
                                    <div class="text-slate-700 dark:text-slate-200 text-sm font-semibold">ç®¡ç†è¯åº“ä¸è´¦å·æ•°æ®</div>
                                </div>
                                <div class="w-10 h-10 rounded-2xl bg-rose-500 text-white flex items-center justify-center shadow-sm">âš ï¸</div>
                            </div>
                            <div class="mt-4 space-y-2">
                                <button onclick="openDeleteAccountModal()" class="w-full button-soft py-2 rounded-xl bg-rose-600 text-white font-bold text-xs hover:bg-rose-700 shadow-md transition-all">åˆ é™¤è´¦å·</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'daily_review') {
                const stats = getDailyReviewStats();
                container.innerHTML = `
                    <div class="animate-enter max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">æ¯æ—¥å¤ä¹ ä¸­å¿ƒ</h2>
                        
                        <!-- Settings Block -->
                        <div class="mb-6 p-6 rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">æ¯æ—¥å¤ä¹ è®¡åˆ’</div>
                                    <div class="text-slate-800 dark:text-slate-100 font-semibold mt-1 text-sm">æ¯å¤©å¤ä¹  <span id="review-daily-target-display">${reviewSettings.dailyTarget || 20}</span> ä¸ªå•è¯</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 mt-2">
                                <input id="review-daily-target-input" type="number" min="1" max="500" value="${reviewSettings.dailyTarget || 20}" class="premium-input w-24 p-2 rounded-xl text-sm font-medium text-center">
                                <button onclick="handleSaveReviewSettings()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all">ä¿å­˜</button>
                            </div>
                            <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">æ˜¨æ—¥åšé”™çš„å•è¯ä¼šé¢å¤–åŠ å…¥å¤ä¹ ï¼Œä¸å ç”¨æ¯æ—¥æ•°é‡ã€‚</p>
                            ${reviewSettings.lastReviewDate ? `<p class="text-xs text-slate-400 dark:text-slate-500 mt-1">ä¸Šæ¬¡å®Œæˆå¤ä¹ ï¼š${reviewSettings.lastReviewDate}</p>` : ''}
                        </div>

                        <!-- Stats & Start Block -->
                        <div class="p-6 rounded-2xl bg-gradient-to-br from-indigo-50 to-sky-50 dark:from-slate-800 dark:to-slate-900 border border-indigo-100/60 dark:border-indigo-900/40 shadow-sm hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                            <div class="flex items-center justify-between gap-4">
                                <div class="text-left">
                                    <div class="text-xs font-bold text-indigo-500 dark:text-indigo-300 uppercase tracking-widest mb-1">ä»Šæ—¥å¤ä¹ æ¦‚è§ˆ</div>
                                    <div class="text-sm text-slate-700 dark:text-slate-200 font-medium">
                                        ä»Šæ—¥éœ€å¤ä¹  <span class="font-extrabold text-indigo-600 dark:text-indigo-400 text-base">${stats.total}</span> ä¸ªï¼Œ
                                        æ˜¨æ—¥é”™é¢˜ <span class="font-extrabold text-rose-500 text-base">${stats.yesterdayWrong}</span> ä¸ª
                                    </div>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-2">ä¿æŒèŠ‚å¥ï¼Œæ¯å¤©ä¸€ç‚¹ç‚¹è¿›æ­¥ã€‚</p>
                                </div>
                                <div class="w-11 h-11 rounded-2xl bg-indigo-500 text-white flex items-center justify-center text-xl shadow-md shadow-indigo-500/40">
                                    ğŸ“†
                                </div>
                            </div>
                            <button onclick="handleStartDailyReviewFromProfile()" class="mt-4 w-full button-soft py-3 rounded-2xl bg-indigo-600 text-white font-bold text-sm flex items-center justify-center gap-2 shadow-lg shadow-indigo-500/40 hover:bg-indigo-700">
                                <span>ä¸€é”®å¼€å§‹ä»Šæ—¥å¤ä¹ </span>
                                <span class="text-base">â–¶</span>
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test_select' || currentMode === 'error_practice') {
                const targetWords = isPracticeMode ? getWrongWords() : words;
                if (targetWords.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-24 animate-enter">
                            <div class="text-8xl mb-6 opacity-50">ğŸ”­</div>
                            <p class="text-slate-500 text-xl font-medium mb-8">${isPracticeMode ? 'æš‚æ— é”™é¢˜è®°å½•' : 'è¯åº“è¿˜æ˜¯ç©ºçš„'}</p>
                            <button onclick="switchMode('input')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-xl shadow-indigo-500/20 hover:bg-indigo-700 transition-all">å»æ·»åŠ å•è¯</button>
                        </div>
                    `;
                    return;
                }

                const savedProgress = loadTestProgress();
                let resumeHtml = '';
                
                if (savedProgress && !isPracticeMode) {
                     const progressPercent = Math.round((savedProgress.currentIndex / savedProgress.testSession.length) * 100);
                     resumeHtml = `
                        <div class="mb-8 p-1">
                            <button onclick="handleResumeTest()" class="w-full p-6 rounded-2xl bg-gradient-to-r from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 border-2 border-amber-200 dark:border-amber-700/50 flex items-center justify-between group hover:shadow-lg transition-all relative overflow-hidden">
                                <div class="flex items-center gap-4 relative z-10">
                                    <div class="w-12 h-12 rounded-xl bg-amber-500 text-white flex items-center justify-center text-2xl shadow-lg shadow-amber-500/30">
                                        â¸ï¸
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold text-slate-800 dark:text-slate-100 text-lg">ç»§ç»­ä¸Šæ¬¡çš„æµ‹è¯•</div>
                                        <div class="text-slate-500 dark:text-slate-400 text-xs font-medium">è¿›åº¦: ${progressPercent}% (${savedProgress.currentIndex}/${savedProgress.testSession.length}) Â· ${savedProgress.testMode === 'en-zh' ? 'è‹±è¯‘æ±‰' : 'æ±‰è¯‘è‹±'}</div>
                                    </div>
                                </div>
                                <div class="px-4 py-2 bg-white/50 dark:bg-black/20 rounded-lg text-amber-700 dark:text-amber-400 font-bold text-sm group-hover:bg-amber-500 group-hover:text-white transition-colors">
                                    ç»§ç»­ &rarr;
                                </div>
                            </button>
                        </div>
                     `;
                }

                container.innerHTML = `
                    <div class="animate-enter text-center max-w-2xl mx-auto">
                        <div class="mb-12 relative">
                            <h2 class="text-3xl font-bold mb-3 text-slate-900 dark:text-white tracking-tight">${isPracticeMode ? 'ğŸ¯ é”™é¢˜å¼ºåŒ–' : 'ğŸ“ è®°å¿†æŒ‘æˆ˜'}</h2>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">é€‰æ‹©ä¸€ç§æ¨¡å¼å¼€å§‹æµ‹è¯•</p>
                            
                            ${getWrongWords().length > 0 ? `
                                <button onclick="handleClearWrongRecords()" class="mt-4 px-4 py-2 rounded-xl bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 text-sm font-bold hover:bg-rose-100 dark:hover:bg-rose-900/30 transition-all flex items-center gap-2 mx-auto">
                                    <span>ğŸ—‘ï¸</span> æ¸…ç©ºé”™é¢˜è®°å½•
                                </button>
                            ` : ''}
                        </div>
                        
                        ${resumeHtml}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button onclick="handleStartTest('en-zh')" class="group p-8 rounded-[2rem] bg-gradient-to-br from-white to-blue-50/50 dark:from-slate-800 dark:to-slate-900 border-2 border-slate-100 dark:border-slate-700 hover:border-blue-500 hover:shadow-xl hover:shadow-blue-500/10 transition-all text-left relative overflow-hidden flex flex-col justify-between h-64 hover-scale">
                                <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform text-blue-600">
                                    <span>Aa</span>
                                </div>
                                <div>
                                    <div class="text-xl font-bold mb-2 text-slate-800 dark:text-slate-100">è‹±è¯‘æ±‰ (é€‰æ‹©)</div>
                                    <div class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-relaxed">çœ‹ç€è‹±æ–‡å•è¯ï¼Œé€‰å‡ºæ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰ã€‚</div>
                                </div>
                            </button>
                            
                            <button onclick="handleStartTest('zh-en')" class="group p-8 rounded-[2rem] bg-gradient-to-br from-white to-purple-50/50 dark:from-slate-800 dark:to-slate-900 border-2 border-slate-100 dark:border-slate-700 hover:border-purple-500 hover:shadow-xl hover:shadow-purple-500/10 transition-all text-left relative overflow-hidden flex flex-col justify-between h-64 hover-scale">
                                <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform text-purple-600">
                                    <span>æ–‡</span>
                                </div>
                                <div>
                                    <div class="text-xl font-bold mb-2 text-slate-800 dark:text-slate-100">æ±‰è¯‘è‹± (å¡«ç©º)</div>
                                    <div class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-relaxed">çœ‹ç€ä¸­æ–‡é‡Šä¹‰ï¼Œæ‹¼å†™å‡ºæ­£ç¡®çš„è‹±æ–‡å•è¯ã€‚</div>
                                </div>
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test') {
                const word = testSession[currentIndex];
                const isEnZh = testMode === 'en-zh';
                // æ±‰è¯‘è‹±æ¨¡å¼ä¸‹ï¼Œåªæ˜¾ç¤ºæ¸…ç†åçš„é‡Šä¹‰ï¼ˆå»é™¤ä¾‹å¥ã€éŸ³æ ‡ç­‰ï¼‰
                const question = isEnZh ? word.english : extractDefinition(word.chinese);
                const subHint = isEnZh ? 'è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰' : 'æ‹¼å†™å‡ºå¯¹åº”çš„è‹±æ–‡å•è¯';
                const placeholder = isEnZh ? 'è¾“å…¥ä¸­æ–‡...' : 'Type answer...';

                // æ„å»ºæ ¸å¿ƒäº¤äº’åŒºåŸŸ HTML
                let contentArea = '';
                
                if (isEnZh) {
                    // é€‰æ‹©é¢˜æ¨¡å¼
                    if (isLoadingOptions) {
                        contentArea = `
                            <div class="py-12 flex flex-col items-center justify-center space-y-4 animate-pulse">
                                <div class="w-12 h-12 rounded-full border-4 border-indigo-200 border-t-indigo-600 animate-spin"></div>
                                <div class="text-slate-400 font-bold tracking-widest text-sm uppercase">æ­£åœ¨ç”Ÿæˆæ··æ·†é€‰é¡¹...</div>
                            </div>
                        `;
                    } else {
                        contentArea = `
                            <div class="grid grid-cols-1 gap-4">
                                ${currentOptions.map((opt, idx) => {
                                    const labels = ['A', 'B', 'C', 'D'];
                                    return `
                                    <button onclick="handleCheckAnswer('${opt.replace(/'/g, "\\'")}')" 
                                        class="group relative w-full p-5 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 hover:shadow-lg hover:shadow-indigo-500/10 transition-all text-left flex items-center gap-4 active:scale-[0.99]">
                                        <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-black flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                            ${labels[idx] || '?'}
                                        </div>
                                        <div class="flex-1 font-bold text-slate-700 dark:text-slate-200 text-lg line-clamp-2">
                                            ${opt}
                                        </div>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                } else {
                    // å¡«ç©ºæ¨¡å¼
                    contentArea = `
                        <div id="hint-display" class="hidden text-xl font-mono tracking-widest text-indigo-600 dark:text-indigo-400 mb-6 bg-indigo-50/50 dark:bg-indigo-900/20 py-3 rounded-xl border border-indigo-100 dark:border-indigo-900/30"></div>
                        
                        <input type="text" id="test-input" autofocus 
                            class="premium-input w-full p-6 rounded-2xl outline-none transition-all text-center text-2xl font-bold tracking-wider bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" 
                            placeholder="${placeholder}" 
                            autocomplete="off"
                            onkeydown="if(event.key==='Enter') handleCheckAnswer(this.value)">
                        
                        <div class="flex gap-4">
                            <button onclick="handleHint()" class="flex-1 py-4 bg-white dark:bg-slate-800 rounded-xl font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all border border-slate-100 dark:border-slate-700 text-slate-500 shadow-sm text-sm">ğŸ’¡ æç¤º</button>
                            <button onclick="handleCheckAnswer(document.getElementById('test-input').value)" 
                                class="w-full flex-[2] py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/25 hover:bg-indigo-700 hover:shadow-indigo-500/40 hover:-translate-y-0.5 transition-all active:scale-[0.98] text-lg">
                                æäº¤
                            </button>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="animate-enter max-w-2xl mx-auto">
                        <div class="flex justify-between items-center mb-16">
                            <div class="h-2 flex-1 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mr-6">
                                <div class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: ${(currentIndex + 1) / testSession.length * 100}%"></div>
                            </div>
                            <button onclick="handleInterruptTest()" class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-700 font-bold text-xs transition-all flex items-center gap-1">
                                <span>ğŸ’¾</span> ä¿å­˜å¹¶é€€å‡º
                            </button>
                        </div>
                        
                        <div id="test-question-area" class="text-center">
                            <div class="mb-16 relative">
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-indigo-500/10 blur-3xl rounded-full pointer-events-none"></div>
                                <p class="${isEnZh ? 'text-5xl md:text-6xl font-black text-indigo-600 dark:text-indigo-400' : 'text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100'} leading-tight whitespace-pre-line relative z-10 drop-shadow-sm">${question}</p>
                                <p class="text-slate-400 dark:text-slate-500 font-medium mt-6 text-sm tracking-widest uppercase">${subHint}</p>
                            </div>
                            
                            <div class="max-w-md mx-auto space-y-8" id="test-form-area">
                                ${contentArea}
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test_result') {
                const correctCount = testSession.length - wrongAttempts.length;
                const percentage = Math.round((correctCount / testSession.length) * 100);
                container.innerHTML = `
                    <div class="animate-enter text-center py-10 max-w-md mx-auto">
                        <div class="relative inline-block mb-12">
                            <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full animate-pulse"></div>
                            <div class="relative w-40 h-40 rounded-full bg-white dark:bg-slate-800 border-8 border-slate-50 dark:border-slate-700 shadow-2xl flex items-center justify-center text-7xl transform hover:scale-105 transition-transform duration-500 cursor-default">
                                ${percentage === 100 ? 'ğŸ‘‘' : (percentage >= 80 ? 'ğŸŒŸ' : (percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'))}
                            </div>
                        </div>
                        <h2 class="text-4xl font-black mb-3 text-slate-900 dark:text-white tracking-tight">æµ‹è¯•å®Œæˆ</h2>
                        <p class="text-slate-500 dark:text-slate-400 font-medium mb-12 text-lg">æœ¬æ¬¡æ­£ç¡®ç‡ <span class="text-indigo-600 dark:text-indigo-400 font-bold text-2xl ml-1">${percentage}%</span></p>
                        
                        <div class="grid grid-cols-2 gap-6 mb-12">
                            <div class="p-6 rounded-3xl bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900/20 flex flex-col items-center justify-center">
                                <div class="text-green-600 dark:text-green-400 font-black text-4xl mb-1">${correctCount}</div>
                                <div class="text-green-600/60 dark:text-green-400/60 font-bold text-xs uppercase tracking-widest">Correct</div>
                            </div>
                            <div class="p-6 rounded-3xl bg-rose-50 dark:bg-rose-900/10 border border-rose-100 dark:border-rose-900/20 flex flex-col items-center justify-center">
                                <div class="text-rose-600 dark:text-rose-400 font-black text-4xl mb-1">${wrongAttempts.length}</div>
                                <div class="text-rose-600/60 dark:text-rose-400/60 font-bold text-xs uppercase tracking-widest">Wrong</div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            ${wrongAttempts.length > 0 ? `
                                <button onclick="isPracticeMode=true; handleStartTest('${testMode}')" class="w-full py-4 bg-rose-500 text-white rounded-2xl font-bold shadow-xl shadow-rose-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all">å¼ºåŒ–æœ¬è½®é”™é¢˜</button>
                            ` : ''}
                            <button onclick="switchMode('test_select')" class="w-full py-4 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-2xl font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all">å¼€å¯æ–°æµ‹è¯•</button>
                            <button onclick="switchMode('list')" class="w-full py-4 bg-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 font-bold transition-all text-sm">è¿”å›è¯åº“åˆ—è¡¨</button>
                        </div>
                    </div>
                `;
            }
        }

        function handleClearWrongRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤å•è¯ï¼Œåªä¼šé‡ç½®é”™è¯¯æ¬¡æ•°ã€‚')) {
                words = words.map(w => ({ ...w, wrongCount: 0 }));
                saveWords();
                if (isPracticeMode) {
                    switchMode('test_select');
                } else {
                    render();
                }
            }
        }

        function handleAddWord(e) {
            e.preventDefault();
            const enInput = document.getElementById('new-en');
            const zhInput = document.getElementById('new-zh');
            if (!enInput || !zhInput) return;
            const en = enInput.value.trim();
            const zh = zhInput.value.trim();
            if (!en || !zh) return;
            const enLower = en.toLowerCase();
            const exists = words.some(w => (w.english || '').trim().toLowerCase() === enLower);
            if (exists) {
                alert('è¯åº“ä¸­å·²ç»æœ‰è¿™ä¸ªå•è¯äº†ï¼Œæ— éœ€é‡å¤æ·»åŠ ');
                return;
            }
            let newWord = {
                id: Date.now(),
                english: en,
                chinese: zh,
                wrongCount: 0
            };
            if (tempWordData) {
                newWord = {
                    ...newWord,
                    definitions: tempWordData.definitions,
                    examples: tempWordData.examples,
                    collocations: tempWordData.collocations,
                    idioms: tempWordData.idioms,
                    phonetic_us: tempWordData.phonetic_us,
                    phonetic_uk: tempWordData.phonetic_uk
                };
                tempWordData = null;
            }
            words.unshift(newWord);
            saveWords();
            alert('å·²ä¿å­˜ï¼');
            enInput.value = '';
            zhInput.value = '';
            if (currentMode === 'list') render();
        }

        function handleDeleteWord(id) {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                words = words.filter(w => w.id !== id);
                saveWords();
                render();
            }
        }

        function handleStartTest(mode) {
            if (!isPracticeMode) clearTestProgress();
            const targetWords = isPracticeMode ? getWrongWords() : words;
            if (targetWords.length === 0) return;
            
            testMode = mode;
            // éšæœºåŒ–é¢˜ç›®é¡ºåº
            testSession = [...targetWords].sort(() => Math.random() - 0.5);
            currentIndex = 0;
            currentMode = 'test';
            hintLevel = 0;
            wrongAttempts = [];
            prepareQuestion();
        }
        
        function handleStartDailyReviewFromProfile() {
            const modal = document.getElementById('review-mode-modal');
            if (modal) {
                modal.classList.remove('hidden');
                toggleBodyScroll(true);
            }
        }

        function startDailyReview(mode) {
            closeReviewModal();
            if (!words || words.length === 0) {
                alert('è¯åº“ä¸ºç©ºï¼Œæš‚æ— å¯å¤ä¹ çš„å•è¯');
                return;
            }
            const yesterdayWrong = getYesterdayWrongWords();
            const baseTarget = reviewSettings.dailyTarget || 20;
            const excludeIds = new Set(yesterdayWrong.map(w => w.id));
            const candidates = words.filter(w => !excludeIds.has(w.id));
            const shuffled = [...candidates].sort(() => Math.random() - 0.5);
            const baseSelection = shuffled.slice(0, Math.min(baseTarget, shuffled.length));
            const combined = [...yesterdayWrong, ...baseSelection];
            if (combined.length === 0) {
                alert('ç›®å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯');
                return;
            }
            const session = [...combined].sort(() => Math.random() - 0.5);
            isReviewMode = true;
            isPracticeMode = false;
            clearTestProgress();
            testMode = mode;
            testSession = session;
            currentIndex = 0;
            currentMode = 'test';
            hintLevel = 0;
            wrongAttempts = [];
            prepareQuestion();
        }

        function closeReviewModeModal() {
            const modal = document.getElementById('review-mode-modal');
            if (modal) {
                modal.classList.add('hidden');
                toggleBodyScroll(false);
            }
        }

        function handleDailyReviewModeSelect(mode) {
            closeReviewModeModal();
            startDailyReview(mode);
        }

        function openDeleteAccountModal() {
            const modal = document.getElementById('delete-account-modal');
            if (modal) {
                modal.classList.remove('hidden');
                toggleBodyScroll(true);
            }
        }

        function closeDeleteAccountModal() {
            const modal = document.getElementById('delete-account-modal');
            if (modal) {
                modal.classList.add('hidden');
                toggleBodyScroll(false);
            }
        }

        function confirmDeleteAccount() {
            if (!currentUser) {
                closeDeleteAccountModal();
                return;
            }
            const id = currentUser.id;
            users = users.filter(u => u.id !== id);
            localStorage.setItem('danci_users', JSON.stringify(users));
            setCurrentUser(null);
            words = [];
            saveWords();
            clearTestProgress();
            reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
            saveReviewSettings();
            closeDeleteAccountModal();
            render();
            if (users.length === 0) {
                openAuthModal('register');
            } else {
                openAuthModal('login');
            }
        }

        function openClearWordsModal() {
            const modal = document.getElementById('clear-words-modal');
            if (modal) {
                modal.classList.remove('hidden');
                toggleBodyScroll(true);
            }
        }

        function closeClearWordsModal() {
            const modal = document.getElementById('clear-words-modal');
            if (modal) {
                modal.classList.add('hidden');
                toggleBodyScroll(false);
            }
        }

        function confirmClearWords() {
            words = [];
            saveWords();
            clearTestProgress();
            closeClearWordsModal();
            render();
        }

        function handleUpdateProfileName() {
            if (!currentUser) return;
            const input = document.getElementById('profile-name-input');
            if (!input) return;
            const newName = input.value.trim();
            if (!newName) {
                alert('æ˜µç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            currentUser.name = newName;
            const idx = users.findIndex(u => u.id === currentUser.id);
            if (idx !== -1) {
                users[idx] = currentUser;
                localStorage.setItem('danci_users', JSON.stringify(users));
            }
            updateGreeting();
            render();
            alert('æ˜µç§°å·²æ›´æ–°');
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                currentUser.avatar = base64;
                
                // Update local storage
                const idx = users.findIndex(u => u.id === currentUser.id);
                if (idx !== -1) {
                    users[idx] = currentUser;
                    localStorage.setItem('danci_users', JSON.stringify(users));
                }
                
                render(); 
            };
            reader.readAsDataURL(file);
        }

        function handleSaveReviewSettings() {
            const input = document.getElementById('review-daily-target-input');
            if (!input) return;
            let val = parseInt(input.value, 10);
            if (!val || val < 1) val = 10;
            if (val > 500) val = 500;
            reviewSettings.dailyTarget = val;
            saveReviewSettings();
            const display = document.getElementById('review-daily-target-display');
            if (display) display.textContent = String(val);
            alert('å·²æ›´æ–°æ¯æ—¥å¤ä¹ æ•°é‡');
        }

        function extractDefinition(text) {
            if (!text) return '';
            
            // æŒ‰è¡Œåˆ†å‰²
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // 1. è·³è¿‡åŒ…å«æ——å¸œæˆ–éŸ³æ ‡æ ‡è®°çš„è¡Œ
                if (line.includes('ğŸ‡ºğŸ‡¸') || line.includes('ğŸ‡¬ğŸ‡§') || line.includes('us ') || line.includes('uk ') || line.includes('ç¾ ') || line.includes('è‹± ')) continue;
                
                // 2. è·³è¿‡çº¯éŸ³æ ‡è¡Œ (ä»¥ [ æˆ– / å¼€å¤´)
                // æ³¨æ„ï¼šä¸èƒ½è¯¯ä¼¤ [n.] [v.] è¿™æ ·çš„è¯æ€§æ ‡è®°
                // éŸ³æ ‡é€šå¸¸æ˜¯ ['...'] æˆ– /.../ï¼Œè€Œè¯æ€§é€šå¸¸æ˜¯ [a-z.]
                if (/^\[\s*['"]/.test(line)) continue; // ['...] å½¢å¼
                if (/^\/\s*.*?\/\s*$/.test(line)) continue; // /.../ å½¢å¼
                
                // 3. å¦‚æœåŒ…å«ä¸­æ–‡ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šæ˜¯é‡Šä¹‰è¡Œ
                if (/[\u4e00-\u9fa5]/.test(line)) {
                    return line;
                }
                
                // 4. å¦‚æœæ˜¯ä»¥ [n.] [v.] ç­‰è¯æ€§å¼€å¤´çš„ï¼Œä¹Ÿæ˜¯é‡Šä¹‰
                if (/^\[[a-z]+\.?\]/i.test(line)) {
                    return line;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å¾è¡Œï¼Œå°è¯•è¿”å›ç¬¬ä¸€ä¸ªä¸åŒ…å«éŸ³æ ‡ç‰¹å¾çš„éç©ºè¡Œ
            const cleanLines = lines.map(l => l.trim()).filter(l => l && !l.includes('ğŸ‡ºğŸ‡¸') && !l.includes('ğŸ‡¬ğŸ‡§') && !/^\/\s*.*?\/\s*$/.test(l));
            return cleanLines.length > 0 ? cleanLines[0] : text;
        }

        async function prepareQuestion() {
            if (testMode === 'en-zh') {
                isLoadingOptions = true;
                render(); // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                
                try {
                    const word = testSession[currentIndex];
                    const correctDef = extractDefinition(word.chinese);

                    // ä»åç«¯è·å–3ä¸ªæ··æ·†é¡¹
                    const res = await fetch('http://localhost:3000/api/distractors?count=3');
                    let distractors = [];
                    if (res.ok) {
                        distractors = await res.json();
                    } else {
                        // å¤‡ç”¨æ··æ·†é¡¹
                        distractors = ['[n.] è‹¹æœ; æ°´æœ', '[v.] è·‘; è¿è¡Œ', '[adj.] å¿«ä¹çš„; å¹¸ç¦çš„']; 
                    }
                    
                    // ç»„åˆå¹¶æ‰“ä¹±
                    currentOptions = [correctDef, ...distractors].sort(() => Math.random() - 0.5);
                } catch (e) {
                    console.error("Failed to prepare options", e);
                    // å¤‡ç”¨æ··æ·†é¡¹ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                    const fallbackDistractors = [
                        '[n.] è‹¹æœ; æ°´æœ; ç»“æœ', 
                        '[v.] è·‘; è¿è¡Œ; ç®¡ç†', 
                        '[adj.] å¿«ä¹çš„; å¹¸ç¦çš„; æ»¡æ„çš„',
                        '[n.] æ—¶é—´; æ—¶åˆ»; æ¬¡æ•°',
                        '[v.] æ€è€ƒ; è®¤ä¸º; æƒ³è¦'
                    ];
                    // éšæœºå–3ä¸ª
                    const shuffled = fallbackDistractors.sort(() => Math.random() - 0.5).slice(0, 3);
                    
                    const word = testSession[currentIndex];
                    const correctDef = extractDefinition(word.chinese);
                    
                    currentOptions = [correctDef, ...shuffled].sort(() => Math.random() - 0.5);
                } finally {
                    isLoadingOptions = false;
                    render();
                }
            } else {
                render();
            }
        }

        function handleCheckAnswer(userVal = null) {
            try {
                if (userVal === null || userVal === undefined) {
                    const input = document.getElementById('test-input');
                    if (!input) return;
                    userVal = input.value.trim();
                } else {
                    userVal = String(userVal).trim();
                }

                const word = testSession[currentIndex];
                if (!word) return;

                let isCorrect = false;
                if (testMode === 'en-zh') {
                    // è‹±è¯‘æ±‰ï¼ˆé€‰æ‹©é¢˜ï¼‰ï¼šç²¾ç¡®åŒ¹é…
                    const correctDef = extractDefinition(word.chinese);
                    isCorrect = (userVal === correctDef);
                } else {
                    // æ±‰è¯‘è‹±ï¼šå¿½ç•¥å¤§å°å†™
                    isCorrect = userVal.toLowerCase() === word.english.trim().toLowerCase();
                }
                
                if (!isCorrect) {
                    const originalWord = words.find(w => w.id === word.id);
                    if (originalWord) {
                        originalWord.wrongCount = (originalWord.wrongCount || 0) + 1;
                        originalWord.lastWrongAt = getTodayDateStr();
                        saveWords();
                    }
                    if (!wrongAttempts.includes(word.id)) {
                        wrongAttempts.push(word.id);
                    }
                }
                
                handleShowAnswer(isCorrect);
            } catch (err) {
                console.error("ç­”é¢˜æ ¡éªŒå‡ºé”™:", err);
                alert("ç­”é¢˜è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
            }
        }

        function handleHint() {
            const word = testSession[currentIndex];
            hintLevel++;

            // å¦‚æœæ˜¯åœ¨æ¯æ—¥å¤ä¹ çš„æ±‰è¯‘è‹±æ¨¡å¼ä¸‹ä½¿ç”¨äº†æç¤ºï¼Œè‡ªåŠ¨è®°å½•ä¸ºé”™é¢˜
            if (isReviewMode && testMode === 'zh-en') {
                const originalWord = words.find(w => w.id === word.id);
                if (originalWord) {
                    // æ ‡è®°ä¸ºä»Šæ—¥é”™è¯¯ï¼Œè¿™æ ·æ˜å¤©å¤ä¹ æ—¶ä¼šä¼˜å…ˆå‡ºç°
                    originalWord.wrongCount = (originalWord.wrongCount || 0) + 1;
                    originalWord.lastWrongAt = getTodayDateStr();
                    saveWords();
                }
                if (!wrongAttempts.includes(word.id)) {
                    wrongAttempts.push(word.id);
                }
            }

            const hintText = word.english.split('').map((char, index) => {
                if (index < hintLevel) return char;
                if (char === ' ') return ' ';
                return '_';
            }).join(' ');
            
            const hintDisplay = document.getElementById('hint-display');
            if (hintDisplay) {
                hintDisplay.innerText = hintText;
                hintDisplay.classList.remove('hidden');
            }
        }

        function handleShowAnswer(isCorrect = null) {
            const word = testSession[currentIndex];
            let answer = '';
            if (testMode === 'en-zh') {
                const cleaned = cleanDefinitions(word.chinese);
                answer = cleaned || extractDefinition(word.chinese);
            } else {
                answer = word.english;
            }
            const area = document.getElementById('test-form-area');
            const questionArea = document.getElementById('test-question-area');
            
            // è¿™é‡Œçš„åé¦ˆéœ€è¦åšå¾—æ›´â€œé«˜çº§â€
            if (isCorrect === true) {
                // æ­£ç¡®æ—¶çš„åé¦ˆ
                area.innerHTML = `
                    <div class="space-y-8 fade-in text-center">
                        <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 mb-2 border-4 border-green-100 dark:border-green-900/30">
                            <span class="text-5xl">âœ¨</span>
                        </div>
                        <div>
                            <div class="text-sm font-black text-green-600 dark:text-green-400 uppercase tracking-widest mb-2">å¤ªæ£’äº†ï¼å›ç­”æ­£ç¡®</div>
                            <div class="text-4xl font-black text-slate-800 dark:text-slate-100 whitespace-pre-line">${answer}</div>
                        </div>
                        <button onclick="handleNextWord()" class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-black py-6 rounded-[2rem] shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3 group">
                            <span class="text-xl">ç»§ç»­æŒ‘æˆ˜</span>
                            <span class="group-hover:translate-x-1 transition-transform">â¡ï¸</span>
                        </button>
                    </div>
                `;
            } else {
                // é”™è¯¯æ—¶çš„åé¦ˆ
                area.innerHTML = `
                    <div class="space-y-8 fade-in">
                        <div class="p-10 bg-red-50 dark:bg-red-900/10 rounded-[2.5rem] border-2 border-red-100 dark:border-red-900/20 text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 mb-6">
                                <span class="text-2xl">ğŸ’¡</span>
                            </div>
                            <div class="text-sm font-black text-red-600 dark:text-red-400 uppercase tracking-widest mb-2">åˆ«ç°å¿ƒï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯</div>
                            <div class="text-4xl font-black text-slate-800 dark:text-slate-100 mb-4 whitespace-pre-line">${answer}</div>
                            <p class="text-red-400 font-medium">æ­¤é¢˜å·²åŠ å…¥é”™é¢˜æœ¬ï¼Œç¨åä¼šè‡ªåŠ¨å¼ºåŒ–</p>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="render()" class="flex-1 py-5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-2 border-slate-100 dark:border-slate-700 rounded-2xl font-bold hover:bg-slate-50 transition-all">å†çœ‹ä¸€çœ¼</button>
                            <button onclick="handleNextWord()" class="flex-[2] py-5 bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-black rounded-2xl shadow-xl hover:scale-[1.02] transition-all">è·³è¿‡æ­¤é¢˜</button>
                        </div>
                    </div>
                `;
            }
        }

        function handleNextWord() {
            if (currentIndex < testSession.length - 1) {
                currentIndex++;
                hintLevel = 0;
                prepareQuestion();
            } else {
                if (isReviewMode) {
                    const today = getTodayDateStr();
                    reviewSettings.lastReviewDate = today;
                    saveReviewSettings();
                    isReviewMode = false;
                }
                currentMode = 'test_result';
                clearTestProgress();
                render();
            }
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            // Center the ripple (firework from center)
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${button.clientWidth / 2 - radius}px`;
            circle.style.top = `${button.clientHeight / 2 - radius}px`;
            circle.classList.add("ripple");

            // Remove existing ripples
            const existingRipple = button.getElementsByClassName("ripple")[0];
            if (existingRipple) {
                existingRipple.remove();
            }

            button.appendChild(circle);

            // Auto cleanup
            setTimeout(() => {
                circle.remove();
            }, 600);
        }

        // åˆå§‹åŒ–
        initAuth();
        render();
    </script>
    <div id="export-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeExportModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-2xl md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6 flex flex-col max-h-[85vh]">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">å¯¼å‡ºé€‰é¡¹</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mt-1">è‡ªå®šä¹‰å¯¼å‡ºå†…å®¹å’Œå•è¯</p>
                </div>
                <button onclick="closeExportModal()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto space-y-6 pr-2 custom-scrollbar">
                <!-- Content Options -->
                <div class="space-y-3">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">å¯¼å‡ºå†…å®¹</div>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="opt-phonetic" name="export-option" checked class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">éŸ³æ ‡</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="opt-definition" name="export-option" checked class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">é‡Šä¹‰</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="opt-examples" name="export-option" checked class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">ä¾‹å¥</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="opt-collocations" name="export-option" checked class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">æ­é…</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 cursor-pointer hover:border-indigo-500 transition-colors">
                            <input type="checkbox" id="opt-idioms" name="export-option" checked class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">ä¿—è¯­</span>
                        </label>
                    </div>
                </div>

                <!-- Word Selection -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">é€‰æ‹©å•è¯</div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="export-select-all" checked onchange="toggleExportSelectAll()" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs font-bold text-indigo-600">å…¨é€‰</span>
                        </label>
                    </div>
                    <div id="export-word-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar p-1">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>

            <div class="flex gap-4 pt-2">
                <button onclick="closeExportModal()" class="flex-1 py-3 rounded-xl font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">å–æ¶ˆ</button>
                <button onclick="confirmExport()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all">ç¡®è®¤å¯¼å‡º</button>
            </div>
        </div>
    </div>
</body>
</html>
                                                                                                                                                         
