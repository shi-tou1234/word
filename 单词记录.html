<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯åŠ©æ‰‹ - è½»æ¾èƒŒå•è¯</title>
    <!-- ä»…ä¿ç•™ Tailwind CSSï¼Œè¿™æ˜¯æœ€å¯é çš„ UI åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .dark {
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0, transparent 50%),
                radial-gradient(at 0% 100%, rgba(236, 72, 153, 0.15) 0, transparent 50%);
            background-attachment: fixed;
        }

        .dark body {
            background-color: #020617;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0, transparent 50%),
                radial-gradient(at 0% 100%, rgba(236, 72, 153, 0.1) 0, transparent 50%);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .nav-pill {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-active {
            background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }

        .premium-input {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            color: #0f172a; /* Slate 900 */
        }
        
        .dark .premium-input {
            background: rgba(30, 41, 59, 0.8);
            color: #f1f5f9; /* Slate 100 */
        }

        .premium-input:focus {
            background: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .dark .premium-input:focus {
            background: #1e293b;
            border-color: #818cf8;
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1);
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
        }

        /* åŠ¨ç”» */
        .animate-enter {
            animation: enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes enter {
            to { opacity: 1; transform: translateY(0); }
        }

        .hover-scale {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .hover-scale:active {
            transform: scale(0.95);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.5);
        }
        
        .greeting-text {
            font-weight: 700;
            letter-spacing: 0.08em;
            animation: greeting-color 6s ease-in-out infinite;
        }
        
        @keyframes greeting-color {
            0% { color: #6366f1; }
            33% { color: #22c55e; }
            66% { color: #f97316; }
            100% { color: #6366f1; }
        }
        
        .button-soft {
            transition: all 0.25s ease;
            transform-origin: center;
        }
        
        .button-soft:hover {
            filter: brightness(1.05);
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            transform: translateY(-1px) scale(1.01);
        }
        
        .button-soft:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.2);
        }
        
        .dark .border-slate-700,
        .dark .border-slate-800,
        .dark .border-indigo-900\/40,
        .dark .border-white\/20 {
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark .word-card {
            border-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 20px 45px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body class="min-h-screen text-slate-800 dark:text-slate-200 transition-colors duration-500 selection:bg-indigo-500 selection:text-white relative">
    <div class="theme-toggle">
        <button onclick="toggleTheme()" class="p-3 rounded-full bg-white/80 dark:bg-slate-800/80 shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all active:scale-95 backdrop-blur-sm group">
            <span id="theme-icon" class="text-xl block group-hover:rotate-12 transition-transform">ğŸŒ</span>
        </button>
    </div>
    <div class="max-w-4xl mx-auto p-6 md:p-8 lg:p-12">
        <!-- å¤´éƒ¨ -->
        <header class="mb-12 animate-enter text-left" style="animation-delay: 0.1s">
            <div class="relative flex items-center justify-start mb-4 group hover-scale cursor-default w-20 h-20">
                <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full group-hover:opacity-30 transition-opacity"></div>
                <div class="relative w-20 h-20 rounded-3xl bg-gradient-to-br from-indigo-500/90 via-sky-500/90 to-purple-500/90 dark:from-indigo-500 dark:via-sky-500 dark:to-purple-500 backdrop-blur-xl shadow-xl border border-white/40 dark:border-slate-700/50 text-white flex items-center justify-center">
                    <svg class="w-9 h-9 drop-shadow-md" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold mb-1 tracking-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 dark:from-indigo-400 dark:via-purple-400 dark:to-blue-400">å•è¯åŠ©æ‰‹</span>
            </h1>
            <p id="user-greeting" class="greeting-text text-5xl md:text-6xl mb-2 text-indigo-500 dark:text-indigo-300"></p>
            <p class="text-slate-500 dark:text-slate-400 font-semibold text-base tracking-[0.2em] uppercase opacity-80 mb-4">Premium Vocabulary Builder</p>
            <p id="daily-quote" class="text-indigo-500 dark:text-indigo-400 font-bold text-xl transition-all duration-500">âœ¨ ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ âœ¨</p>
        </header>

        <!-- å¯¼èˆªæ  -->
        <nav class="flex flex-wrap justify-center gap-3 mb-10 animate-enter" style="animation-delay: 0.2s" id="nav">
            <button onclick="switchMode('input')" id="btn-input" class="nav-pill flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm md:text-base hover:bg-white/60 dark:hover:bg-slate-800/70 hover:shadow-lg transition-all nav-active">
                <span>âœ¨</span> å½•å…¥æ–°è¯
            </button>
            <button onclick="switchMode('list')" id="btn-list" class="nav-pill flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800/70 hover:shadow-lg transition-all">
                <span>ğŸ“š</span> è¯åº“ (<span id="count">0</span>)
            </button>
            <button onclick="switchMode('test_select')" id="btn-test" class="nav-pill flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800/70 hover:shadow-lg transition-all">
                <span>ğŸ§ </span> è®°å¿†æŒ‘æˆ˜
            </button>
            <button onclick="switchMode('daily_review')" id="btn-review" class="nav-pill flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800/70 hover:shadow-lg transition-all">
                <span>ğŸ“†</span> æ¯æ—¥å¤ä¹ 
            </button>
            <button onclick="switchMode('profile')" id="btn-profile" class="nav-pill flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-sm md:text-base text-slate-600 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-slate-800/70 hover:shadow-lg transition-all">
                <span>
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A8 8 0 0112 14a8 8 0 016.879 3.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </span>
                æˆ‘çš„
            </button>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main id="main-content" class="animate-enter bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-900/50 border border-slate-200 dark:border-slate-700 shadow-xl p-6 md:p-10 rounded-[2rem] min-h-[400px]" style="animation-delay: 0.3s">
            <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
        </main>
        
        <footer class="mt-16 text-center text-slate-400 dark:text-slate-600 text-xs font-medium animate-enter" style="animation-delay: 0.4s">
            <p>Â©  å•è¯åŠ©æ‰‹ Â·  åˆ¶ä½œäººcmchen</p>
        </footer>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-2xl md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl overflow-hidden transform transition-all scale-100 p-8 border border-white/20">
            <button onclick="closeModal()" class="absolute top-6 right-6 p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors z-10">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div id="modal-content" class="max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- Content injected here -->
            </div>
        </div>
    </div>
    
    <div id="auth-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-md md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 id="auth-title" class="text-2xl font-black text-slate-900 dark:text-white mb-1">æ¬¢è¿å›æ¥</h2>
                    <p id="auth-subtitle" class="text-slate-500 dark:text-slate-400 text-sm font-medium">ç™»å½•ä½ çš„è´¦å·ç»§ç»­å­¦ä¹ </p>
                </div>
                <button onclick="closeAuthModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <form onsubmit="handleAuthSubmit(event)" class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">è´¦å·</label>
                    <input id="auth-account" type="text" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·è¾“å…¥ç™»å½•è´¦å·">
                </div>
                <div id="auth-name-group" class="space-y-2 hidden">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">æ˜µç§°</label>
                    <input id="auth-name" type="text" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æ˜µç§°">
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">å¯†ç </label>
                    <input id="auth-password" type="password" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div id="auth-confirm-password-group" class="space-y-2 hidden">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">ç¡®è®¤å¯†ç </label>
                    <input id="auth-confirm-password" type="password" class="premium-input w-full p-3 rounded-xl text-sm font-medium" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <button type="submit" class="button-soft w-full py-3 rounded-2xl bg-gradient-to-r from-indigo-600 via-purple-600 to-sky-500 text-white font-bold shadow-lg hover:shadow-xl">
                    ç¡®è®¤
                </button>
            </form>
            <button id="auth-toggle" type="button" onclick="toggleAuthMode()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ
            </button>
        </div>
    </div>
    
    <div id="guide-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-xl md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-2">æ¬¢è¿ä½¿ç”¨å•è¯åŠ©æ‰‹</h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-4">ç®€å•å‡ æ­¥ï¼Œå¿«é€Ÿä¸Šæ‰‹æœ€è¿‘æ›´æ–°çš„åŠŸèƒ½ï¼š</p>
            <ul class="text-sm text-slate-600 dark:text-slate-300 space-y-2 text-left">
                <li>1. åœ¨ã€Œå½•å…¥æ–°è¯ã€ä¸­è¾“å…¥è‹±æ–‡å•è¯ï¼Œä¸€é”®è·å–æ™ºèƒ½é‡Šä¹‰å’Œç¾å¼éŸ³æ ‡ã€‚</li>
                <li>2. åœ¨ã€Œè¯åº“ã€é‡ŒæŸ¥çœ‹ç²¾ç¾å•è¯å¡ç‰‡ï¼Œæ”¯æŒéŸ³æ ‡ã€ä¾‹å¥ã€‚</li>
                <li>3. è¿›å…¥ã€Œè®°å¿†æŒ‘æˆ˜ã€ï¼Œç”¨è‹±è¯‘æ±‰é€‰æ‹©é¢˜å’Œæ±‰è¯‘è‹±æ‹¼å†™é¢˜å¼ºåŒ–è®°å¿†ã€‚</li>
                <li>4. å¼€å¯ã€Œæ¯æ—¥å¤ä¹ è®¡åˆ’ã€ï¼Œæ¯å¤©è‡ªåŠ¨æé†’å¤ä¹ ï¼Œå¹¶ä¼˜å…ˆå®‰æ’æ˜¨æ—¥é”™é¢˜ã€‚</li>
                <li>5. åœ¨ã€Œæˆ‘çš„ã€ä¸­è®¾ç½®æ¯æ—¥å¤ä¹ æ•°é‡ï¼Œè¿˜å¯ä»¥å¯¼å‡º Word æ–‡æ¡£éšæ—¶å¤ä¹ ã€‚</li>
                <li>6. ç™»å½•åŒä¸€è´¦å·ï¼Œå³å¯åœ¨ä¸åŒè®¾å¤‡åŒæ­¥ä½ çš„ä¸“å±è¯åº“å’Œè¿›åº¦ã€‚</li>
            </ul>
            <button onclick="closeGuideModal()" class="button-soft w-full py-3 mt-2 rounded-2xl bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold shadow-lg hover:shadow-xl">
                æˆ‘çŸ¥é“äº†ï¼Œå¼€å§‹ä½¿ç”¨
            </button>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 z-[115] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeReviewModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-md md:mx-auto bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-8 space-y-6">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-1">ä»Šæ—¥å¤ä¹ è®¡åˆ’</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">åšæŒä¸€ç‚¹ç‚¹ï¼Œæ¯å¤©éƒ½ä¼šæ›´å‰å®³</p>
                </div>
                <button onclick="closeReviewModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl p-4 text-sm text-slate-700 dark:text-slate-200">
                <p>ä»Šå¤©å»ºè®®å¤ä¹  <span id="review-total-count" class="font-bold text-indigo-600 dark:text-indigo-400">0</span> ä¸ªå•è¯ï¼Œå…¶ä¸­æ˜¨æ—¥é”™é¢˜ <span id="review-yesterday-count" class="font-bold text-rose-500">0</span> ä¸ªã€‚</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button onclick="startDailyReview('en-zh')" class="button-soft w-full py-3 rounded-2xl bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <span>è‹±è¯‘æ±‰å¤ä¹ </span>
                </button>
                <button onclick="startDailyReview('zh-en')" class="button-soft w-full py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold shadow-lg hover:shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center gap-2">
                    <span>æ±‰è¯‘è‹±å¤ä¹ </span>
                </button>
            </div>
            <button onclick="closeReviewModal()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                ç¨åå†è¯´
            </button>
        </div>
    </div>

    <div id="review-mode-modal" class="fixed inset-0 z-[116] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeReviewModeModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">é€‰æ‹©å¤ä¹ æ¨¡å¼</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æŒ‰ä½ çš„ä¹ æƒ¯é€‰æ‹©ä¸€ç§æ–¹å¼å¼€å§‹å¤ä¹ </p>
                </div>
                <button onclick="closeReviewModeModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="handleDailyReviewModeSelect('en-zh')" class="button-soft w-full py-3 rounded-2xl bg-slate-900 dark:bg-indigo-500 text-white font-bold shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <span>è‹±è¯‘æ±‰ Â· é€‰æ‹©é¢˜</span>
                </button>
                <button onclick="handleDailyReviewModeSelect('zh-en')" class="button-soft w-full py-3 rounded-2xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold shadow-lg hover:shadow-xl border border-slate-100 dark:border-slate-700 flex items-center justify-center gap-2">
                    <span>æ±‰è¯‘è‹± Â· æ‹¼å†™é¢˜</span>
                </button>
            </div>
            <button onclick="closeReviewModeModal()" class="w-full text-xs font-bold text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors">
                å…ˆç­‰ç­‰ï¼Œå†å‡†å¤‡ä¸€ä¸‹
            </button>
        </div>
    </div>

    <div id="delete-account-modal" class="fixed inset-0 z-[117] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeDeleteAccountModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">åˆ é™¤è´¦å·</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æ­¤æ“ä½œä¼šåŒæ—¶æ¸…ç©ºè¯¥è´¦å·ä¸‹çš„è¯åº“å’Œè¿›åº¦</p>
                </div>
                <button onclick="closeDeleteAccountModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">ç¡®å®šè¦åˆ é™¤å½“å‰è´¦å·å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmDeleteAccount()" class="button-soft py-3 rounded-2xl bg-rose-600 text-white font-bold shadow-lg hover:bg-rose-700 hover:shadow-rose-500/40 text-sm">æ˜¯çš„ï¼Œåˆ é™¤</button>
                <button onclick="closeDeleteAccountModal()" class="button-soft py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold text-sm">å†æƒ³æƒ³</button>
            </div>
        </div>
    </div>

    <div id="clear-words-modal" class="fixed inset-0 z-[118] hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeClearWordsModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-sm md:mx-auto bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl border border-white/20 dark:border-slate-700/80 p-7 space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-black text-slate-900 dark:text-white mb-1">æ¸…ç©ºè¯åº“</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-medium">æ­¤æ“ä½œä¼šåˆ é™¤å½“å‰è´¦å·ä¸‹çš„æ‰€æœ‰å•è¯</p>
                </div>
                <button onclick="closeClearWordsModal()" class="p-2 rounded-full text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">ç¡®å®šè¦ä¸€é”®æ¸…ç©ºè¯åº“å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmClearWords()" class="button-soft py-3 rounded-2xl bg-rose-600 text-white font-bold shadow-lg hover:bg-rose-700 hover:shadow-rose-500/40 text-sm">æ˜¯çš„ï¼Œæ¸…ç©º</button>
                <button onclick="closeClearWordsModal()" class="button-soft py-3 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-100 font-bold text-sm">å†æƒ³æƒ³</button>
            </div>
        </div>
    </div>

    <script>
        // --- ä¸»é¢˜ç®¡ç† ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const btn = document.getElementById('theme-icon');
            if (btn) {
                const isDark = document.documentElement.classList.contains('dark');
                btn.innerText = isDark ? 'ğŸŒ™' : 'ğŸŒ';
            }
        }
        
        // ç«‹å³åˆå§‹åŒ–
        initTheme();

        // --- çŠ¶æ€ç®¡ç† ---
        let users = [];
        let currentUser = null;
        let words = [];
        let currentMode = 'input';
        let testMode = 'en-zh';
        let currentIndex = 0;
        let showAnswer = false;
        let hintLevel = 0;
        let testSession = [];
        let wrongAttempts = [];
        let isPracticeMode = false;
        let currentOptions = [];
        let isLoadingOptions = false;
        let tempWordData = null;
        let authMode = 'login';
        let reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
        let isReviewMode = false;
        
        function getWordsStorageKey() {
            if (currentUser && currentUser.id) {
                return 'danci_words_' + currentUser.id;
            }
            return 'danci_words_guest';
        }
        
        function getTestProgressKey() {
            if (currentUser && currentUser.id) {
                return 'danci_test_progress_' + currentUser.id;
            }
            return 'danci_test_progress_guest';
        }

        function getReviewSettingsKey() {
            if (currentUser && currentUser.id) {
                return 'danci_review_settings_' + currentUser.id;
            }
            return 'danci_review_settings_guest';
        }

        function loadReviewSettingsForCurrentUser() {
            try {
                const stored = localStorage.getItem(getReviewSettingsKey());
                reviewSettings = stored ? JSON.parse(stored) : { dailyTarget: 20, lastReviewDate: '' };
            } catch (e) {
                reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
            }
        }

        function saveReviewSettings() {
            localStorage.setItem(getReviewSettingsKey(), JSON.stringify(reviewSettings));
        }

        function getTodayDateStr() {
            const d = new Date();
            return d.toISOString().slice(0, 10);
        }

        function getYesterdayDateStr() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return d.toISOString().slice(0, 10);
        }
        
        function loadWordsForCurrentUser() {
            const key = getWordsStorageKey();
            try {
                const stored = localStorage.getItem(key);
                words = stored ? JSON.parse(stored) : [];
            } catch (e) {
                words = [];
            }
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
        }
        
        function saveWords() {
            const key = getWordsStorageKey();
            localStorage.setItem(key, JSON.stringify(words));
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
        }
        
        function getYesterdayWrongWords() {
            const y = getYesterdayDateStr();
            return words.filter(w => w.lastWrongAt === y);
        }
        
        function updateGreeting() {
            const el = document.getElementById('user-greeting');
            if (!el) return;
            if (currentUser) {
                const name = currentUser.name || currentUser.account;
                el.textContent = `ä½ å¥½ï¼Œ${name}`;
                el.style.display = 'block';
            } else {
                el.textContent = '';
                el.style.display = 'none';
            }
        }
        
        // --- é¼“åŠ±è¯­ ---
        const quotes = [
            "ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ã€‚",
            "åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚",
            "ä¸è¦çœ‹ç€é’Ÿè¡¨ï¼Œåƒå®ƒä¸€æ ·ï¼ŒåšæŒå‘å‰ã€‚",
            "æˆåŠŸæ˜¯æ¯å¤©é‡å¤çš„å°å°åŠªåŠ›çš„æ€»å’Œã€‚",
            "é™åˆ¶ä½ çš„åªæœ‰ä½ çš„æƒ³è±¡åŠ›ã€‚",
            "ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜¯æ˜å¤©æˆåŠŸçš„åŸºçŸ³",
            "ä¼Ÿå¤§çš„äº‹ç‰©ä»æœªè¯ç”Ÿäºèˆ’é€‚åœˆã€‚",
            "æœ‰æ¢¦æƒ³ï¼Œå°±å»è¿½ï¼Œå»å®ç°ã€‚",
            "æˆåŠŸä¸ä¼šä¸»åŠ¨æ‰¾ä½ ï¼Œä½ å¾—å»å¯»æ‰¾å®ƒã€‚",
            "è¶ŠåŠªåŠ›ï¼Œè¶Šå¹¸è¿ã€‚"
        ];

        function updateQuote() {
            const quoteEl = document.getElementById('daily-quote');
            if (quoteEl) {
                // ç®€å•çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ
                quoteEl.style.opacity = 0;
                setTimeout(() => {
                    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                    quoteEl.innerText = `âœ¨ ${randomQuote} âœ¨`;
                    quoteEl.style.opacity = 1;
                }, 200);
            }
        }

        // --- è¿›åº¦ä¿å­˜é€»è¾‘ ---
        function saveTestProgress() {
            const progress = {
                testSession,
                currentIndex,
                wrongAttempts,
                testMode,
                isPracticeMode,
                timestamp: Date.now()
            };
            localStorage.setItem(getTestProgressKey(), JSON.stringify(progress));
        }

        function loadTestProgress() {
            try {
                const saved = localStorage.getItem(getTestProgressKey());
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                return null;
            }
        }

        function clearTestProgress() {
            localStorage.removeItem(getTestProgressKey());
        }

        function handleInterruptTest() {
            if (currentMode === 'test' && currentIndex < testSession.length) {
                saveTestProgress();
            }
            switchMode('test_select');
        }
        
        function handleResumeTest() {
            const progress = loadTestProgress();
            if (progress) {
                testSession = progress.testSession;
                currentIndex = progress.currentIndex;
                wrongAttempts = progress.wrongAttempts;
                testMode = progress.testMode;
                isPracticeMode = progress.isPracticeMode;
                currentMode = 'test';
                hintLevel = 0;
                prepareQuestion();
            }
        }
        
        function setCurrentUser(user) {
            currentUser = user;
            if (user && user.id) {
                localStorage.setItem('danci_current_user_id', String(user.id));
            } else {
                localStorage.removeItem('danci_current_user_id');
            }
            loadWordsForCurrentUser();
            updateGreeting();
            loadReviewSettingsForCurrentUser();
        }
        
        function openAuthModal(mode) {
            authMode = mode;
            const modal = document.getElementById('auth-modal');
            if (!modal) return;
            const titleEl = document.getElementById('auth-title');
            const subtitleEl = document.getElementById('auth-subtitle');
            const nameGroup = document.getElementById('auth-name-group');
            const toggleEl = document.getElementById('auth-toggle');
            const confirmGroup = document.getElementById('auth-confirm-password-group');
            
            if (mode === 'register') {
                if (titleEl) titleEl.textContent = 'æ¬¢è¿åŠ å…¥å•è¯åŠ©æ‰‹';
                if (subtitleEl) subtitleEl.textContent = 'åˆ›å»ºä½ çš„è´¦å·ï¼Œå¼€å§‹ä¸“å±è®°å¿†ä¹‹æ—…';
                if (nameGroup) nameGroup.classList.remove('hidden');
                if (confirmGroup) confirmGroup.classList.remove('hidden');
                if (toggleEl) toggleEl.textContent = 'å·²æœ‰è´¦å·ï¼Ÿå‰å¾€ç™»å½•';
            } else {
                if (titleEl) titleEl.textContent = 'æ¬¢è¿å›æ¥';
                if (subtitleEl) subtitleEl.textContent = 'ç™»å½•ä½ çš„è´¦å·ç»§ç»­å­¦ä¹ ';
                if (nameGroup) nameGroup.classList.add('hidden');
                if (confirmGroup) confirmGroup.classList.add('hidden');
                if (toggleEl) toggleEl.textContent = 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ';
            }
            modal.classList.remove('hidden');
        }
        
        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        function toggleAuthMode() {
            const nextMode = authMode === 'login' ? 'register' : 'login';
            openAuthModal(nextMode);
        }
        
        function handleAuthSubmit(e) {
            if (e) e.preventDefault();
            const accountInput = document.getElementById('auth-account');
            const nameInput = document.getElementById('auth-name');
            const passwordInput = document.getElementById('auth-password');
            const confirmInput = document.getElementById('auth-confirm-password');
            
            if (!accountInput || !passwordInput) return;
            
            const account = accountInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!account || !password) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„è´¦å·å’Œå¯†ç ');
                return;
            }
            
            if (authMode === 'register') {
                const displayName = nameInput ? nameInput.value.trim() : '';
                const confirmPwd = confirmInput ? confirmInput.value.trim() : '';
                if (!displayName) {
                    alert('è¯·å¡«å†™æ˜µç§°');
                    return;
                }
                if (!confirmPwd || confirmPwd !== password) {
                    alert('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
                    return;
                }
                const exists = users.find(u => u.account === account);
                if (exists) {
                    alert('è¯¥è´¦å·å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•');
                    openAuthModal('login');
                    return;
                }
                const newUser = {
                    id: Date.now(),
                    account,
                    name: displayName,
                    password
                };
                users.push(newUser);
                localStorage.setItem('danci_users', JSON.stringify(users));
                setCurrentUser(newUser);
                closeAuthModal();
                showGuideForCurrentUser();
            } else {
                const user = users.find(u => u.account === account && u.password === password);
                if (!user) {
                    alert('è´¦å·æˆ–å¯†ç é”™è¯¯');
                    return;
                }
                setCurrentUser(user);
                closeAuthModal();
                const guideKey = 'danci_user_guide_seen_' + user.id;
                const seen = localStorage.getItem(guideKey);
                if (!seen) {
                    showGuideForCurrentUser();
                }
            }
            
            accountInput.value = '';
            if (nameInput) nameInput.value = '';
            passwordInput.value = '';
            if (confirmInput) confirmInput.value = '';
            saveWords();
            render();
        }
        
        function handleLogout() {
            setCurrentUser(null);
            words = [];
            saveWords();
            render();
            if (users.length === 0) {
                openAuthModal('register');
            } else {
                openAuthModal('login');
            }
        }
        
        function showGuideForCurrentUser() {
            if (!currentUser || !currentUser.id) return;
            const key = 'danci_user_guide_seen_' + currentUser.id;
            localStorage.setItem(key, '1');
            const modal = document.getElementById('guide-modal');
            if (modal) modal.classList.remove('hidden');
        }
        
        function closeGuideModal() {
            const modal = document.getElementById('guide-modal');
            if (modal) modal.classList.add('hidden');
        }
        
        function initAuth() {
            try {
                users = JSON.parse(localStorage.getItem('danci_users') || '[]');
            } catch (e) {
                users = [];
            }
            const savedId = localStorage.getItem('danci_current_user_id');
            if (savedId) {
                const user = users.find(u => String(u.id) === savedId);
                if (user) {
                    currentUser = user;
                }
            }
            if (!currentUser && users.length > 0) {
                openAuthModal('login');
            }
            if (!currentUser && users.length === 0) {
                openAuthModal('register');
            }
            loadWordsForCurrentUser();
            updateGreeting();
            if (currentUser) {
                loadReviewSettingsForCurrentUser();
                setTimeout(() => {
                    maybeShowReviewModal();
                }, 800);
            }
        }

        // --- Word Export ---
        function exportToWord() {
            if (words.length === 0) {
                alert('è¯åº“ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
                return;
            }

            let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset="utf-8">
                <title>å•è¯å¯¼å‡º</title>
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    .word-entry { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
                    .word { font-size: 24px; font-weight: bold; color: #2c3e50; }
                    .phonetic { color: #7f8c8d; font-family: 'Arial', sans-serif; margin-left: 10px; }
                    .section-title { font-size: 14px; font-weight: bold; color: #95a5a6; margin-top: 10px; text-transform: uppercase; }
                    .definition { margin-top: 5px; color: #34495e; line-height: 1.4; }
                    .example { margin-top: 5px; font-style: italic; color: #7f8c8d; border-left: 2px solid #3498db; padding-left: 10px; }
                    .collocation { display: inline-block; background: #ecf0f1; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 12px; color: #2c3e50; }
                    .idiom { margin-top: 4px; color: #d35400; }
                </style>
            </head>
            <body>
                <h1>æˆ‘çš„å•è¯æœ¬ (${new Date().toLocaleDateString()})</h1>
            `;

            words.forEach(word => {
                let details = '';
                
                // Definitions
                if (word.definitions && word.definitions.length > 0) {
                    word.definitions.forEach(d => {
                        details += `<div class="definition"><strong>[${d.pos}]</strong> ${d.def}</div>`;
                    });
                } else {
                    details += `<div class="definition">${word.chinese.replace(/\n/g, '<br>')}</div>`;
                }

                // Examples
                if (word.examples && word.examples.length > 0) {
                    details += `<div class="section-title">Examples</div>`;
                    word.examples.forEach(ex => {
                        details += `<div class="example">${ex.en}<br>${ex.cn}</div>`;
                    });
                }

                // Collocations
                if (word.collocations && word.collocations.length > 0) {
                    details += `<div class="section-title">Collocations</div><div>`;
                    word.collocations.forEach(c => {
                        details += `<span class="collocation">${c}</span>`;
                    });
                    details += `</div>`;
                }

                // Idioms
                if (word.idioms && word.idioms.length > 0) {
                    details += `<div class="section-title">Idioms & Slang</div>`;
                    word.idioms.forEach(i => {
                        details += `<div class="idiom">${i}</div>`;
                    });
                }

                htmlContent += `
                <div class="word-entry">
                    <div class="word">${word.english} <span class="phonetic">${word.phonetic_us ? `/${word.phonetic_us}/` : ''}</span></div>
                    ${details}
                </div>`;
            });

            htmlContent += '</body></html>';

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å•è¯æœ¬_${new Date().toLocaleDateString()}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- Core Logic ---
        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
        }

        function showWordDetails(id) {
            const word = words.find(w => w.id === id);
            if (!word) return;
            
            // æ„å»ºå†…å®¹
            let detailsHtml = '';

            // 1. é‡Šä¹‰ (å¦‚æœæœ‰ç»“æ„åŒ–æ•°æ®)
            if (word.definitions && word.definitions.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Definitions</h3><div class="space-y-3">`;
                word.definitions.forEach(d => {
                    detailsHtml += `<div class="flex gap-3"><span class="px-2 py-0.5 rounded-md bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold text-xs h-fit whitespace-nowrap">${d.pos}</span><span class="text-slate-700 dark:text-slate-300 font-medium">${d.def}</span></div>`;
                });
                detailsHtml += `</div></div>`;
            } else {
                // æ—§æ•°æ®å›é€€
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Meaning</h3><div class="text-lg leading-relaxed whitespace-pre-line font-medium text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">${word.chinese}</div></div>`;
            }

            // 2. ä¾‹å¥
            if (word.examples && word.examples.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Examples</h3><div class="space-y-4">`;
                word.examples.forEach(ex => {
                    detailsHtml += `<div class="pl-4 border-l-2 border-indigo-200 dark:border-indigo-900"><div class="text-slate-800 dark:text-slate-200 font-medium mb-1">${ex.en}</div><div class="text-slate-500 dark:text-slate-400 text-sm">${ex.cn}</div></div>`;
                });
                detailsHtml += `</div></div>`;
            }

            // 3. å›ºå®šæ­é…
            if (word.collocations && word.collocations.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Collocations</h3><div class="flex flex-wrap gap-2">`;
                word.collocations.forEach(c => {
                    detailsHtml += `<span class="px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-medium text-sm">${c}</span>`;
                });
                detailsHtml += `</div></div>`;
            }

            // 4. ä¿—è¯­/çŸ­è¯­
            if (word.idioms && word.idioms.length > 0) {
                detailsHtml += `<div class="mb-6"><h3 class="text-sm font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Idioms & Slang</h3><div class="grid grid-cols-1 gap-3">`;
                word.idioms.forEach(i => {
                    detailsHtml += `<div class="p-3 rounded-xl bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400 font-medium border border-amber-100 dark:border-amber-900/20">${i}</div>`;
                });
                detailsHtml += `</div></div>`;
            }

            const content = `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-black text-slate-900 dark:text-white mb-3 tracking-tight">${word.english}</h2>
                    ${word.phonetic_us ? `<div class="inline-flex items-center gap-2 px-4 py-2 mb-4 rounded-full bg-indigo-600/10 dark:bg-indigo-500/15 text-indigo-700 dark:text-indigo-200 font-medium shadow-sm">
                        <span class="text-xs font-bold tracking-[0.2em] uppercase text-indigo-500/90 dark:text-indigo-300/90">US</span>
                        <span class="text-lg font-mono leading-none">/${word.phonetic_us}/</span>
                    </div>` : ''}
                    <div class="flex justify-center gap-3">
                        <button onclick="speak('${word.english.replace(/'/g, "\\'")}', 'us')" class="px-6 py-3 rounded-2xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-all flex items-center gap-3 shadow-xl shadow-indigo-500/20 active:scale-95">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M12 8V7l-3 3H6v4h3l3 3v-1M12 8v8"/></svg>
                            <span>US Pronunciation</span>
                        </button>
                    </div>
                </div>
                <div class="prose dark:prose-invert max-w-none">
                    ${detailsHtml}
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = content;
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('hidden');
        }

        function cleanDefinitions(text) {
            if (!text) return '';
            let content = text.split('ğŸ“ ä¾‹å¥:')[0];
            content = content.split('ğŸ”— æ­é…:')[0];
            content = content.split('ğŸ’¡ çŸ­è¯­:')[0];
            
            const lines = content.split('\n');
            const cleanLines = lines.filter(line => {
                const l = line.trim();
                if (!l) return false;
                if (l.includes('ğŸ‡ºğŸ‡¸') || l.includes('ğŸ‡¬ğŸ‡§') || l.includes('us ') || l.includes('uk ') || l.includes('ç¾ ') || l.includes('è‹± ')) return false;
                if (/^\[\s*['"]/.test(l)) return false; 
                if (/^\/\s*.*?\/\s*$/.test(l)) return false;
                return true;
            });
            
            return cleanLines.join('\n');
        }

        function speak(text, type) {
            if (!window.speechSynthesis) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾');
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // å°è¯•æ›´ç²¾å‡†çš„è¯­éŸ³åŒ¹é…
            const langCode = type === 'us' ? 'en-US' : 'en-GB';
            utterance.lang = langCode;
            
            // ç¡®ä¿åŠ è½½äº†è¯­éŸ³åˆ—è¡¨ï¼ˆChromeæœ‰æ—¶éœ€è¦å¼‚æ­¥åŠ è½½ï¼‰
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                // ä¼˜å…ˆå¯»æ‰¾å®Œå…¨åŒ¹é…çš„åŒºåŸŸè¯­éŸ³
                let voice = voices.find(v => v.lang === langCode);
                // å…¶æ¬¡å¯»æ‰¾åŒ…å«è¯¥åŒºåŸŸä»£ç çš„è¯­éŸ³ (ä¾‹å¦‚ en-GB-Standard-A)
                if (!voice) voice = voices.find(v => v.lang.includes(langCode));
                // å¦‚æœæ˜¯è‹±éŸ³ä½†æ²¡æ‰¾åˆ°ï¼Œå°è¯•æ‰¾ä»»ä½•éç¾å›½çš„è‹±è¯­ï¼Œæˆ–è€…åå­—é‡Œå¸¦ UK/British çš„
                if (!voice && type === 'uk') {
                    voice = voices.find(v => v.name.includes('UK') || v.name.includes('British') || (v.lang.startsWith('en') && !v.lang.includes('US')));
                }
                
                if (voice) {
                    utterance.voice = voice;
                    // è‹±éŸ³é€šå¸¸è¯­é€Ÿç¨æ…¢ä¸€ç‚¹æ›´ä¼˜é›…
                    if (type === 'uk') utterance.rate = 0.9;
                }
            }
            
            window.speechSynthesis.speak(utterance);
        }

        // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }

        async function fetchTranslation() {
            const en = document.getElementById('new-en').value.trim();
            const zhInput = document.getElementById('new-zh');
            if (!en) return;
            
            zhInput.placeholder = 'æ­£åœ¨æ·±åº¦æ£€ç´¢æƒå¨è¯åº“...';
            try {
                // ä¼˜å…ˆå°è¯•æœ¬åœ°å¢å¼ºåç«¯
                const response = await fetch(`http://localhost:3000/api/translate?word=${encodeURIComponent(en)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // å­˜å‚¨ç»“æ„åŒ–æ•°æ®ä¾›ä¿å­˜ä½¿ç”¨
                    tempWordData = {
                        definitions: data.definitions || [],
                        examples: data.examples || [],
                        collocations: data.collocations || [],
                        idioms: data.idioms || [],
                        phonetic_us: data.phonetic_us || '',
                        phonetic_uk: data.phonetic_uk || ''
                    };
                    
                    let finalStr = '';
                    
                    // éŸ³æ ‡
                    if (data.phonetic_us || data.phonetic_uk) {
                        if (data.phonetic_us) finalStr += `ğŸ‡ºğŸ‡¸ ${data.phonetic_us}  `;
                        // if (data.phonetic_uk) finalStr += `ğŸ‡¬ğŸ‡§ ${data.phonetic_uk}`; // ç”¨æˆ·è¦æ±‚éšè—è‹±éŸ³
                        finalStr += '\n\n';
                    }
                    
                    // é‡Šä¹‰
                    if (data.definitions && data.definitions.length > 0) {
                        data.definitions.forEach(def => {
                            finalStr += `[${def.pos}] ${def.def}\n`;
                        });
                    }
                    
                    // ä¾‹å¥ (å–å‰1ä¸ª)
                    if (data.examples && data.examples.length > 0) {
                        finalStr += '\nğŸ“ ä¾‹å¥:\n';
                        data.examples.slice(0, 1).forEach(ex => {
                            finalStr += `${ex.en}\n${ex.cn}\n`;
                        });
                    }

                    // æ­é…
                    if (data.collocations && data.collocations.length > 0) {
                        finalStr += '\nğŸ”— æ­é…:\n';
                        data.collocations.slice(0, 3).forEach(c => finalStr += `${c}\n`);
                    }

                    // çŸ­è¯­
                    if (data.idioms && data.idioms.length > 0) {
                        finalStr += '\nğŸ’¡ çŸ­è¯­:\n';
                        data.idioms.slice(0, 2).forEach(i => finalStr += `${i}\n`);
                    }

                    if (finalStr.trim()) {
                        zhInput.value = finalStr.trim();
                        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                        zhInput.style.height = 'auto';
                        zhInput.style.height = (zhInput.scrollHeight) + 'px';
                        return;
                    }
                }
                
                throw new Error('Local backend returned empty or error');
            } catch (localError) {
                console.log('æœ¬åœ°åç«¯è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢è‡³å¤‡ç”¨æº:', localError);
                // é™çº§ç­–ç•¥ï¼šä½¿ç”¨åŸæœ‰ API
                try {
                    const [dictRes, transRes] = await Promise.all([
                        fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(en)}`),
                        fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(en)}&langpair=en|zh-CN`)
                    ]);
                    
                    const dictData = await dictRes.json();
                    const transData = await transRes.json();
                    
                    let results = [];
                    let phonetic = '';

                    // 1. è§£æè¯æ€§ã€éŸ³æ ‡
                    if (Array.isArray(dictData) && dictData.length > 0) {
                        const entry = dictData[0];
                        phonetic = entry.phonetic || (entry.phonetics && entry.phonetics.find(p => p.text)?.text) || '';
                        
                        entry.meanings.forEach(m => {
                            const pos = m.partOfSpeech;
                            results.push({ pos, definitions: [] });
                        });
                    }

                    // 2. è·å–ä¸­æ–‡ç¿»è¯‘
                    if (transData.responseData) {
                        const translatedText = transData.responseData.translatedText;
                        const rawItems = translatedText.split(/[ï¼›;ã€‚]/).map(t => t.trim()).filter(t => t);
                        
                        if (results.length > 0) {
                            let finalStr = phonetic ? `${phonetic}\n` : '';
                            results.forEach((res, idx) => {
                                const chunk = rawItems.slice(idx * 2, (idx + 1) * 2).join('; ');
                                if (chunk) {
                                    finalStr += `[${res.pos}] ${chunk}\n`;
                                }
                            });
                            const remaining = rawItems.slice(results.length * 2).join('; ');
                            if (remaining) {
                                finalStr += `[å…¶ä»–] ${remaining}`;
                            }
                            zhInput.value = finalStr.trim();
                        } else {
                            zhInput.value = (phonetic ? `${phonetic} ` : '') + rawItems.join('; ');
                        }
                    }
                    
                    if (zhInput.value.length < 10) {
                        zhInput.value += " (å»ºè®®æŸ¥é˜…è¯å…¸ç¡®è®¤å®Œæ•´ç”¨æ³•)";
                    }
                    
                    zhInput.style.height = 'auto';
                    zhInput.style.height = (zhInput.scrollHeight) + 'px';
                } catch (error) {
                    console.error('æ‰€æœ‰æºæŸ¥è¯¢å¤±è´¥:', error);
                    zhInput.placeholder = 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è¯¦ç»†é‡Šä¹‰';
                }
            }
        }

        function saveWords() {
            const key = getWordsStorageKey();
            localStorage.setItem(key, JSON.stringify(words));
            const countEl = document.getElementById('count');
            if (countEl) countEl.innerText = words.length;
        }

        function getWrongWords() {
            return words.filter(w => (w.wrongCount || 0) > 0).sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
        }
        
        function getDailyReviewStats() {
            const baseTarget = reviewSettings.dailyTarget || 20;
            if (!currentUser || !words || words.length === 0) {
                return { total: 0, yesterdayWrong: 0, baseTarget };
            }
            const yesterdayWrong = getYesterdayWrongWords();
            const totalCount = Math.min(words.length, baseTarget + yesterdayWrong.length);
            return { total: totalCount, yesterdayWrong: yesterdayWrong.length, baseTarget };
        }
        
        function maybeShowReviewModal() {
            if (!currentUser) return;
            if (!words || words.length === 0) return;
            const today = getTodayDateStr();
            if (reviewSettings.lastReviewDate === today) return;
            const stats = getDailyReviewStats();
            if (stats.total === 0) return;
            const modal = document.getElementById('review-modal');
            if (!modal) return;
            const totalSpan = document.getElementById('review-total-count');
            const ySpan = document.getElementById('review-yesterday-count');
            if (totalSpan) totalSpan.textContent = String(stats.total);
            if (ySpan) ySpan.textContent = String(stats.yesterdayWrong);
            modal.classList.remove('hidden');
        }

        function closeReviewModal() {
            const modal = document.getElementById('review-modal');
            if (modal) modal.classList.add('hidden');
        }

        function switchMode(mode) {
            updateQuote(); // åˆ‡æ¢é¡µé¢æ—¶æ›´æ–°é¼“åŠ±è¯­
            const container = document.getElementById('main-content');
            container.classList.remove('animate-enter');
            void container.offsetWidth; // Trigger reflow
            
            currentMode = mode;
            isPracticeMode = (mode === 'error_practice');
            render();
            
            container.classList.add('animate-enter');

            // Update Nav Styles
            document.querySelectorAll('.nav-pill').forEach(btn => {
                btn.classList.remove('nav-active');
                btn.classList.add('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-800/50', 'hover:shadow-sm');
            });
            
            // Map modes to buttons
            let activeBtnId = 'btn-list';
            if (mode === 'input') activeBtnId = 'btn-input';
            else if (mode.startsWith('test') || mode === 'error_practice') activeBtnId = 'btn-test';
            else if (mode === 'daily_review') activeBtnId = 'btn-review';
            else if (mode === 'profile') activeBtnId = 'btn-profile';
            
            const activeBtn = document.getElementById(activeBtnId);
            if (activeBtn) {
                activeBtn.classList.add('nav-active');
                activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-800/50', 'hover:shadow-sm');
            }
        }

        // --- æ¸²æŸ“å‡½æ•° ---
        function render() {
            const container = document.getElementById('main-content');
            container.innerHTML = '';
            
            if (currentMode === 'input') {
                container.innerHTML = `
                    <div class="max-w-2xl mx-auto animate-enter">
                        <div class="flex items-center gap-5 mb-12">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-blue-500 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 transform rotate-3">
                                <span class="text-2xl">âœï¸</span>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight">æ·»åŠ æ–°è¯</h2>
                                <p class="text-slate-500 dark:text-slate-400 font-medium">æ‰©å……ä½ çš„ä¸“å±è¯åº“</p>
                            </div>
                        </div>
                        <form onsubmit="handleAddWord(event)" class="space-y-8">
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider ml-1">Word to Learn</label>
                                <div class="relative group">
                                    <input type="text" id="new-en" required 
                                        class="premium-input w-full p-5 pl-6 rounded-2xl text-xl font-bold placeholder:text-slate-400 dark:placeholder:text-slate-500" 
                                        placeholder="è¾“å…¥è‹±æ–‡å•è¯..." 
                                        onblur="if(!document.getElementById('new-zh').value) fetchTranslation()">
                                    <button type="button" onclick="fetchTranslation()" 
                                        class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2 bg-indigo-50 dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 rounded-xl hover:bg-indigo-600 hover:text-white transition-all font-bold text-sm flex items-center gap-2">
                                        <span>ğŸ”</span> <span class="hidden sm:inline">æ™ºèƒ½é‡Šä¹‰</span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider ml-1">Meaning & Notes</label>
                                <textarea id="new-zh" required 
                                    class="premium-input w-full p-6 rounded-2xl min-h-[160px] text-lg font-medium leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 resize-none" 
                                    placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯è‡ªåŠ¨è·å–è¯¦ç»†é‡Šä¹‰..."></textarea>
                            </div>
                            <button type="submit" 
                                class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold py-5 rounded-2xl transition-all shadow-xl shadow-slate-900/20 hover:shadow-2xl hover:scale-[1.01] active:scale-[0.98] flex items-center justify-center gap-3 mt-4">
                                <span class="text-lg">ç¡®è®¤æ·»åŠ è‡³è¯åº“</span>
                                <span>âœ¨</span>
                            </button>
                        </form>
                    </div>
                `;
            } else if (currentMode === 'list') {
                if (words.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-24 animate-enter">
                            <div class="text-8xl mb-6 opacity-30 grayscale filter">ğŸƒ</div>
                            <p class="text-slate-500 dark:text-slate-400 text-lg font-medium">è¯åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ·»åŠ æ–°è¯å§</p>
                        </div>
                    `;
                } else {
                    const wrongWords = getWrongWords();
                    let html = `<div class="animate-enter">`;
                    
                    // Export Button
                    html += `
                        <div class="flex justify-end mb-6 animate-enter">
                            <button onclick="exportToWord()" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 hover:shadow-lg hover:shadow-indigo-500/20 transition-all flex items-center gap-2">
                                <span>ğŸ“„</span> å¯¼å‡ºå•è¯æœ¬ (Word)
                            </button>
                        </div>
                    `;
                    
                    if (wrongWords.length > 0) {
                        html += `
                            <div class="mb-10 p-8 bg-gradient-to-br from-rose-500 to-pink-600 rounded-[2rem] text-white shadow-xl shadow-rose-500/20 flex flex-col md:flex-row justify-between items-center relative overflow-hidden group hover-scale">
                                <div class="relative z-10 mb-6 md:mb-0 text-center md:text-left">
                                    <h3 class="font-bold text-2xl mb-2 flex items-center justify-center md:justify-start gap-2">
                                        <span>ğŸ”¥</span> é”™é¢˜ä¸“é¡¹å¼ºåŒ–
                                    </h3>
                                    <p class="opacity-90 font-medium text-base mb-4">å·²æœ‰ ${wrongWords.length} ä¸ªé‡ç‚¹å•è¯éœ€è¦å·©å›º</p>
                                    <button onclick="handleClearWrongRecords()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 backdrop-blur-md border border-white/20">
                                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºé”™é¢˜è®°å½•
                                    </button>
                                </div>
                                <button onclick="switchMode('error_practice')" class="relative z-10 bg-white/90 text-rose-600 px-8 py-3 rounded-xl font-bold hover:bg-white transition-all shadow-sm active:scale-95">
                                    ç«‹å³å¼€å§‹
                                </button>
                                <div class="absolute -right-12 -bottom-12 text-[12rem] opacity-10 rotate-12 group-hover:rotate-0 transition-transform duration-700">ğŸ¯</div>
                            </div>
                        `;
                    }

                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                    words.forEach((word, index) => {
                        const delay = Math.min(index * 0.05, 0.5); // Cap delay at 0.5s
                        const borderColors = ['border-l-blue-500', 'border-l-purple-500', 'border-l-pink-500', 'border-l-indigo-500', 'border-l-teal-500'];
                        const colorClass = borderColors[index % borderColors.length];
                        
                        html += `
                            <div onclick="showWordDetails(${word.id})" class="word-card bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 border-l-4 ${colorClass} shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all relative group animate-enter cursor-pointer" style="animation-delay: ${delay}s">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1 pr-8">
                                        <div class="flex items-center gap-3 mb-2 flex-wrap">
                                            <span class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">${word.english}</span>
                                            ${word.phonetic_us ? `<span class="text-sm text-slate-400 dark:text-slate-500 font-mono leading-none">/${word.phonetic_us}/</span>` : ''}
                                            <div class="flex items-center gap-1">
                                                <button onclick="event.stopPropagation(); speak('${word.english.replace(/'/g, "\\'")}', 'us')" class="p-2 rounded-xl text-indigo-500 hover:text-white hover:bg-indigo-500 dark:text-indigo-400 dark:hover:bg-indigo-500 bg-indigo-50 dark:bg-indigo-500/10 transition-all flex items-center justify-center group/btn shadow-sm" title="ç‚¹å‡»æœ—è¯» (US)">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M12 8V7l-3 3H6v4h3l3 3v-1M12 8v8"/></svg>
                                                </button>
                                            </div>
                                            ${word.wrongCount > 0 ? `<span class="px-2 py-1 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 text-[10px] font-bold rounded-lg border border-rose-100 dark:border-rose-900/30 uppercase tracking-wider">å¤ä¹  ${word.wrongCount}</span>` : ''}
                                        </div>
                                        <div class="text-slate-600 dark:text-slate-400 font-medium text-base leading-relaxed whitespace-pre-line line-clamp-2">${extractDefinition(word.chinese)}</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); handleDeleteWord(${word.id})" class="absolute top-4 right-4 p-2 text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all opacity-0 group-hover:opacity-100 translate-x-2 group-hover:translate-x-0">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>
                        <div class="mt-8">
                            <button onclick="openClearWordsModal()" class="w-full button-soft py-3 rounded-2xl bg-rose-50 dark:bg-rose-900/25 text-rose-600 dark:text-rose-200 font-bold text-sm border border-rose-100 dark:border-rose-800 flex items-center justify-center gap-2">
                                <span>ğŸ§¹</span>
                                <span>ä¸€é”®æ¸…ç©ºè¯åº“</span>
                            </button>
                        </div>
                    </div>`;
                    container.innerHTML = html;
                }
            } else if (currentMode === 'profile') {
                const name = currentUser ? (currentUser.name || currentUser.account) : 'è®¿å®¢';
                const account = currentUser ? currentUser.account : 'æœªç™»å½•';
                const wordCount = words.length;
                const stats = getDailyReviewStats();
                container.innerHTML = `
                    <div class="animate-enter max-w-2xl mx-auto">
                        <div class="mb-10 p-8 rounded-[2rem] bg-gradient-to-br from-indigo-500 via-purple-500 to-sky-500 text-white shadow-xl">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 rounded-2xl bg-white/20 flex items-center justify-center">
                                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A8 8 0 0112 14a8 8 0 016.879 3.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs uppercase tracking-[0.3em] opacity-80 font-bold">æˆ‘çš„è´¦å·</div>
                                    <div class="text-2xl font-black mt-1">${name}</div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-sm font-medium opacity-90">
                                <div>ç™»å½•è´¦å·ï¼š<span class="font-semibold">${account}</span></div>
                                <div>å½“å‰è¯åº“ï¼š<span class="font-semibold">${wordCount}</span> ä¸ªå•è¯</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="openAuthModal('login')" class="button-soft p-5 rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-indigo-500 hover:shadow-lg transition-all flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">åˆ‡æ¢è´¦å·</div>
                                    <div class="text-slate-800 dark:text-slate-100 font-semibold mt-1 text-sm">ä½¿ç”¨å¦ä¸€ç»„è´¦å·ç™»å½•</div>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-500 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                                    </svg>
                                </div>
                            </button>
                            <button onclick="handleLogout()" class="button-soft p-5 rounded-2xl bg-slate-900 text-white border border-slate-800 hover:bg-rose-600 hover:border-rose-500 hover:shadow-lg transition-all flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs font-bold uppercase tracking-widest">é€€å‡ºç™»å½•</div>
                                    <div class="text-slate-200 font-semibold mt-1 text-sm">å®‰å…¨é€€å‡ºå½“å‰è´¦å·</div>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center group-hover:bg-white group-hover:text-rose-600 transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </div>
                            </button>
                        </div>
                        <div class="mt-4 p-6 rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
                            <div class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-2">ä¿®æ”¹æ˜µç§°</div>
                            <div class="flex items-center gap-3">
                                <input id="profile-name-input" type="text" value="${name}" class="premium-input flex-1 p-3 rounded-xl text-sm font-medium" placeholder="è¾“å…¥æ–°çš„æ˜µç§°">
                                <button onclick="handleUpdateProfileName()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all">ä¿å­˜</button>
                            </div>
                        </div>
                        <div class="mt-4 p-6 rounded-2xl bg-rose-50 dark:bg-rose-900/20 border border-rose-100 dark:border-rose-800">
                            <div class="flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-widest mb-1">å±é™©æ“ä½œ</div>
                                    <div class="text-slate-700 dark:text-slate-200 text-sm font-medium">åˆ é™¤å½“å‰è´¦å·åŠå…¶æ‰€æœ‰æ•°æ®</div>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-rose-500 text-white flex items-center justify-center shadow-sm">ğŸ—‘ï¸</div>
                            </div>
                            <button onclick="openDeleteAccountModal()" class="mt-3 w-full button-soft py-3 rounded-2xl bg-rose-600 text-white font-bold text-sm hover:bg-rose-700 shadow-lg">åˆ é™¤è´¦å·</button>
                        </div>

                    </div>
                `;
            } else if (currentMode === 'daily_review') {
                const stats = getDailyReviewStats();
                container.innerHTML = `
                    <div class="animate-enter max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-6">æ¯æ—¥å¤ä¹ ä¸­å¿ƒ</h2>
                        
                        <!-- Settings Block -->
                        <div class="mb-6 p-6 rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">æ¯æ—¥å¤ä¹ è®¡åˆ’</div>
                                    <div class="text-slate-800 dark:text-slate-100 font-semibold mt-1 text-sm">æ¯å¤©å¤ä¹  <span id="review-daily-target-display">${reviewSettings.dailyTarget || 20}</span> ä¸ªå•è¯</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 mt-2">
                                <input id="review-daily-target-input" type="number" min="1" max="500" value="${reviewSettings.dailyTarget || 20}" class="premium-input w-24 p-2 rounded-xl text-sm font-medium text-center">
                                <button onclick="handleSaveReviewSettings()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all">ä¿å­˜</button>
                            </div>
                            <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">æ˜¨æ—¥åšé”™çš„å•è¯ä¼šé¢å¤–åŠ å…¥å¤ä¹ ï¼Œä¸å ç”¨æ¯æ—¥æ•°é‡ã€‚</p>
                            ${reviewSettings.lastReviewDate ? `<p class="text-xs text-slate-400 dark:text-slate-500 mt-1">ä¸Šæ¬¡å®Œæˆå¤ä¹ ï¼š${reviewSettings.lastReviewDate}</p>` : ''}
                        </div>

                        <!-- Stats & Start Block -->
                        <div class="p-6 rounded-2xl bg-gradient-to-br from-indigo-50 to-sky-50 dark:from-slate-800 dark:to-slate-900 border border-indigo-100/60 dark:border-indigo-900/40 shadow-sm hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                            <div class="flex items-center justify-between gap-4">
                                <div class="text-left">
                                    <div class="text-xs font-bold text-indigo-500 dark:text-indigo-300 uppercase tracking-widest mb-1">ä»Šæ—¥å¤ä¹ æ¦‚è§ˆ</div>
                                    <div class="text-sm text-slate-700 dark:text-slate-200 font-medium">
                                        ä»Šæ—¥éœ€å¤ä¹  <span class="font-extrabold text-indigo-600 dark:text-indigo-400 text-base">${stats.total}</span> ä¸ªï¼Œ
                                        æ˜¨æ—¥é”™é¢˜ <span class="font-extrabold text-rose-500 text-base">${stats.yesterdayWrong}</span> ä¸ª
                                    </div>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-2">ä¿æŒèŠ‚å¥ï¼Œæ¯å¤©ä¸€ç‚¹ç‚¹è¿›æ­¥ã€‚</p>
                                </div>
                                <div class="w-11 h-11 rounded-2xl bg-indigo-500 text-white flex items-center justify-center text-xl shadow-md shadow-indigo-500/40">
                                    ğŸ“†
                                </div>
                            </div>
                            <button onclick="handleStartDailyReviewFromProfile()" class="mt-4 w-full button-soft py-3 rounded-2xl bg-indigo-600 text-white font-bold text-sm flex items-center justify-center gap-2 shadow-lg shadow-indigo-500/40 hover:bg-indigo-700">
                                <span>ä¸€é”®å¼€å§‹ä»Šæ—¥å¤ä¹ </span>
                                <span class="text-base">â–¶</span>
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test_select' || currentMode === 'error_practice') {
                const targetWords = isPracticeMode ? getWrongWords() : words;
                if (targetWords.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-24 animate-enter">
                            <div class="text-8xl mb-6 opacity-50">ğŸ”­</div>
                            <p class="text-slate-500 text-xl font-medium mb-8">${isPracticeMode ? 'æš‚æ— é”™é¢˜è®°å½•' : 'è¯åº“è¿˜æ˜¯ç©ºçš„'}</p>
                            <button onclick="switchMode('input')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-xl shadow-indigo-500/20 hover:bg-indigo-700 transition-all">å»æ·»åŠ å•è¯</button>
                        </div>
                    `;
                    return;
                }

                const savedProgress = loadTestProgress();
                let resumeHtml = '';
                
                if (savedProgress && !isPracticeMode) {
                     const progressPercent = Math.round((savedProgress.currentIndex / savedProgress.testSession.length) * 100);
                     resumeHtml = `
                        <div class="mb-8 p-1">
                            <button onclick="handleResumeTest()" class="w-full p-6 rounded-2xl bg-gradient-to-r from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 border-2 border-amber-200 dark:border-amber-700/50 flex items-center justify-between group hover:shadow-lg transition-all relative overflow-hidden">
                                <div class="flex items-center gap-4 relative z-10">
                                    <div class="w-12 h-12 rounded-xl bg-amber-500 text-white flex items-center justify-center text-2xl shadow-lg shadow-amber-500/30">
                                        â¸ï¸
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold text-slate-800 dark:text-slate-100 text-lg">ç»§ç»­ä¸Šæ¬¡çš„æµ‹è¯•</div>
                                        <div class="text-slate-500 dark:text-slate-400 text-xs font-medium">è¿›åº¦: ${progressPercent}% (${savedProgress.currentIndex}/${savedProgress.testSession.length}) Â· ${savedProgress.testMode === 'en-zh' ? 'è‹±è¯‘æ±‰' : 'æ±‰è¯‘è‹±'}</div>
                                    </div>
                                </div>
                                <div class="px-4 py-2 bg-white/50 dark:bg-black/20 rounded-lg text-amber-700 dark:text-amber-400 font-bold text-sm group-hover:bg-amber-500 group-hover:text-white transition-colors">
                                    ç»§ç»­ &rarr;
                                </div>
                            </button>
                        </div>
                     `;
                }

                container.innerHTML = `
                    <div class="animate-enter text-center max-w-2xl mx-auto">
                        <div class="mb-12 relative">
                            <h2 class="text-3xl font-bold mb-3 text-slate-900 dark:text-white tracking-tight">${isPracticeMode ? 'ğŸ¯ é”™é¢˜å¼ºåŒ–' : 'ğŸ“ è®°å¿†æŒ‘æˆ˜'}</h2>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">é€‰æ‹©ä¸€ç§æ¨¡å¼å¼€å§‹æµ‹è¯•</p>
                            
                            ${getWrongWords().length > 0 ? `
                                <button onclick="handleClearWrongRecords()" class="mt-4 px-4 py-2 rounded-xl bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 text-sm font-bold hover:bg-rose-100 dark:hover:bg-rose-900/30 transition-all flex items-center gap-2 mx-auto">
                                    <span>ğŸ—‘ï¸</span> æ¸…ç©ºé”™é¢˜è®°å½•
                                </button>
                            ` : ''}
                        </div>
                        
                        ${resumeHtml}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button onclick="handleStartTest('en-zh')" class="group p-8 rounded-[2rem] bg-gradient-to-br from-white to-blue-50/50 dark:from-slate-800 dark:to-slate-900 border-2 border-slate-100 dark:border-slate-700 hover:border-blue-500 hover:shadow-xl hover:shadow-blue-500/10 transition-all text-left relative overflow-hidden flex flex-col justify-between h-64 hover-scale">
                                <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform text-blue-600">
                                    <span>Aa</span>
                                </div>
                                <div>
                                    <div class="text-xl font-bold mb-2 text-slate-800 dark:text-slate-100">è‹±è¯‘æ±‰ (é€‰æ‹©)</div>
                                    <div class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-relaxed">çœ‹ç€è‹±æ–‡å•è¯ï¼Œé€‰å‡ºæ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰ã€‚</div>
                                </div>
                            </button>
                            
                            <button onclick="handleStartTest('zh-en')" class="group p-8 rounded-[2rem] bg-gradient-to-br from-white to-purple-50/50 dark:from-slate-800 dark:to-slate-900 border-2 border-slate-100 dark:border-slate-700 hover:border-purple-500 hover:shadow-xl hover:shadow-purple-500/10 transition-all text-left relative overflow-hidden flex flex-col justify-between h-64 hover-scale">
                                <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform text-purple-600">
                                    <span>æ–‡</span>
                                </div>
                                <div>
                                    <div class="text-xl font-bold mb-2 text-slate-800 dark:text-slate-100">æ±‰è¯‘è‹± (å¡«ç©º)</div>
                                    <div class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-relaxed">çœ‹ç€ä¸­æ–‡é‡Šä¹‰ï¼Œæ‹¼å†™å‡ºæ­£ç¡®çš„è‹±æ–‡å•è¯ã€‚</div>
                                </div>
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test') {
                const word = testSession[currentIndex];
                const isEnZh = testMode === 'en-zh';
                // æ±‰è¯‘è‹±æ¨¡å¼ä¸‹ï¼Œåªæ˜¾ç¤ºæ¸…ç†åçš„é‡Šä¹‰ï¼ˆå»é™¤ä¾‹å¥ã€éŸ³æ ‡ç­‰ï¼‰
                const question = isEnZh ? word.english : extractDefinition(word.chinese);
                const subHint = isEnZh ? 'è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰' : 'æ‹¼å†™å‡ºå¯¹åº”çš„è‹±æ–‡å•è¯';
                const placeholder = isEnZh ? 'è¾“å…¥ä¸­æ–‡...' : 'Type answer...';

                // æ„å»ºæ ¸å¿ƒäº¤äº’åŒºåŸŸ HTML
                let contentArea = '';
                
                if (isEnZh) {
                    // é€‰æ‹©é¢˜æ¨¡å¼
                    if (isLoadingOptions) {
                        contentArea = `
                            <div class="py-12 flex flex-col items-center justify-center space-y-4 animate-pulse">
                                <div class="w-12 h-12 rounded-full border-4 border-indigo-200 border-t-indigo-600 animate-spin"></div>
                                <div class="text-slate-400 font-bold tracking-widest text-sm uppercase">æ­£åœ¨ç”Ÿæˆæ··æ·†é€‰é¡¹...</div>
                            </div>
                        `;
                    } else {
                        contentArea = `
                            <div class="grid grid-cols-1 gap-4">
                                ${currentOptions.map((opt, idx) => {
                                    const labels = ['A', 'B', 'C', 'D'];
                                    return `
                                    <button onclick="handleCheckAnswer('${opt.replace(/'/g, "\\'")}')" 
                                        class="group relative w-full p-5 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-500 hover:shadow-lg hover:shadow-indigo-500/10 transition-all text-left flex items-center gap-4 active:scale-[0.99]">
                                        <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-black flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                            ${labels[idx] || '?'}
                                        </div>
                                        <div class="flex-1 font-bold text-slate-700 dark:text-slate-200 text-lg line-clamp-2">
                                            ${opt}
                                        </div>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                } else {
                    // å¡«ç©ºæ¨¡å¼
                    contentArea = `
                        <div id="hint-display" class="hidden text-xl font-mono tracking-widest text-indigo-600 dark:text-indigo-400 mb-6 bg-indigo-50/50 dark:bg-indigo-900/20 py-3 rounded-xl border border-indigo-100 dark:border-indigo-900/30"></div>
                        
                        <input type="text" id="test-input" autofocus 
                            class="premium-input w-full p-6 rounded-2xl outline-none transition-all text-center text-2xl font-bold tracking-wider bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm" 
                            placeholder="${placeholder}" 
                            autocomplete="off"
                            onkeydown="if(event.key==='Enter') handleCheckAnswer(this.value)">
                        
                        <div class="flex gap-4">
                            <button onclick="handleHint()" class="flex-1 py-4 bg-white dark:bg-slate-800 rounded-xl font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all border border-slate-100 dark:border-slate-700 text-slate-500 shadow-sm text-sm">ğŸ’¡ æç¤º</button>
                            <button onclick="handleCheckAnswer(document.getElementById('test-input').value)" 
                                class="w-full flex-[2] py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/25 hover:bg-indigo-700 hover:shadow-indigo-500/40 hover:-translate-y-0.5 transition-all active:scale-[0.98] text-lg">
                                æäº¤
                            </button>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="animate-enter max-w-2xl mx-auto">
                        <div class="flex justify-between items-center mb-16">
                            <div class="h-2 flex-1 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mr-6">
                                <div class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: ${(currentIndex + 1) / testSession.length * 100}%"></div>
                            </div>
                            <button onclick="handleInterruptTest()" class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-slate-700 font-bold text-xs transition-all flex items-center gap-1">
                                <span>ğŸ’¾</span> ä¿å­˜å¹¶é€€å‡º
                            </button>
                        </div>
                        
                        <div id="test-question-area" class="text-center">
                            <div class="mb-16 relative">
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-indigo-500/10 blur-3xl rounded-full pointer-events-none"></div>
                                <p class="${isEnZh ? 'text-5xl md:text-6xl font-black text-indigo-600 dark:text-indigo-400' : 'text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100'} leading-tight whitespace-pre-line relative z-10 drop-shadow-sm">${question}</p>
                                <p class="text-slate-400 dark:text-slate-500 font-medium mt-6 text-sm tracking-widest uppercase">${subHint}</p>
                            </div>
                            
                            <div class="max-w-md mx-auto space-y-8" id="test-form-area">
                                ${contentArea}
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentMode === 'test_result') {
                const correctCount = testSession.length - wrongAttempts.length;
                const percentage = Math.round((correctCount / testSession.length) * 100);
                container.innerHTML = `
                    <div class="animate-enter text-center py-10 max-w-md mx-auto">
                        <div class="relative inline-block mb-12">
                            <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full animate-pulse"></div>
                            <div class="relative w-40 h-40 rounded-full bg-white dark:bg-slate-800 border-8 border-slate-50 dark:border-slate-700 shadow-2xl flex items-center justify-center text-7xl transform hover:scale-105 transition-transform duration-500 cursor-default">
                                ${percentage === 100 ? 'ğŸ‘‘' : (percentage >= 80 ? 'ğŸŒŸ' : (percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'))}
                            </div>
                        </div>
                        <h2 class="text-4xl font-black mb-3 text-slate-900 dark:text-white tracking-tight">æµ‹è¯•å®Œæˆ</h2>
                        <p class="text-slate-500 dark:text-slate-400 font-medium mb-12 text-lg">æœ¬æ¬¡æ­£ç¡®ç‡ <span class="text-indigo-600 dark:text-indigo-400 font-bold text-2xl ml-1">${percentage}%</span></p>
                        
                        <div class="grid grid-cols-2 gap-6 mb-12">
                            <div class="p-6 rounded-3xl bg-green-50 dark:bg-green-900/10 border border-green-100 dark:border-green-900/20 flex flex-col items-center justify-center">
                                <div class="text-green-600 dark:text-green-400 font-black text-4xl mb-1">${correctCount}</div>
                                <div class="text-green-600/60 dark:text-green-400/60 font-bold text-xs uppercase tracking-widest">Correct</div>
                            </div>
                            <div class="p-6 rounded-3xl bg-rose-50 dark:bg-rose-900/10 border border-rose-100 dark:border-rose-900/20 flex flex-col items-center justify-center">
                                <div class="text-rose-600 dark:text-rose-400 font-black text-4xl mb-1">${wrongAttempts.length}</div>
                                <div class="text-rose-600/60 dark:text-rose-400/60 font-bold text-xs uppercase tracking-widest">Wrong</div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            ${wrongAttempts.length > 0 ? `
                                <button onclick="isPracticeMode=true; handleStartTest('${testMode}')" class="w-full py-4 bg-rose-500 text-white rounded-2xl font-bold shadow-xl shadow-rose-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all">å¼ºåŒ–æœ¬è½®é”™é¢˜</button>
                            ` : ''}
                            <button onclick="switchMode('test_select')" class="w-full py-4 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-2xl font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all">å¼€å¯æ–°æµ‹è¯•</button>
                            <button onclick="switchMode('list')" class="w-full py-4 bg-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 font-bold transition-all text-sm">è¿”å›è¯åº“åˆ—è¡¨</button>
                        </div>
                    </div>
                `;
            }
        }

        function handleClearWrongRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤å•è¯ï¼Œåªä¼šé‡ç½®é”™è¯¯æ¬¡æ•°ã€‚')) {
                words = words.map(w => ({ ...w, wrongCount: 0 }));
                saveWords();
                if (isPracticeMode) {
                    switchMode('test_select');
                } else {
                    render();
                }
            }
        }

        function handleAddWord(e) {
            e.preventDefault();
            const enInput = document.getElementById('new-en');
            const zhInput = document.getElementById('new-zh');
            if (!enInput || !zhInput) return;
            const en = enInput.value.trim();
            const zh = zhInput.value.trim();
            if (!en || !zh) return;
            const enLower = en.toLowerCase();
            const exists = words.some(w => (w.english || '').trim().toLowerCase() === enLower);
            if (exists) {
                alert('è¯åº“ä¸­å·²ç»æœ‰è¿™ä¸ªå•è¯äº†ï¼Œæ— éœ€é‡å¤æ·»åŠ ');
                return;
            }
            let newWord = {
                id: Date.now(),
                english: en,
                chinese: zh,
                wrongCount: 0
            };
            if (tempWordData) {
                newWord = {
                    ...newWord,
                    definitions: tempWordData.definitions,
                    examples: tempWordData.examples,
                    collocations: tempWordData.collocations,
                    idioms: tempWordData.idioms,
                    phonetic_us: tempWordData.phonetic_us,
                    phonetic_uk: tempWordData.phonetic_uk
                };
                tempWordData = null;
            }
            words.unshift(newWord);
            saveWords();
            alert('å·²ä¿å­˜ï¼');
            enInput.value = '';
            zhInput.value = '';
            if (currentMode === 'list') render();
        }

        function handleDeleteWord(id) {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                words = words.filter(w => w.id !== id);
                saveWords();
                render();
            }
        }

        function handleStartTest(mode) {
            if (!isPracticeMode) clearTestProgress();
            const targetWords = isPracticeMode ? getWrongWords() : words;
            if (targetWords.length === 0) return;
            
            testMode = mode;
            // éšæœºåŒ–é¢˜ç›®é¡ºåº
            testSession = [...targetWords].sort(() => Math.random() - 0.5);
            currentIndex = 0;
            currentMode = 'test';
            hintLevel = 0;
            wrongAttempts = [];
            prepareQuestion();
        }
        
        function handleStartDailyReviewFromProfile() {
            const modal = document.getElementById('review-mode-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function startDailyReview(mode) {
            closeReviewModal();
            if (!words || words.length === 0) {
                alert('è¯åº“ä¸ºç©ºï¼Œæš‚æ— å¯å¤ä¹ çš„å•è¯');
                return;
            }
            const yesterdayWrong = getYesterdayWrongWords();
            const baseTarget = reviewSettings.dailyTarget || 20;
            const excludeIds = new Set(yesterdayWrong.map(w => w.id));
            const candidates = words.filter(w => !excludeIds.has(w.id));
            const shuffled = [...candidates].sort(() => Math.random() - 0.5);
            const baseSelection = shuffled.slice(0, Math.min(baseTarget, shuffled.length));
            const combined = [...yesterdayWrong, ...baseSelection];
            if (combined.length === 0) {
                alert('ç›®å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯');
                return;
            }
            const session = [...combined].sort(() => Math.random() - 0.5);
            isReviewMode = true;
            isPracticeMode = false;
            clearTestProgress();
            testMode = mode;
            testSession = session;
            currentIndex = 0;
            currentMode = 'test';
            hintLevel = 0;
            wrongAttempts = [];
            prepareQuestion();
        }

        function closeReviewModeModal() {
            const modal = document.getElementById('review-mode-modal');
            if (modal) modal.classList.add('hidden');
        }

        function handleDailyReviewModeSelect(mode) {
            closeReviewModeModal();
            startDailyReview(mode);
        }

        function openDeleteAccountModal() {
            const modal = document.getElementById('delete-account-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeleteAccountModal() {
            const modal = document.getElementById('delete-account-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmDeleteAccount() {
            if (!currentUser) {
                closeDeleteAccountModal();
                return;
            }
            const id = currentUser.id;
            users = users.filter(u => u.id !== id);
            localStorage.setItem('danci_users', JSON.stringify(users));
            setCurrentUser(null);
            words = [];
            saveWords();
            clearTestProgress();
            reviewSettings = { dailyTarget: 20, lastReviewDate: '' };
            saveReviewSettings();
            closeDeleteAccountModal();
            render();
            if (users.length === 0) {
                openAuthModal('register');
            } else {
                openAuthModal('login');
            }
        }

        function openClearWordsModal() {
            const modal = document.getElementById('clear-words-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeClearWordsModal() {
            const modal = document.getElementById('clear-words-modal');
            if (modal) modal.classList.add('hidden');
        }

        function confirmClearWords() {
            words = [];
            saveWords();
            clearTestProgress();
            closeClearWordsModal();
            render();
        }

        function handleUpdateProfileName() {
            if (!currentUser) return;
            const input = document.getElementById('profile-name-input');
            if (!input) return;
            const newName = input.value.trim();
            if (!newName) {
                alert('æ˜µç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            currentUser.name = newName;
            const idx = users.findIndex(u => u.id === currentUser.id);
            if (idx !== -1) {
                users[idx] = currentUser;
                localStorage.setItem('danci_users', JSON.stringify(users));
            }
            updateGreeting();
            render();
            alert('æ˜µç§°å·²æ›´æ–°');
        }

        function handleSaveReviewSettings() {
            const input = document.getElementById('review-daily-target-input');
            if (!input) return;
            let val = parseInt(input.value, 10);
            if (!val || val < 1) val = 10;
            if (val > 500) val = 500;
            reviewSettings.dailyTarget = val;
            saveReviewSettings();
            const display = document.getElementById('review-daily-target-display');
            if (display) display.textContent = String(val);
            alert('å·²æ›´æ–°æ¯æ—¥å¤ä¹ æ•°é‡');
        }

        function extractDefinition(text) {
            if (!text) return '';
            
            // æŒ‰è¡Œåˆ†å‰²
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                // 1. è·³è¿‡åŒ…å«æ——å¸œæˆ–éŸ³æ ‡æ ‡è®°çš„è¡Œ
                if (line.includes('ğŸ‡ºğŸ‡¸') || line.includes('ğŸ‡¬ğŸ‡§') || line.includes('us ') || line.includes('uk ') || line.includes('ç¾ ') || line.includes('è‹± ')) continue;
                
                // 2. è·³è¿‡çº¯éŸ³æ ‡è¡Œ (ä»¥ [ æˆ– / å¼€å¤´)
                // æ³¨æ„ï¼šä¸èƒ½è¯¯ä¼¤ [n.] [v.] è¿™æ ·çš„è¯æ€§æ ‡è®°
                // éŸ³æ ‡é€šå¸¸æ˜¯ ['...'] æˆ– /.../ï¼Œè€Œè¯æ€§é€šå¸¸æ˜¯ [a-z.]
                if (/^\[\s*['"]/.test(line)) continue; // ['...] å½¢å¼
                if (/^\/\s*.*?\/\s*$/.test(line)) continue; // /.../ å½¢å¼
                
                // 3. å¦‚æœåŒ…å«ä¸­æ–‡ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šæ˜¯é‡Šä¹‰è¡Œ
                if (/[\u4e00-\u9fa5]/.test(line)) {
                    return line;
                }
                
                // 4. å¦‚æœæ˜¯ä»¥ [n.] [v.] ç­‰è¯æ€§å¼€å¤´çš„ï¼Œä¹Ÿæ˜¯é‡Šä¹‰
                if (/^\[[a-z]+\.?\]/i.test(line)) {
                    return line;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å¾è¡Œï¼Œå°è¯•è¿”å›ç¬¬ä¸€ä¸ªä¸åŒ…å«éŸ³æ ‡ç‰¹å¾çš„éç©ºè¡Œ
            const cleanLines = lines.map(l => l.trim()).filter(l => l && !l.includes('ğŸ‡ºğŸ‡¸') && !l.includes('ğŸ‡¬ğŸ‡§') && !/^\/\s*.*?\/\s*$/.test(l));
            return cleanLines.length > 0 ? cleanLines[0] : text;
        }

        async function prepareQuestion() {
            if (testMode === 'en-zh') {
                isLoadingOptions = true;
                render(); // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                
                try {
                    const word = testSession[currentIndex];
                    const correctDef = extractDefinition(word.chinese);

                    // ä»åç«¯è·å–3ä¸ªæ··æ·†é¡¹
                    const res = await fetch('http://localhost:3000/api/distractors?count=3');
                    let distractors = [];
                    if (res.ok) {
                        distractors = await res.json();
                    } else {
                        // å¤‡ç”¨æ··æ·†é¡¹
                        distractors = ['[n.] è‹¹æœ; æ°´æœ', '[v.] è·‘; è¿è¡Œ', '[adj.] å¿«ä¹çš„; å¹¸ç¦çš„']; 
                    }
                    
                    // ç»„åˆå¹¶æ‰“ä¹±
                    currentOptions = [correctDef, ...distractors].sort(() => Math.random() - 0.5);
                } catch (e) {
                    console.error("Failed to prepare options", e);
                    // å¤‡ç”¨æ··æ·†é¡¹ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                    const fallbackDistractors = [
                        '[n.] è‹¹æœ; æ°´æœ; ç»“æœ', 
                        '[v.] è·‘; è¿è¡Œ; ç®¡ç†', 
                        '[adj.] å¿«ä¹çš„; å¹¸ç¦çš„; æ»¡æ„çš„',
                        '[n.] æ—¶é—´; æ—¶åˆ»; æ¬¡æ•°',
                        '[v.] æ€è€ƒ; è®¤ä¸º; æƒ³è¦'
                    ];
                    // éšæœºå–3ä¸ª
                    const shuffled = fallbackDistractors.sort(() => Math.random() - 0.5).slice(0, 3);
                    
                    const word = testSession[currentIndex];
                    const correctDef = extractDefinition(word.chinese);
                    
                    currentOptions = [correctDef, ...shuffled].sort(() => Math.random() - 0.5);
                } finally {
                    isLoadingOptions = false;
                    render();
                }
            } else {
                render();
            }
        }

        function handleCheckAnswer(userVal = null) {
            try {
                if (userVal === null || userVal === undefined) {
                    const input = document.getElementById('test-input');
                    if (!input) return;
                    userVal = input.value.trim();
                } else {
                    userVal = String(userVal).trim();
                }

                const word = testSession[currentIndex];
                if (!word) return;

                let isCorrect = false;
                if (testMode === 'en-zh') {
                    // è‹±è¯‘æ±‰ï¼ˆé€‰æ‹©é¢˜ï¼‰ï¼šç²¾ç¡®åŒ¹é…
                    const correctDef = extractDefinition(word.chinese);
                    isCorrect = (userVal === correctDef);
                } else {
                    // æ±‰è¯‘è‹±ï¼šå¿½ç•¥å¤§å°å†™
                    isCorrect = userVal.toLowerCase() === word.english.trim().toLowerCase();
                }
                
                if (!isCorrect) {
                    const originalWord = words.find(w => w.id === word.id);
                    if (originalWord) {
                        originalWord.wrongCount = (originalWord.wrongCount || 0) + 1;
                        originalWord.lastWrongAt = getTodayDateStr();
                        saveWords();
                    }
                    if (!wrongAttempts.includes(word.id)) {
                        wrongAttempts.push(word.id);
                    }
                }
                
                handleShowAnswer(isCorrect);
            } catch (err) {
                console.error("ç­”é¢˜æ ¡éªŒå‡ºé”™:", err);
                alert("ç­”é¢˜è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
            }
        }

        function handleHint() {
            const word = testSession[currentIndex];
            hintLevel++;

            // å¦‚æœæ˜¯åœ¨æ¯æ—¥å¤ä¹ çš„æ±‰è¯‘è‹±æ¨¡å¼ä¸‹ä½¿ç”¨äº†æç¤ºï¼Œè‡ªåŠ¨è®°å½•ä¸ºé”™é¢˜
            if (isReviewMode && testMode === 'zh-en') {
                const originalWord = words.find(w => w.id === word.id);
                if (originalWord) {
                    // æ ‡è®°ä¸ºä»Šæ—¥é”™è¯¯ï¼Œè¿™æ ·æ˜å¤©å¤ä¹ æ—¶ä¼šä¼˜å…ˆå‡ºç°
                    originalWord.wrongCount = (originalWord.wrongCount || 0) + 1;
                    originalWord.lastWrongAt = getTodayDateStr();
                    saveWords();
                }
                if (!wrongAttempts.includes(word.id)) {
                    wrongAttempts.push(word.id);
                }
            }

            const hintText = word.english.split('').map((char, index) => {
                if (index < hintLevel) return char;
                if (char === ' ') return ' ';
                return '_';
            }).join(' ');
            
            const hintDisplay = document.getElementById('hint-display');
            if (hintDisplay) {
                hintDisplay.innerText = hintText;
                hintDisplay.classList.remove('hidden');
            }
        }

        function handleShowAnswer(isCorrect = null) {
            const word = testSession[currentIndex];
            let answer = '';
            if (testMode === 'en-zh') {
                const cleaned = cleanDefinitions(word.chinese);
                answer = cleaned || extractDefinition(word.chinese);
            } else {
                answer = word.english;
            }
            const area = document.getElementById('test-form-area');
            const questionArea = document.getElementById('test-question-area');
            
            // è¿™é‡Œçš„åé¦ˆéœ€è¦åšå¾—æ›´â€œé«˜çº§â€
            if (isCorrect === true) {
                // æ­£ç¡®æ—¶çš„åé¦ˆ
                area.innerHTML = `
                    <div class="space-y-8 fade-in text-center">
                        <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 mb-2 border-4 border-green-100 dark:border-green-900/30">
                            <span class="text-5xl">âœ¨</span>
                        </div>
                        <div>
                            <div class="text-sm font-black text-green-600 dark:text-green-400 uppercase tracking-widest mb-2">å¤ªæ£’äº†ï¼å›ç­”æ­£ç¡®</div>
                            <div class="text-4xl font-black text-slate-800 dark:text-slate-100 whitespace-pre-line">${answer}</div>
                        </div>
                        <button onclick="handleNextWord()" class="w-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-black py-6 rounded-[2rem] shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3 group">
                            <span class="text-xl">ç»§ç»­æŒ‘æˆ˜</span>
                            <span class="group-hover:translate-x-1 transition-transform">â¡ï¸</span>
                        </button>
                    </div>
                `;
            } else {
                // é”™è¯¯æ—¶çš„åé¦ˆ
                area.innerHTML = `
                    <div class="space-y-8 fade-in">
                        <div class="p-10 bg-red-50 dark:bg-red-900/10 rounded-[2.5rem] border-2 border-red-100 dark:border-red-900/20 text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 mb-6">
                                <span class="text-2xl">ğŸ’¡</span>
                            </div>
                            <div class="text-sm font-black text-red-600 dark:text-red-400 uppercase tracking-widest mb-2">åˆ«ç°å¿ƒï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯</div>
                            <div class="text-4xl font-black text-slate-800 dark:text-slate-100 mb-4 whitespace-pre-line">${answer}</div>
                            <p class="text-red-400 font-medium">æ­¤é¢˜å·²åŠ å…¥é”™é¢˜æœ¬ï¼Œç¨åä¼šè‡ªåŠ¨å¼ºåŒ–</p>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="render()" class="flex-1 py-5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-2 border-slate-100 dark:border-slate-700 rounded-2xl font-bold hover:bg-slate-50 transition-all">å†çœ‹ä¸€çœ¼</button>
                            <button onclick="handleNextWord()" class="flex-[2] py-5 bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-black rounded-2xl shadow-xl hover:scale-[1.02] transition-all">è·³è¿‡æ­¤é¢˜</button>
                        </div>
                    </div>
                `;
            }
        }

        function handleNextWord() {
            if (currentIndex < testSession.length - 1) {
                currentIndex++;
                hintLevel = 0;
                prepareQuestion();
            } else {
                if (isReviewMode) {
                    const today = getTodayDateStr();
                    reviewSettings.lastReviewDate = today;
                    saveReviewSettings();
                    isReviewMode = false;
                }
                currentMode = 'test_result';
                clearTestProgress();
                render();
            }
        }

        // åˆå§‹åŒ–
        initAuth();
        render();
    </script>
</body>
</html>
                                                                                                                                                         
